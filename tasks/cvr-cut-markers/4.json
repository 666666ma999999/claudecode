{
  "id": "4",
  "subject": "P4: step1_pipeline.py段階9.5挿入 + セッション保存更新",
  "description": "## 変更内容\n\n`backend/services/step1_pipeline.py`を編集。\n\n### 1. 段階9.5挿入（L413の後、L414の前）\n\n段階9（parse-manuscript-structured）の後、段階10（Special komi postprocess）の前に挿入:\n\n```python\n            # ----------------------------------------------------------\n            # 9.5. Narrative Role classification + --CUT-- marker insertion\n            # ----------------------------------------------------------\n            try:\n                from ..utils.narrative_role import classify_narrative_roles, apply_cut_markers\n                subtitle_titles_for_role = [s.get(\"title\", \"\") for s in structured.get(\"subtitles\", [])]\n                if subtitle_titles_for_role:\n                    roles = await classify_narrative_roles(\n                        product_name, subtitle_titles_for_role,\n                        self._model, self._executor\n                    )\n                    if roles:\n                        structured = await apply_cut_markers(\n                            structured, roles,\n                            self._model, self._executor\n                        )\n                        logger.info(f\"段階9.5完了: 物語役割分類 + --CUT--挿入 ({len(roles)}件)\")\n                    else:\n                        logger.warning(\"段階9.5: 物語役割分類の結果が空です\")\n            except Exception as e:\n                logger.warning(f\"段階9.5スキップ（非致命的）: {e}\")\n```\n\n**重要ポイント**: \n- self._model と self._executor はstep1_pipeline.pyで既に利用可能（_ensure_imports内でセット済み）\n- エラー時はWarning + スキップ（非致命的）\n\n### 2. セッション保存更新（L450-455あたり）\n\n既存のsubtitles_for_session生成部分で、structuredからnarrative_roleを取得:\n\n```python\nsubtitles_for_session = []\nfor i, st in enumerate(subtitle_list):\n    komi_info = komi_types[i] if i < len(komi_types) else {}\n    kt = komi_info.get(\"komiType\", komi_info.get(\"komi_type\", \"komi_normal\"))\n    # structured から narrative_role を取得\n    nr = None\n    if structured.get(\"subtitles\") and i < len(structured[\"subtitles\"]):\n        nr = structured[\"subtitles\"][i].get(\"narrative_role\")\n    subtitles_for_session.append(self._SubtitleInfo(\n        order=i + 1,\n        title=st,\n        komi_type=kt,\n        mid_id=mid_id,\n        narrative_role=nr,\n    ))\n```\n\n### self._model / self._executor の確認\n\nstep1_pipeline.pyの_ensure_imports()で以下がセットされているはず:\n- self._model (Gemini model)\n- self._executor (ThreadPoolExecutor)\n\nもしセットされていない場合は、main.pyのmodel/executorのインポートが必要。Grepで確認すること。\n\n**重要**: プラン外の変更は一切禁止。上記2点のみ実装すること。他のファイルを編集しないこと。",
  "activeForm": "step1_pipeline.py統合を実装中",
  "status": "pending",
  "blocks": [],
  "blockedBy": [
    "3"
  ]
}