{
  "id": "3",
  "subject": "P3: narrative_role.py新規作成（分類+AI CUT配置+フォールバック）",
  "description": "## 変更内容\n\n`backend/utils/narrative_role.py`を新規作成。\n\n### 既存パターン参照\n`infer_komi_type_with_gemini()`（backend/routers/registration.py:1351）と同一パターンで実装。\n\n### Gemini APIの呼び方\nregistration.pyのグローバル`_model`は使わない。step1_pipeline.pyから呼ばれるので、model/fallback_model/executorを引数で受け取る。\n\n### 実装する関数\n\n#### 1. `classify_narrative_roles(product_name: str, subtitles: list, model, executor) -> list[str]`\n- `backend/prompts/NarrativeRolePrompt.md`を読み込み、テンプレート置換\n- Gemini API呼び出し（asyncio.get_event_loop().run_in_executor使用）\n- `1:hook\\n2:build\\n...`形式をパース → `[\"hook\", \"build\", ...]`を返却\n- フォールバック: 位置ベースの自動割当\n  - 先頭=hook, 末尾=climax\n  - 40%位置=pivot（1個のみ）\n  - pivot前=build, pivot後=reveal\n\n#### 2. `place_cut_markers_with_ai(subtitle_title: str, narrative_role: str, bodies: list[str], model, executor) -> list[str]`\n- `backend/prompts/CutPlacementPrompt.md`を読み込み、テンプレート置換\n- role_specific_instruction: 役割に応じた具体指示文を生成\n  - hook: \"現状の具体描写、「自分のこと」と感じる瞬間の直前でCUT\"\n  - build: \"具体的な行動・性格パターンの描写の直前でCUT\"\n  - pivot: \"転換キーワード「実は」「ここからが重要」の後の新事実の直前でCUT\"\n  - reveal: \"具体的アドバイス・時期・行動指針の直前でCUT\"\n  - climax: \"最終結果・未来像の具体的描写の直前でCUT\"\n- bodies を `==コードXX==\\n{body}` 形式で整形して渡す\n- Gemini API呼び出し → レスポンスを `==コードXX==` で分割パース\n- バリデーション: _validate_cut_position()で安全ガード検証\n- 失敗時: _insert_cut_by_formula()でフォールバック\n\n#### 3. `_validate_cut_position(body: str, N: int) -> bool`\n- --CUT--が存在するか\n- --CUT--が1つだけか\n- 最小10文字のチラ見せ確保\n- 40%超えないか\n- タグ内部でないか（--nickname1--/--nickname2--/`<br />`）\n- 第一段落内か（最初の`<br /><br />`の前）\n\n#### 4. `_insert_cut_by_formula(body: str, N: int, role: str) -> str`\n- app-config.jsonからvisibility_rulesを読み込み（または引数で受け取り）\n- N=1の場合: 30文字固定\n- N>=2の場合: `base = round(58 - 15 * ln(N))`, `teaser_chars = max(round(base * multiplier[role]), 10)`\n- ±8字以内で句点（。！？）を探してCUT配置\n- --nickname1--/--nickname2--/`<br />`内部を避ける\n\n#### 5. `apply_cut_markers(structured: dict, roles: list[str], model, executor) -> dict`\n- 全小見出し・全コードに対してplace_cut_markers_with_aiを一括適用\n- structured[\"subtitles\"][i][\"narrative_role\"] にメタデータ保存\n- エラー時: Warning + スキップ（--CUT--なしのまま）\n\n### config読み込み\n```python\nimport json\nfrom pathlib import Path\n\ndef _load_visibility_rules():\n    config_path = Path(__file__).parent.parent.parent / \"frontend\" / \"data\" / \"app-config.json\"\n    with open(config_path) as f:\n        return json.load(f).get(\"visibility_rules\", {})\n```\n\n### プロンプト読み込み\n```python\nfrom .helpers import load_prompt_file\n\ndef _load_prompt(filename):\n    prompt_dir = Path(__file__).parent.parent / \"prompts\"\n    filepath = prompt_dir / filename\n    return filepath.read_text(encoding=\"utf-8\")\n```\n\n**重要**: \n- プラン外の変更は一切禁止。narrative_role.pyの新規作成のみ。\n- 他のファイルを編集しないこと。\n- import logging, logger = logging.getLogger(__name__) を使用\n- asyncio対応: classify_narrative_rolesとplace_cut_markers_with_aiはasync defで定義",
  "activeForm": "narrative_role.pyを新規作成中",
  "status": "pending",
  "blocks": [
    "4"
  ],
  "blockedBy": [
    "1",
    "2"
  ]
}