{
  "id": "2",
  "subject": "FE: check_common.js abort handling + detect.html UI",
  "description": "Modify check_common.js and detect.html for batch abort UI.\n\n**File 1: check_common.js** (/Users/masaaki/Desktop/prm/chk/frontend/check_common.js)\n\n1a. Extract helper `_applyResultToRow(mapping, result, opts, batchBtn, index, total)` from the loop body in runBatchCheck (lines 304-356). This processes one result: updates badge, notes, checkbox, calls onCheckResult, updates button text. Takes same params currently used inline.\n\n1b. Add `_markRowsSkipped(remainingIds, rowIdMap, opts)` helper:\n```javascript\nfunction _markRowsSkipped(remainingIds, rowIdMap, opts) {\n    for (var i = 0; i < remainingIds.length; i++) {\n        var mapping = rowIdMap[remainingIds[i]];\n        if (!mapping) continue;\n        var row = mapping.row;\n        row.className = '';\n        row.classList.add('result-row-skipped');\n        var iconCell = row.querySelector('.status-icon');\n        if (iconCell) iconCell.textContent = '\\u23ED\\uFE0F';  // ⏭️\n        var badge = row.querySelector('.confidence-badge');\n        if (badge) {\n            badge.className = 'confidence-badge confidence-0';\n            badge.textContent = 'SKIP';\n        }\n    }\n}\n```\n\n1c. Modify runBatchCheck after `var data = await response.json();` (line 300):\n- After processing results loop, check `data.aborted`:\n```javascript\nif (data.aborted) {\n    // Mark remaining as skipped\n    _markRowsSkipped(data.remainingItemIds || [], rowIdMap, opts);\n    \n    // Notify abort callback\n    if (opts.onBatchAbort) {\n        opts.onBatchAbort({\n            reason: data.abortReason,\n            itemId: data.abortItemId,\n            remainingIds: data.remainingItemIds || [],\n            resume: function() {\n                _resumeBatchCheck(data.remainingItemIds || [], opts, rowIdMap);\n            }\n        });\n    }\n    \n    // Update button for resume\n    if (batchBtn) {\n        batchBtn.disabled = false;\n        var remaining = (data.remainingItemIds || []).length;\n        batchBtn.textContent = '\\u25B6 残り' + remaining + '件を再開';\n        batchBtn._resumeIds = data.remainingItemIds || [];\n    }\n    updateProgress();\n    return;\n}\n```\n\n1d. At the TOP of runBatchCheck (after opts setup, before formData check), add resume check:\n```javascript\nvar batchBtn = document.querySelector(opts.batchBtnSelector);\nif (batchBtn && batchBtn._resumeIds && batchBtn._resumeIds.length > 0) {\n    var resumeIds = batchBtn._resumeIds;\n    batchBtn._resumeIds = null;\n    await _resumeBatchCheck(resumeIds, opts);\n    return;\n}\n```\nMove the existing `var batchBtn` line (240) up to this new block, remove the duplicate.\n\n1e. Add `_resumeBatchCheck(remainingIds, opts)` function:\n```javascript\nasync function _resumeBatchCheck(remainingIds, opts) {\n    var formData = opts.getFormData();\n    var batchBtn = document.querySelector(opts.batchBtnSelector);\n    \n    // Rebuild rowIdMap for remaining items\n    var allRows = document.querySelectorAll(opts.rowSelector);\n    var rowIdMap = {};\n    for (var i = 0; i < allRows.length; i++) {\n        var row = allRows[i];\n        var id = row.dataset[opts.rowIdAttr];\n        var apiItemId = opts.mapItemId ? opts.mapItemId(id) : id;\n        if (remainingIds.indexOf(apiItemId) !== -1) {\n            rowIdMap[apiItemId] = { rowId: id, row: row };\n        }\n    }\n    \n    if (batchBtn) {\n        batchBtn.disabled = true;\n        batchBtn.textContent = '再開中... (0/' + remainingIds.length + ')';\n    }\n    \n    // Notify pre-check hook for remaining items\n    if (opts.onCheckStart) {\n        for (var k = 0; k < remainingIds.length; k++) {\n            var detectId = rowIdMap[remainingIds[k]] ? rowIdMap[remainingIds[k]].rowId : remainingIds[k];\n            opts.onCheckStart(detectId);\n        }\n    }\n    \n    try {\n        var response = await fetch('/api/check/batch', {\n            method: 'POST',\n            headers: { 'Content-Type': 'application/json' },\n            body: JSON.stringify({\n                itemIds: remainingIds,\n                ppvId: formData.ppvId,\n                siteCode: formData.siteCode,\n                releaseDate: formData.releaseDate,\n                registeredData: opts.getRegisteredData()\n            })\n        });\n        \n        if (!response.ok) {\n            throw new Error('Resume batch check failed: HTTP ' + response.status);\n        }\n        \n        var data = await response.json();\n        var results = data.results || [];\n        \n        for (var j = 0; j < results.length; j++) {\n            var result = results[j];\n            var mapping = rowIdMap[result.itemId];\n            if (!mapping) continue;\n            _applyResultToRow(mapping, result, opts, batchBtn, j, remainingIds.length);\n        }\n        \n        if (data.aborted) {\n            _markRowsSkipped(data.remainingItemIds || [], rowIdMap, opts);\n            if (opts.onBatchAbort) {\n                opts.onBatchAbort({\n                    reason: data.abortReason,\n                    itemId: data.abortItemId,\n                    remainingIds: data.remainingItemIds || [],\n                    resume: function() {\n                        _resumeBatchCheck(data.remainingItemIds || [], opts);\n                    }\n                });\n            }\n            if (batchBtn) {\n                batchBtn.disabled = false;\n                var rem = (data.remainingItemIds || []).length;\n                batchBtn.textContent = '\\u25B6 残り' + rem + '件を再開';\n                batchBtn._resumeIds = data.remainingItemIds || [];\n            }\n            updateProgress();\n            return;\n        }\n    } catch (e) {\n        console.error('Resume batch check error:', e);\n        alert('再開チェックエラー: ' + e.message);\n    }\n    \n    if (batchBtn) {\n        batchBtn.disabled = false;\n        batchBtn.textContent = '全項目一括チェック';\n        batchBtn._resumeIds = null;\n    }\n    updateProgress();\n}\n```\n\n**File 2: detect.html** (/Users/masaaki/Desktop/prm/chk/frontend/detect.html)\n\n2a. Add CSS (after `.result-row-pending` around line 256):\n```css\n.result-row-skipped { background: #f0f0f0 !important; opacity: 0.6; }\n.result-row-skipped:hover { background: #e0e0e0 !important; opacity: 0.8; }\n.batch-abort-banner {\n    display: none;\n    background: #fff5f5;\n    border: 1px solid #e74c3c;\n    border-radius: 6px;\n    padding: 8px 14px;\n    margin-top: 8px;\n    font-size: 0.85em;\n    color: #c0392b;\n    align-items: center;\n    gap: 8px;\n}\n.batch-abort-banner.show { display: flex; }\n.resume-link {\n    color: #2980b9;\n    cursor: pointer;\n    text-decoration: underline;\n    margin-left: auto;\n    white-space: nowrap;\n}\n.resume-link:hover { color: #1a5276; }\n```\n\n2b. Add HTML after progress bar section (after line 613, before the check table):\n```html\n<div class=\"batch-abort-banner\" id=\"batchAbortBanner\">\n    <span id=\"abortMessage\"></span>\n    <span class=\"resume-link\" id=\"abortResumeLink\">残りを再開</span>\n</div>\n```\n\n2c. Add `onBatchAbort` callback in the CheckCommon.initChecks config (around line 775, alongside onCheckStart and onCheckResult):\n```javascript\nonBatchAbort: function(info) {\n    var banner = document.getElementById('batchAbortBanner');\n    var msgEl = document.getElementById('abortMessage');\n    var resumeLink = document.getElementById('abortResumeLink');\n    if (banner && msgEl) {\n        msgEl.textContent = '中断: ' + (info.reason || '不明') + ' (残り' + info.remainingIds.length + '件)';\n        banner.classList.add('show');\n        if (resumeLink) {\n            resumeLink.onclick = function() {\n                banner.classList.remove('show');\n                info.resume();\n            };\n        }\n    }\n},\n```\n\n2d. In `onCheckStart` callback (line 736), add banner hide at the beginning:\n```javascript\n// At start of onCheckStart:\nvar banner = document.getElementById('batchAbortBanner');\nif (banner) banner.classList.remove('show');\n```\nBut ONLY hide the banner when a NEW batch starts (not individual item start). So actually, hide the banner only in the batch button click handler or at the beginning of runBatchCheck flow. Better approach: hide it in the first `onCheckStart` call that happens during a batch. Since the batch pre-marks all items with ⏳, the banner hide in onCheckStart is fine - it will be hidden immediately when any new check starts.\n\nIMPORTANT: Use absolute paths for all file edits.",
  "activeForm": "Implementing FE abort UI",
  "status": "pending",
  "blocks": [],
  "blockedBy": []
}