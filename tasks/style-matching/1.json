{
  "id": "1",
  "subject": "Phase 1-2: DBスキーマ + スタイルプロファイル + LLM駆動プロンプト強化",
  "description": "## Goal\nスタイルプロファイル管理基盤とLLM駆動プロンプト強化を構築する。\n\n## Phase 1: 基盤構築\n### database.py に3テーブル追加\n- `site_styles`: site_key, site_name, site_url, style_profile_json, reference_image_ids, prompt_prefix, prompt_suffix\n- `style_evaluations`: image_id, site_style_id, overall_score, color_match, mood_match, composition_match, detail_scores_json, improvement_hints\n- `style_patterns`: site_style_id, prompt_fragment, avg_score, usage_count\n- インデックス追加\n\n### services/style_profile.py (新規)\n- StyleProfile CRUD（get_all, get_by_key, create, update, delete）\n- seed_default_styles(): 3サイトの初期データ投入\n  - `izumo`: 和風×モダン、暖色系(金色/朱色/深緑)、神社・しめ縄・光芒\n  - `harura`: フェミニン、ピンク/パステル系、花・ハート・水彩風\n  - `gal`: グラマラス、紫/ピンク/ゴールド/ネオン、キラキラ・宝石・クリスタル\n\n### routers/styles.py (新規)\n- CRUD: GET /api/styles, GET /api/styles/{key}, POST /api/styles, PUT /api/styles/{key}, DELETE /api/styles/{key}\n- POST /api/styles/{key}/analyze-references: 参考画像からLLMでスタイル分析\n\n## Phase 2: LLM駆動プロンプト強化\n### services/style_prompt_enhancer.py (新規)\n- `enhance_prompt_with_style(prompt, site_style_key)`: Gemini 2.5-flashにスタイルプロファイル + 成功パターン + ユーザープロンプトを送信→スタイル適用済みプロンプト返却\n- フォールバック: LLM失敗時は `prompt_prefix + prompt + prompt_suffix` の静的結合\n\n### routers/generation.py 修正\n- `GenerateRequest`に`site_style_key: Optional[str] = None`追加\n- スタイル指定時: style_prompt_enhancer経由でプロンプト強化\n- スタイル未指定時: 既存のenhance_prompt動作維持\n\n### main.py 修正\n- `from backend.routers import styles` 追加\n- `app.include_router(styles.router)` 追加\n- startup時に `seed_default_styles()` 呼び出し\n\n## Constraints\n- 既存のprompt_enhancer.pyは変更しない（後方互換）\n- 全ファイルパスは `/Users/masaaki_nagasawa/Desktop/prm/aiimg/` 配下\n- Gemini APIモデルは `gemini-2.5-flash` を使用\n- `from google import genai` + `from google.genai import types` のパターンを使用\n\n## Verification\n- `docker compose exec makeimg pytest tests/test_database.py -v` がパス\n- `curl -H \"x-api-token: makeimg_dev_token\" http://localhost:5560/api/styles` が3サイト返却",
  "activeForm": "Building style backend (DB + profiles + LLM enhancer)",
  "owner": "style-backend",
  "status": "completed",
  "blocks": [
    "2",
    "3",
    "4"
  ],
  "blockedBy": []
}