{
  "id": "1",
  "subject": "Task 1: gemini_image.py - 参照画像指示ビルダー + プロンプト強化関数追加",
  "description": "## Goal\n`backend/services/gemini_image.py` に以下3つの変更を加える。\n\n## 1a. `_build_contents_with_references()` 関数を追加（L49の後、generate_imageの前）\n\n参照画像がある場合、画像とテキスト説明をインターリーブし、指示テンプレートを付けたcontentsリストを構築する。\n\n```python\ndef _build_contents_with_references(\n    prompt: str,\n    reference_image_paths: List[str],\n    reference_descriptions: Optional[List[str]] = None,\n    reference_instruction: Optional[str] = None,\n) -> list:\n    \"\"\"参照画像付きcontentsを構築\"\"\"\n    contents = []\n    \n    loaded_count = 0\n    for i, ref_path in enumerate(reference_image_paths[:14]):\n        ref_img = _load_reference_image(ref_path)\n        if ref_img:\n            contents.append(ref_img)\n            # 説明があれば画像の直後に付与\n            desc = \"\"\n            if reference_descriptions and i < len(reference_descriptions) and reference_descriptions[i]:\n                desc = reference_descriptions[i]\n            contents.append(f\"[参照画像{loaded_count + 1}: {desc}]\" if desc else f\"[参照画像{loaded_count + 1}]\")\n            loaded_count += 1\n    \n    if loaded_count == 0:\n        # 参照画像がロードできなかった場合はプロンプトのみ\n        return [prompt]\n    \n    # 指示テンプレート\n    instruction = reference_instruction or (\n        \"以下の参照画像のスタイル・色調・構図・雰囲気を参考にして、\"\n        \"次の指示に基づいた画像を生成してください。\\n\"\n        \"参照画像の品質レベルと芸術性を維持または向上させてください。\\n\\n\"\n        f\"指示: {prompt}\"\n    )\n    if reference_instruction:\n        # カスタムテンプレートの場合、{prompt}をユーザープロンプトで置換\n        instruction = instruction.replace(\"{prompt}\", prompt)\n    \n    contents.append(instruction)\n    return contents\n```\n\n## 1b. `_enhance_prompt()` 関数を追加\n\n```python\ndef _enhance_prompt(prompt: str, prefix: Optional[str] = None) -> str:\n    \"\"\"プロンプトに品質向上プレフィックスを追加\"\"\"\n    default_prefix = (\n        \"あなたはプロフェッショナルなアーティスト兼写真家です。\\n\"\n        \"以下の指示に基づいて、高品質で芸術的な画像を生成してください。\\n\"\n        \"細部まで精密に描写し、適切な光と影、豊かな色彩表現を心がけてください。\\n\\n\"\n    )\n    return (prefix or default_prefix) + prompt\n```\n\n## 1c. `generate_image()` のシグネチャ拡張と内部ロジック修正\n\n新パラメータ追加:\n- `reference_descriptions: Optional[List[str]] = None`\n- `reference_instruction: Optional[str] = None`\n- `enhance_prompt: bool = False`\n\ncontentsの構築ロジックを変更:\n```python\n# 旧: 参照画像を直接追加してプロンプトを付けるだけ\n# 新: _build_contents_with_references を呼び出し\nif reference_image_paths:\n    contents = _build_contents_with_references(\n        prompt=final_prompt,\n        reference_image_paths=reference_image_paths,\n        reference_descriptions=reference_descriptions,\n        reference_instruction=reference_instruction,\n    )\nelse:\n    contents = [final_prompt]\n```\n\nenhance_promptがTrueの場合:\n```python\nfinal_prompt = _enhance_prompt(prompt) if enhance_prompt else prompt\n```\n\n## Context\n- 対象ファイル: `/Users/masaaki/Desktop/prm/makeimg/backend/services/gemini_image.py`\n- 現在のコード: 137行\n- `_load_reference_image` は L39-48 に既存\n- `generate_image` は L51-128\n- コンテンツ構築は L74-85\n\n## Constraints\n- 既存の後方互換性を維持（新パラメータはすべてOptional/デフォルト値あり）\n- 既存の定数（NANO_BANANA_MODELS, ASPECT_RATIOS, IMAGE_SIZES）は変更しない\n- loggingでデバッグ情報を出す（参照画像数、プロンプト強化有無）\n\n## Verification\n変更後のファイルが Python の構文エラーを含まないこと: `python -c \"import ast; ast.parse(open('backend/services/gemini_image.py').read())\"`",
  "activeForm": "gemini_image.py を改修中",
  "owner": "worker-gemini",
  "status": "completed",
  "blocks": [
    "3"
  ],
  "blockedBy": []
}