{
  "id": "3",
  "subject": "Add enhance-prompt API endpoint",
  "description": "Edit `/Users/masaaki_nagasawa/Desktop/prm/aiimg/backend/routers/generation.py`:\n\n## Changes\n\n### 1. Add import\nAdd at top (after existing imports):\n```python\nfrom backend.services.prompt_enhancer import enhance_prompt as enhance_prompt_service\n```\n\n### 2. Add request/response models (after GenerateRequest class)\n```python\nclass EnhancePromptRequest(BaseModel):\n    prompt: str\n\nclass EnhancePromptResponse(BaseModel):\n    original: str\n    enhanced: str\n    language: str\n    subject: str\n    enhancements: list\n```\n\n### 3. Add `enhance_prompt` field to GenerateRequest\nAdd field: `enhance_prompt: bool = False`\n\n### 4. Add preview endpoint (before the generate_images function)\n```python\n@router.post(\"/enhance-prompt\")\nasync def preview_enhance_prompt(req: EnhancePromptRequest):\n    \"\"\"プロンプト補強プレビュー\"\"\"\n    result = enhance_prompt_service(req.prompt)\n    return result\n```\n\n### 5. Modify generate_images function\nIn the generate_images function, after validation and before session creation:\n- If `req.enhance_prompt` is True, call `enhance_prompt_service(req.prompt)` and use enhanced prompt for API call\n- Store enhanced_prompt in `parameters_json` dict\n- Add `enhanced_prompt` to the response dict\n\nSpecifically:\n- After line 44 (validation block), add:\n```python\n    actual_prompt = req.prompt\n    enhanced_prompt_text = None\n    if req.enhance_prompt:\n        enhancement = enhance_prompt_service(req.prompt)\n        actual_prompt = enhancement[\"enhanced\"]\n        enhanced_prompt_text = actual_prompt\n```\n- In session creation (line 69), add `\"enhanced_prompt\": enhanced_prompt_text` to the parameters_json dict\n- Replace `req.prompt` with `actual_prompt` in the gemini_image.generate_image and imagen.generate_image calls (lines 87, 92)\n- Add `\"enhanced_prompt\": enhanced_prompt_text` to the return dict (line 152-157)\n\nIMPORTANT: The `/enhance-prompt` POST endpoint MUST be defined BEFORE the `POST \"\"` endpoint to avoid route conflicts.",
  "activeForm": "Adding enhance-prompt API endpoint",
  "owner": "backend-dev",
  "status": "completed",
  "blocks": [
    "6"
  ],
  "blockedBy": [
    "1"
  ]
}