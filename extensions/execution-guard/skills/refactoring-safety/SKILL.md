---
name: refactoring-safety
description: |
  リファクタリング時の機能喪失・削除漏れを防ぐ安全ガード。
  「唯一エントリポイント削除」と「複数ファイル横断の削除不完全」を重点防止する。
  実装削除・置換・統合・不要コード整理の前後で使用。
  キーワード: リファクタリング, 削除安全性, エントリポイント, 影響範囲, 回帰防止, 完全性チェック
  単純な文言修正やUI文言変更のみの作業では使用しない。
allowed-tools: "Read Glob Grep"
license: proprietary
metadata:
  author: masaaki-nagasawa
  version: 1.0.0
  category: quality-assurance
  tags: [refactoring, safety, regression-prevention, checklist]
---

# Refactoring Safety

## このスキルの目的

以下の2つの障害パターンを再発防止する。

1. **唯一エントリポイント消失** — UIを「使われていない」と判断して削除したが、実はバックエンド機能の唯一の起動点だった
2. **複数ファイル横断の削除漏れ** — 同一概念が複数ファイルに存在し、一部のファイルからの削除が漏れて整合が崩壊

## execution-guard / refactoring-guide との関係

- `execution-guard.md` は実行統制の上位ルール。ブロッカー時は即停止・確認を優先
- `refactoring-guide` は「どう進めるか（戦略）」を定義
- **本スキルは「壊さず削るための安全ゲート」を定義**
- 実運用: `refactoring-guide` の各バッチ前後で本スキルのチェックを必須適用

## 失敗パターンの一般化

### パターンA: Hidden Single Entry Point
「使われていない」ように見える UI/CLI/ジョブが、実はバックエンド機能の唯一の起動点。

**実例**: detect.htmlの「占いIDログイン」ボタンを削除 → `/api/check/auth-capture-id` を呼ぶUIが消失 → 認証期限切れ後に自動認証不可能に

### パターンB: Distributed Concept Drift
同一概念が複数ファイルに分散しているのに、一部のみ削除されて整合が崩れる。

**実例**: `login-access`をBE(registry/playwright) + detect.htmlから削除したがcheck.htmlから削除漏れ → バッチチェックがHTTP 400で即中断

## 実行フロー（必須）

1. 削除候補の概念名を固定する（例: `login-access`, `auth-capture-id`）
2. **概念インベントリ**を作る（定義・呼び出し・UIトリガー・API・バッチ・テスト）
3. **唯一エントリポイント判定**を行う
4. **横断完全性チェック**を行う
5. 削除後の**必須機能テスト**を実行する
6. 失敗時は `execution-guard` のブロッカープロトコルで停止する

## チェックリストA: 唯一エントリポイント判定（削除前）

以下が1つでも未実施なら削除禁止。

- [ ] `rg` で概念名・同義語・旧名称を横断検索した
- [ ] バックエンドAPI/ジョブを起動する入口を列挙した
- [ ] UI要素が自動処理トリガーになっていないことを確認した
- [ ] 代替入口（新UI/CLI/自動ジョブ）が存在し、動作確認した
- [ ] 「入口の所有者」と「運用者」に削除可否を確認した（不明ならユーザーに確認）

## チェックリストB: 横断完全性チェック（削除前後）

- [ ] 概念ごとの変更対象ファイル一覧を作成した
- [ ] **全レイヤー確認**: UI / API / バッチ / レジストリ / 設定 / テスト
- [ ] 削除コミット後に再度 `rg` し、意図しない残存参照がないこと
- [ ] 逆に必要参照まで消していない（入口・フォールバック・監視）ことを確認した
- [ ] 関連エラーコード（例: 400系）を誘発する経路が残っていないこと

## 「使われていない」判定基準（厳格化）

「見た目で未使用」は禁止。以下の証跡を**2系統以上**満たすこと。

| 証跡 | 確認方法 |
|------|---------|
| 静的参照 | `rg` / 呼び出しチェーンで未到達 |
| 実行証跡 | ログ・メトリクスで一定期間未使用 |
| ドメイン確認 | 運用担当/仕様責任者の承認 |

追加ルール:
- 入口系UI（ボタン・フォーム）は「未使用」ではなく「低頻度利用」の可能性を先に疑う
- **自動復旧・期限切れ再認証・夜間バッチ起点**は高リスク扱い、削除禁止寄りに判断
- 削除する場合は**代替経路の実装とテストを同一変更で行う**（別コミットに分けない）

## 必須機能テスト（削除後）

最低限、以下を通すまで完了報告禁止。

- [ ] 平常フロー（既存の主要処理）
- [ ] **期限切れ/未認証からの復旧フロー**
- [ ] **バッチ実行フロー**（中断せず最後まで完走）
- [ ] 削除対象概念に関連するAPI呼び出し結果（4xx/5xx増加なし）

## 推奨コマンド例

```bash
# 概念と同義語をまとめて探索
rg -n "login-access|auth-capture-id|占いIDログイン" .

# 削除後の残存参照確認
rg -n "<削除概念>" --glob "*.{py,js,html,json}"

# 全レイヤーのファイルを横断確認
rg -l "<概念名>" --glob "*.{py,js,html}"
```

## ブロッカー条件（即停止）

- 唯一エントリポイントか否かを断定できない
- 変更対象ファイル一覧に自信がない
- テストで既存フローが1つでも失敗
- 削除と同時に代替経路を用意できない

## 完了条件

以下を**全て**満たしたときのみ「安全なリファクタリング完了」とする。

- [ ] 唯一エントリポイント判定を通過
- [ ] 横断完全性チェックを通過
- [ ] 必須機能テストを通過
- [ ] 変更理由・削除根拠・代替経路を記録した
