{
  "name": "chk-migration",
  "description": "rohanからchkへのチェックフローコード移行。6フェーズ並列実装。",
  "createdAt": 1770648285933,
  "leadAgentId": "team-lead@chk-migration",
  "leadSessionId": "6551c7ad-eed7-4f16-99fd-296ca31866c7",
  "members": [
    {
      "agentId": "team-lead@chk-migration",
      "name": "team-lead",
      "agentType": "team-lead",
      "model": "claude-opus-4-6",
      "joinedAt": 1770648285933,
      "tmuxPaneId": "",
      "cwd": "/Users/masaaki/Desktop/prm/chk",
      "subscriptions": []
    },
    {
      "agentId": "be-builder@chk-migration",
      "name": "be-builder",
      "agentType": "general-purpose",
      "model": "claude-opus-4-6",
      "prompt": "You are the backend builder for the chk project migration. Your job is to complete Phase 1 through Phase 4 sequentially.\n\n**IMPORTANT**: You are working in /Users/masaaki/Desktop/prm/chk/. The source code is in /Users/masaaki/Desktop/prm/rohan/backend/.\n\n## Phase 1: Project Foundation\n\nCreate the following directory structure and files:\n\n```\nchk/backend/\n├── __init__.py\n├── config.py\n├── models.py\n├── session_reader.py\n├── routers/\n│   └── __init__.py\n└── utils/\n    └── __init__.py\n```\n\n### config.py (~40 lines)\nRead /Users/masaaki/Desktop/prm/rohan/backend/utils/path_constants.py first to understand get_data_dir(). Then create a standalone version:\n- CHK_PORT = 5560\n- DATA_DIR pointing to chk/data/\n- get_data_dir() function\n- AUTH_STATE_DIR \n\n### models.py (~80 lines)\nCopy from /Users/masaaki/Desktop/prm/rohan/backend/utils/models.py ONLY these:\n- `to_camel()` function\n- `CamelCaseModel` class\n- `StepStatus` enum\n- `StepProgress` model\nNo other models needed. Adjust imports to be standalone.\n\n### session_reader.py (~180 lines)\nCopy from /Users/masaaki/Desktop/prm/rohan/backend/routers/registration_session.py:\n- Model classes: IdsInfo, SubtitleInfo, ProductInfo, YudoInfo, DistributionInfo, RegistrationRecord\n- `find_session_by_ppv_id()` function - FILE-SEARCH ONLY version (scan JSON files in data/sessions/)\n- `set_sessions_dir(path)` for dependency injection\nNo session management (save/get/record) needed - chk is read-only.\n\n### requirements.txt\n```\nfastapi>=0.100.0\nuvicorn[standard]>=0.23.0\npydantic>=2.0.0\nplaywright>=1.40.0\nopenpyxl>=3.1.0\npython-multipart>=0.0.6\n```\n\n**Phase 1 Verification**: `cd /Users/masaaki/Desktop/prm/chk/backend && python -c \"from session_reader import find_session_by_ppv_id; print('OK')\"`\n\n---\n\n## Phase 2: Utility Copy\n\nCopy these files from /Users/masaaki/Desktop/prm/rohan/backend/utils/ to chk/backend/utils/:\n\n1. **check_urls.py** - Copy as-is (no changes)\n2. **playwright_session.py** - Copy as-is (no changes)  \n3. **variable_registry.py** - Copy with 2 import fixes:\n   - Change: `from utils.models import ...` → `from models import ...`\n   - Change (TYPE_CHECKING): `from routers.registration_session import RegistrationRecord` → `from session_reader import RegistrationRecord`\n\n**Phase 2 Verification**: `cd /Users/masaaki/Desktop/prm/chk/backend && python -c \"from utils.variable_registry import extract_variables_from_session; print('OK')\"`\n\n---\n\n## Phase 3: Router Copy + Import Fixes\n\nCopy 4 router files from /Users/masaaki/Desktop/prm/rohan/backend/routers/ to chk/backend/routers/.\n\nRead each source file FIRST, then copy with these import modifications:\n\n### check.py:\n- `from utils.path_constants import get_data_dir` → `from config import get_data_dir`  \n- `from .registration_session import find_session_by_ppv_id` → `from session_reader import find_session_by_ppv_id`\n- `from .registration_session import RegistrationRecord` → `from session_reader import RegistrationRecord` (if present)\n- Any other rohan-specific imports → fix to local equivalents\n- AUTH_STATE_DIR: change to use `from config import AUTH_STATE_DIR`\n\n### check_playwright.py:\n- `from utils.browser_automation import PROXY_CONFIG` or similar → replace with `PROXY_CONFIG = None`\n- Any `from routers.` relative imports → fix to local equivalents\n- `from utils.path_constants import ...` → `from config import ...`\n\n### check_payment.py:\n- `from utils.path_constants import get_data_dir` → `from config import get_data_dir`\n- Any other rohan-specific imports → fix\n\n### detect.py:\n- `from .registration_session import find_session_by_ppv_id` → `from session_reader import find_session_by_ppv_id`\n- `from .registration_session import RegistrationRecord` → `from session_reader import RegistrationRecord`\n- variable_registry imports should already work via `from utils.variable_registry import ...`\n\n**CRITICAL**: Read EACH source file carefully before copying. Identify ALL imports that reference rohan-specific modules and fix them. Common patterns to watch for:\n- `from routers.XXX import ...` (relative router imports)\n- `from utils.path_constants import ...` (path constants)\n- `from utils.browser_automation import ...` (browser automation)\n- `from .registration_session import ...` (relative session imports)\n\n**Phase 3 Verification**: Test each router import individually.\n\n---\n\n## Phase 4: Server Construction\n\n### backend/main.py (~80 lines):\n```python\n\"\"\"CHK - Web Check Flow Server\"\"\"\nimport logging\nfrom pathlib import Path\nfrom fastapi import FastAPI\nfrom fastapi.middleware.cors import CORSMiddleware\nfrom fastapi.staticfiles import StaticFiles\n\n# Local imports\nfrom config import DATA_DIR, CHK_PORT\nimport session_reader\n\n# Configure logging\nlogging.basicConfig(level=logging.INFO)\nlogger = logging.getLogger(__name__)\n\napp = FastAPI(title=\"CHK - Web Check Flow\", version=\"1.0.0\")\n\n# CORS\napp.add_middleware(\n    CORSMiddleware,\n    allow_origins=[\"*\"],\n    allow_credentials=True,\n    allow_methods=[\"*\"],\n    allow_headers=[\"*\"],\n)\n\n# Register routers\nfrom routers import check, detect\napp.include_router(check.router)\napp.include_router(detect.router)\n\n# Configure session reader\nsessions_dir = DATA_DIR / \"sessions\"\nsession_reader.set_sessions_dir(sessions_dir)\n\n# Health check\n@app.get(\"/\")\nasync def health():\n    return {\"status\": \"ok\", \"service\": \"chk\"}\n\n# Static files (frontend)\nfrontend_dir = Path(__file__).parent.parent / \"frontend\"\nif frontend_dir.exists():\n    app.mount(\"/\", StaticFiles(directory=str(frontend_dir), html=True), name=\"frontend\")\n\nif __name__ == \"__main__\":\n    import uvicorn\n    uvicorn.run(app, host=\"0.0.0.0\", port=CHK_PORT)\n```\n\n### start_server.sh:\n```bash\n#!/bin/bash\nSCRIPT_DIR=\"$(cd \"$(dirname \"$0\")\" && pwd)\"\ncd \"$SCRIPT_DIR/backend\"\nPID_FILE=\"$SCRIPT_DIR/.server.pid\"\nLOG_FILE=\"$SCRIPT_DIR/server.log\"\n\nif [ -f \"$PID_FILE\" ] && kill -0 $(cat \"$PID_FILE\") 2>/dev/null; then\n    echo \"Server already running (PID: $(cat $PID_FILE))\"\n    exit 0\nfi\n\nnohup python -m uvicorn main:app --host 0.0.0.0 --port 5560 --reload > \"$LOG_FILE\" 2>&1 &\necho $! > \"$PID_FILE\"\necho \"CHK server started on port 5560 (PID: $!)\"\n```\n\n### stop_server.sh:\n```bash\n#!/bin/bash\nSCRIPT_DIR=\"$(cd \"$(dirname \"$0\")\" && pwd)\"\nPID_FILE=\"$SCRIPT_DIR/.server.pid\"\n\nif [ -f \"$PID_FILE\" ]; then\n    PID=$(cat \"$PID_FILE\")\n    kill $PID 2>/dev/null\n    rm \"$PID_FILE\"\n    echo \"Server stopped (PID: $PID)\"\nelse\n    echo \"No server running\"\nfi\n```\n\n**Phase 4 Verification**: \n1. `chmod +x start_server.sh stop_server.sh`\n2. `./start_server.sh`\n3. Wait 3 seconds\n4. `curl -s -o /dev/null -w \"%{http_code}\" http://localhost:5560/` should return 200\n\nAfter all phases complete, update your tasks in the task list.\n\nMark each task as in_progress before starting it and completed when done.",
      "color": "blue",
      "planModeRequired": false,
      "joinedAt": 1770648382716,
      "tmuxPaneId": "in-process",
      "cwd": "/Users/masaaki/Desktop/prm/chk",
      "subscriptions": [],
      "backendType": "in-process"
    },
    {
      "agentId": "fe-builder@chk-migration",
      "name": "fe-builder",
      "agentType": "general-purpose",
      "model": "claude-opus-4-6",
      "prompt": "You are the frontend builder for the chk project migration. Your job is to complete Phase 5.\n\n**IMPORTANT**: You are working in /Users/masaaki/Desktop/prm/chk/. The source frontend is in /Users/masaaki/Desktop/prm/rohan/frontend/.\n\n## Phase 5: Frontend Files\n\nCreate `chk/frontend/` directory and populate it.\n\n### Step 1: Copy 3 files as-is from rohan/frontend/\n1. **check.html** - Read and copy exactly as-is\n2. **detect.html** - Read and copy exactly as-is\n3. **check_common.js** - Read and copy exactly as-is\n\n### Step 2: Create config.js (shrunk version ~10 lines)\nRead /Users/masaaki/Desktop/prm/rohan/frontend/config.js first to understand the full version. Then create a minimal version with ONLY:\n- SITE_CODES mapping (e.g., {\"482\": \"izumo\"})\n- API_TOKEN (empty string, to be configured)\n- Any constants that check.html and detect.html reference from config.js\n\nCheck what check.html and detect.html actually import/reference from config.js to ensure compatibility.\n\n### Step 3: Create utils.js (~90 lines)\nRead /Users/masaaki/Desktop/prm/rohan/frontend/utils.js first. Then create a version with ONLY the functions used by detect.html:\n- `escapeHtml(str)` - with proper null/undefined/0/false handling\n- `formatValue(value)` - renders values with type detection\n- `formatValueWithTitle(title, value)` - titled value display\n- `formatVariableValue(value)` - variable value formatting\n\nCheck what detect.html and check.html actually call from utils.js.\n\n### Step 4: Create styles.css (~180 lines)\nRead /Users/masaaki/Desktop/prm/rohan/frontend/styles.css first. Then extract ONLY the styles used by check.html and detect.html:\n- Common layout (body, header, container, input-group)\n- Check table styles (check-table, check-section, section-title, checkbox-cell)\n- Detect panel styles (panel, variable-card, step-io, traceability)\n- Auth badge styles\n- Progress bar styles\n- Modal styles\n- Button styles\n- Color schemes (green for check, purple for detect)\n- Responsive/utility classes\n\n**IMPORTANT**: Make sure to include ALL styles referenced by check.html and detect.html class names. Search both HTML files for class= and id= attributes to ensure complete coverage.\n\n### Verification\nAfter creating all files, verify:\n1. All 6 files exist in chk/frontend/\n2. No syntax errors in JS files: `node -c frontend/config.js && node -c frontend/utils.js && node -c frontend/check_common.js`\n3. Check that all <script src=\"...\"> and <link href=\"...\"> references in check.html/detect.html point to files that exist\n\nMark task #5 as in_progress before starting and completed when done.",
      "color": "green",
      "planModeRequired": false,
      "joinedAt": 1770648396527,
      "tmuxPaneId": "in-process",
      "cwd": "/Users/masaaki/Desktop/prm/chk",
      "subscriptions": [],
      "backendType": "in-process"
    }
  ]
}