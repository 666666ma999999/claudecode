{
  "name": "style-matching",
  "description": "占いサイト画像生成「スタイル一致度」改善 - LLM駆動プロンプト強化 + 評価PDCAループ",
  "createdAt": 1771425044211,
  "leadAgentId": "team-lead@style-matching",
  "leadSessionId": "7b2b3dfe-160e-4fdb-ab23-62dca26559ae",
  "members": [
    {
      "agentId": "team-lead@style-matching",
      "name": "team-lead",
      "agentType": "orchestrator",
      "model": "claude-opus-4-6",
      "joinedAt": 1771425044211,
      "tmuxPaneId": "",
      "cwd": "/Users/masaaki_nagasawa/Desktop/prm/aiimg",
      "subscriptions": []
    },
    {
      "agentId": "style-tester@style-matching",
      "name": "style-tester",
      "agentType": "general-purpose",
      "model": "claude-opus-4-6",
      "prompt": "You are `style-tester`, a teammate on team `style-matching`. Your task is Phase 5: Write tests for all new style-related modules.\n\n## Working Directory\n/Users/masaaki_nagasawa/Desktop/prm/aiimg\n\n## Your Task (Task #4)\nFirst, mark task #4 as in_progress using TaskUpdate with owner \"style-tester\".\n\nBefore writing tests, READ the actual implementation files to understand what was implemented:\n1. Read backend/database.py (to see the new tables)\n2. Read backend/services/style_profile.py\n3. Read backend/services/style_prompt_enhancer.py\n4. Read backend/services/style_evaluator.py\n5. Read backend/services/reference_selector.py\n6. Read backend/routers/styles.py\n7. Read backend/routers/style_evaluation.py\n8. Read backend/routers/generation.py (to see the site_style_key changes)\n9. Read tests/test_prompt_enhancer.py (to follow existing test patterns)\n10. Read tests/test_database.py (to understand DB test setup patterns)\n\nThen implement ALL of the following test files:\n\n### 1. tests/test_style_profile.py (NEW FILE)\nTest the style_profile service:\n- Use a temporary DB (monkeypatch backend.config.DB_PATH to a tmp file, then call init_database())\n- Test seed_default_styles: after seeding, 3 styles exist\n- Test get_all_styles: returns list of dicts\n- Test get_style_by_key: izumo, harura, gal each return correct data\n- Test get_style_by_key with nonexistent key: returns None\n- Test create_style: creates and retrieves\n- Test update_style: updates fields\n- Test delete_style: removes and confirms gone\n- Test get_success_patterns: returns empty list initially\n\n### 2. tests/test_style_prompt_enhancer.py (NEW FILE)\nTest the style prompt enhancer:\n- Use monkeypatch for DB path + init_database + seed_default_styles\n- Mock the Gemini API call (unittest.mock.patch on `google.genai.Client` or the `_get_client` function)\n- Test enhance_prompt_with_style with valid style: returns enhanced prompt with method=\"llm\"\n- Test enhance_prompt_with_style with nonexistent style: returns method=\"no_style_found\"\n- Test fallback on LLM error: when mock raises, returns method=\"static_fallback\"\n- Verify response dict structure: original, enhanced, style_key, style_name, method\n\n### 3. tests/test_style_evaluator.py (NEW FILE)\nTest the style evaluator:\n- Use monkeypatch for DB path + init_database + seed_default_styles\n- Mock Gemini Vision API calls\n- Test evaluate_style_match: mocked response returns scores, saves to DB\n- Test get_style_report: returns proper structure\n- Test evaluate_batch: processes multiple images\n- Note: You'll need to create fake image entries in generated_images and generation_sessions tables for testing\n\n### 4. tests/test_reference_selector.py (NEW FILE)\nTest the reference selector:\n- Use monkeypatch for DB path + init_database + seed_default_styles\n- Test select_references_for_style: with empty reference_image_ids returns []\n- Test get_style_reference_ids: returns list\n- Test with actual reference_image_ids set in style: returns matching images\n\n### 5. tests/test_style_api.py (NEW FILE)\nIntegration tests using FastAPI TestClient:\n- Import and use TestClient from fastapi.testclient\n- Use the app from backend.main\n- Monkeypatch DB_PATH before importing app\n- Test GET /api/styles: returns list\n- Test GET /api/styles/izumo: returns style detail\n- Test GET /api/styles/nonexistent: returns 404\n- Test POST /api/styles: creates new style\n- Test PUT /api/styles/izumo: updates style\n- Test DELETE /api/styles/{key}: deletes style\n- Test GET /api/style-evaluation/report/izumo: returns report structure\n- Test GET /api/style-evaluation/patterns/izumo: returns patterns\n- All requests include header: {\"x-api-token\": \"makeimg_dev_token\"}\n\n### IMPORTANT PATTERNS\nFor DB setup in tests, use this pattern (adapted from existing test files):\n\n```python\nimport pytest\nimport tempfile\nfrom pathlib import Path\nfrom unittest.mock import patch, MagicMock, AsyncMock\n\n@pytest.fixture(autouse=True)\ndef tmp_db(monkeypatch, tmp_path):\n    \"\"\"一時DBを使用\"\"\"\n    db_path = tmp_path / \"test.db\"\n    monkeypatch.setattr(\"backend.config.DB_PATH\", db_path)\n    from backend.database import init_database\n    init_database()\n    return db_path\n```\n\nFor mocking Gemini API:\n```python\n@pytest.fixture\ndef mock_genai():\n    with patch(\"backend.services.style_prompt_enhancer._get_client\") as mock:\n        client = MagicMock()\n        mock.return_value = client\n        response = MagicMock()\n        response.text = \"Enhanced prompt text here\"\n        client.models.generate_content.return_value = response\n        yield client\n```\n\n## IMPORTANT\n- All test files must be at /Users/masaaki_nagasawa/Desktop/prm/aiimg/tests/\n- Read ALL source files before writing tests\n- Follow the existing test patterns in the project\n- Use Write tool for new files\n- When done, mark task #4 as completed via TaskUpdate\n- Send a message to \"team-lead\" when complete",
      "color": "purple",
      "planModeRequired": false,
      "joinedAt": 1771425374681,
      "tmuxPaneId": "in-process",
      "cwd": "/Users/masaaki_nagasawa/Desktop/prm/aiimg",
      "subscriptions": [],
      "backendType": "in-process"
    }
  ]
}