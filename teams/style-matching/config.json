{
  "name": "style-matching",
  "description": "占いサイト画像生成「スタイル一致度」改善 - LLM駆動プロンプト強化 + 評価PDCAループ",
  "createdAt": 1771425044211,
  "leadAgentId": "team-lead@style-matching",
  "leadSessionId": "7b2b3dfe-160e-4fdb-ab23-62dca26559ae",
  "members": [
    {
      "agentId": "team-lead@style-matching",
      "name": "team-lead",
      "agentType": "orchestrator",
      "model": "claude-opus-4-6",
      "joinedAt": 1771425044211,
      "tmuxPaneId": "",
      "cwd": "/Users/masaaki_nagasawa/Desktop/prm/aiimg",
      "subscriptions": []
    },
    {
      "agentId": "style-backend@style-matching",
      "name": "style-backend",
      "agentType": "general-purpose",
      "model": "claude-opus-4-6",
      "prompt": "You are `style-backend`, a teammate on team `style-matching`. Your task is Phase 1-2: DB schema + Style profiles + LLM-driven prompt enhancement.\n\n## Working Directory\n/Users/masaaki_nagasawa/Desktop/prm/aiimg\n\n## Your Task (Task #1)\nFirst, mark task #1 as in_progress using TaskUpdate with owner \"style-backend\".\n\nThen implement ALL of the following:\n\n### 1. backend/database.py - Add 3 new tables to SCHEMA_SQL\nAdd BEFORE the closing `\"\"\"` of SCHEMA_SQL:\n\n```sql\n-- サイトスタイル\nCREATE TABLE IF NOT EXISTS site_styles (\n    id INTEGER PRIMARY KEY AUTOINCREMENT,\n    site_key TEXT NOT NULL UNIQUE,\n    site_name TEXT NOT NULL,\n    site_url TEXT DEFAULT '',\n    style_profile_json TEXT NOT NULL,\n    reference_image_ids TEXT DEFAULT '[]',\n    prompt_prefix TEXT DEFAULT '',\n    prompt_suffix TEXT DEFAULT '',\n    created_at TEXT DEFAULT (datetime('now')),\n    updated_at TEXT DEFAULT (datetime('now'))\n);\n\n-- スタイル評価\nCREATE TABLE IF NOT EXISTS style_evaluations (\n    id INTEGER PRIMARY KEY AUTOINCREMENT,\n    image_id INTEGER NOT NULL,\n    site_style_id INTEGER NOT NULL,\n    overall_score REAL DEFAULT 0,\n    color_match REAL DEFAULT 0,\n    mood_match REAL DEFAULT 0,\n    composition_match REAL DEFAULT 0,\n    detail_scores_json TEXT DEFAULT '{}',\n    improvement_hints TEXT DEFAULT '',\n    created_at TEXT DEFAULT (datetime('now')),\n    FOREIGN KEY (image_id) REFERENCES generated_images(id),\n    FOREIGN KEY (site_style_id) REFERENCES site_styles(id)\n);\n\n-- スタイル成功パターン\nCREATE TABLE IF NOT EXISTS style_patterns (\n    id INTEGER PRIMARY KEY AUTOINCREMENT,\n    site_style_id INTEGER NOT NULL,\n    prompt_fragment TEXT NOT NULL,\n    avg_score REAL DEFAULT 0,\n    usage_count INTEGER DEFAULT 0,\n    created_at TEXT DEFAULT (datetime('now')),\n    FOREIGN KEY (site_style_id) REFERENCES site_styles(id)\n);\n\n-- スタイル関連インデックス\nCREATE INDEX IF NOT EXISTS idx_site_styles_key ON site_styles(site_key);\nCREATE INDEX IF NOT EXISTS idx_style_evaluations_image ON style_evaluations(image_id);\nCREATE INDEX IF NOT EXISTS idx_style_evaluations_style ON style_evaluations(site_style_id);\nCREATE INDEX IF NOT EXISTS idx_style_patterns_style ON style_patterns(site_style_id);\n```\n\n### 2. backend/services/style_profile.py (NEW FILE)\nCreate a complete style profile service:\n\n```python\n\"\"\"サイトスタイルプロファイル管理\"\"\"\nfrom __future__ import annotations\n\nimport json\nimport logging\nfrom typing import Dict, List, Optional\n\nfrom backend.database import get_connection, dict_from_row, dicts_from_rows\n\nlogger = logging.getLogger(__name__)\n\n# 3サイトの初期スタイルプロファイル\nDEFAULT_STYLES = [\n    {\n        \"site_key\": \"izumo\",\n        \"site_name\": \"出雲の母\",\n        \"site_url\": \"\",\n        \"style_profile_json\": json.dumps({\n            \"theme\": \"和風×モダン\",\n            \"color_palette\": [\"金色\", \"朱色\", \"深緑\", \"白\", \"墨色\"],\n            \"color_hex\": [\"#C5A032\", \"#C14545\", \"#2D6A4F\", \"#FFFFFF\", \"#1A1A2E\"],\n            \"mood\": [\"荘厳\", \"神秘的\", \"格式高い\", \"伝統的\"],\n            \"motifs\": [\"神社\", \"しめ縄\", \"光芒\", \"雲海\", \"和紋様\", \"鳥居\"],\n            \"typography\": \"筆文字・明朝体\",\n            \"composition\": \"中央配置・シンメトリー\",\n            \"texture\": \"和紙風・金箔テクスチャ\",\n        }, ensure_ascii=False),\n        \"prompt_prefix\": \"Japanese traditional shrine style, golden and vermillion colors, sacred atmosphere, \",\n        \"prompt_suffix\": \", zen aesthetic, mystical light rays, traditional Japanese patterns\",\n    },\n    {\n        \"site_key\": \"harura\",\n        \"site_name\": \"はるらすまいる\",\n        \"site_url\": \"\",\n        \"style_profile_json\": json.dumps({\n            \"theme\": \"フェミニン・癒し系\",\n            \"color_palette\": [\"ピンク\", \"ラベンダー\", \"ミントグリーン\", \"白\", \"ゴールド\"],\n            \"color_hex\": [\"#FFB6C1\", \"#E6E6FA\", \"#98FB98\", \"#FFFFFF\", \"#FFD700\"],\n            \"mood\": [\"優しい\", \"癒し\", \"ふんわり\", \"可愛い\"],\n            \"motifs\": [\"花\", \"ハート\", \"リボン\", \"蝶\", \"星\", \"水彩\"],\n            \"typography\": \"丸ゴシック・手書き風\",\n            \"composition\": \"やわらかい曲線・散りばめ配置\",\n            \"texture\": \"水彩風・パステルグラデーション\",\n        }, ensure_ascii=False),\n        \"prompt_prefix\": \"Soft feminine pastel style, pink and lavender watercolor, healing atmosphere, \",\n        \"prompt_suffix\": \", dreamy soft focus, flower petals, gentle warm lighting, kawaii aesthetic\",\n    },\n    {\n        \"site_key\": \"gal\",\n        \"site_name\": \"ギャル霊媒師\",\n        \"site_url\": \"\",\n        \"style_profile_json\": json.dumps({\n            \"theme\": \"グラマラス・ネオンスピリチュアル\",\n            \"color_palette\": [\"紫\", \"ピンク\", \"ゴールド\", \"ネオンブルー\", \"黒\"],\n            \"color_hex\": [\"#8B00FF\", \"#FF69B4\", \"#FFD700\", \"#00FFFF\", \"#0D0D0D\"],\n            \"mood\": [\"ゴージャス\", \"ミステリアス\", \"派手\", \"エッジー\"],\n            \"motifs\": [\"キラキラ\", \"宝石\", \"クリスタル\", \"月\", \"タロット\", \"ネオンサイン\"],\n            \"typography\": \"デコラティブ・ネオン風\",\n            \"composition\": \"ダイナミック・斜め構図\",\n            \"texture\": \"グリッター・ホログラフィック\",\n        }, ensure_ascii=False),\n        \"prompt_prefix\": \"Glamorous neon spiritual style, purple and pink with gold accents, \",\n        \"prompt_suffix\": \", sparkling crystals, holographic effects, dramatic neon lighting, luxurious dark background\",\n    },\n]\n\n\ndef seed_default_styles():\n    \"\"\"3サイトの初期スタイルプロファイルをDBに投入\"\"\"\n    conn = get_connection()\n    try:\n        for style in DEFAULT_STYLES:\n            existing = conn.execute(\n                \"SELECT id FROM site_styles WHERE site_key = ?\",\n                (style[\"site_key\"],)\n            ).fetchone()\n            if not existing:\n                conn.execute(\"\"\"\n                    INSERT INTO site_styles (site_key, site_name, site_url, style_profile_json, prompt_prefix, prompt_suffix)\n                    VALUES (?, ?, ?, ?, ?, ?)\n                \"\"\", (\n                    style[\"site_key\"],\n                    style[\"site_name\"],\n                    style[\"site_url\"],\n                    style[\"style_profile_json\"],\n                    style[\"prompt_prefix\"],\n                    style[\"prompt_suffix\"],\n                ))\n        conn.commit()\n        logger.info(\"デフォルトスタイルプロファイル投入完了\")\n    finally:\n        conn.close()\n\n\ndef get_all_styles() -> List[Dict]:\n    \"\"\"全スタイルを取得\"\"\"\n    conn = get_connection()\n    try:\n        rows = conn.execute(\"SELECT * FROM site_styles ORDER BY id\").fetchall()\n        return dicts_from_rows(rows)\n    finally:\n        conn.close()\n\n\ndef get_style_by_key(site_key: str) -> Optional[Dict]:\n    \"\"\"キー指定でスタイルを取得\"\"\"\n    conn = get_connection()\n    try:\n        row = conn.execute(\n            \"SELECT * FROM site_styles WHERE site_key = ?\",\n            (site_key,)\n        ).fetchone()\n        return dict_from_row(row)\n    finally:\n        conn.close()\n\n\ndef create_style(data: Dict) -> Dict:\n    \"\"\"新規スタイルを作成\"\"\"\n    conn = get_connection()\n    try:\n        cursor = conn.execute(\"\"\"\n            INSERT INTO site_styles (site_key, site_name, site_url, style_profile_json, reference_image_ids, prompt_prefix, prompt_suffix)\n            VALUES (?, ?, ?, ?, ?, ?, ?)\n        \"\"\", (\n            data[\"site_key\"],\n            data[\"site_name\"],\n            data.get(\"site_url\", \"\"),\n            data[\"style_profile_json\"] if isinstance(data.get(\"style_profile_json\"), str) else json.dumps(data.get(\"style_profile_json\", {}), ensure_ascii=False),\n            json.dumps(data.get(\"reference_image_ids\", []))  if isinstance(data.get(\"reference_image_ids\"), list) else data.get(\"reference_image_ids\", \"[]\"),\n            data.get(\"prompt_prefix\", \"\"),\n            data.get(\"prompt_suffix\", \"\"),\n        ))\n        conn.commit()\n        return get_style_by_key(data[\"site_key\"])\n    finally:\n        conn.close()\n\n\ndef update_style(site_key: str, data: Dict) -> Optional[Dict]:\n    \"\"\"スタイルを更新\"\"\"\n    conn = get_connection()\n    try:\n        fields = []\n        values = []\n        for field in [\"site_name\", \"site_url\", \"prompt_prefix\", \"prompt_suffix\"]:\n            if field in data:\n                fields.append(f\"{field} = ?\")\n                values.append(data[field])\n        if \"style_profile_json\" in data:\n            fields.append(\"style_profile_json = ?\")\n            val = data[\"style_profile_json\"]\n            values.append(val if isinstance(val, str) else json.dumps(val, ensure_ascii=False))\n        if \"reference_image_ids\" in data:\n            fields.append(\"reference_image_ids = ?\")\n            val = data[\"reference_image_ids\"]\n            values.append(json.dumps(val) if isinstance(val, list) else val)\n\n        if not fields:\n            return get_style_by_key(site_key)\n\n        fields.append(\"updated_at = datetime('now')\")\n        values.append(site_key)\n        conn.execute(\n            f\"UPDATE site_styles SET {', '.join(fields)} WHERE site_key = ?\",\n            values\n        )\n        conn.commit()\n        return get_style_by_key(site_key)\n    finally:\n        conn.close()\n\n\ndef delete_style(site_key: str) -> bool:\n    \"\"\"スタイルを削除\"\"\"\n    conn = get_connection()\n    try:\n        cursor = conn.execute(\n            \"DELETE FROM site_styles WHERE site_key = ?\",\n            (site_key,)\n        )\n        conn.commit()\n        return cursor.rowcount > 0\n    finally:\n        conn.close()\n\n\ndef get_success_patterns(site_style_id: int, limit: int = 10) -> List[Dict]:\n    \"\"\"成功パターンを取得（avg_score降順）\"\"\"\n    conn = get_connection()\n    try:\n        rows = conn.execute(\"\"\"\n            SELECT * FROM style_patterns\n            WHERE site_style_id = ? AND usage_count > 0\n            ORDER BY avg_score DESC\n            LIMIT ?\n        \"\"\", (site_style_id, limit)).fetchall()\n        return dicts_from_rows(rows)\n    finally:\n        conn.close()\n```\n\n### 3. backend/services/style_prompt_enhancer.py (NEW FILE)\n```python\n\"\"\"LLM駆動スタイル適用プロンプト強化\"\"\"\nfrom __future__ import annotations\n\nimport json\nimport logging\nfrom typing import Dict, Optional\n\nfrom google import genai\nfrom google.genai import types\n\nfrom backend.config import GEMINI_API_KEY\nfrom backend.services.style_profile import get_style_by_key, get_success_patterns\n\nlogger = logging.getLogger(__name__)\n\n\ndef _get_client() -> genai.Client:\n    \"\"\"Gemini APIクライアントを取得\"\"\"\n    return genai.Client(api_key=GEMINI_API_KEY)\n\n\nasync def enhance_prompt_with_style(prompt: str, site_style_key: str) -> Dict:\n    \"\"\"LLM駆動でスタイルを適用したプロンプトを生成\n\n    Args:\n        prompt: ユーザーの元プロンプト\n        site_style_key: サイトスタイルキー (izumo, harura, gal)\n\n    Returns:\n        {\n            \"original\": str,\n            \"enhanced\": str,\n            \"style_key\": str,\n            \"style_name\": str,\n            \"method\": \"llm\" | \"static_fallback\",\n        }\n    \"\"\"\n    style = get_style_by_key(site_style_key)\n    if not style:\n        return {\n            \"original\": prompt,\n            \"enhanced\": prompt,\n            \"style_key\": site_style_key,\n            \"style_name\": \"\",\n            \"method\": \"no_style_found\",\n        }\n\n    # 成功パターンを取得\n    success_patterns = get_success_patterns(style[\"id\"], limit=5)\n    patterns_text = \"\"\n    if success_patterns:\n        pattern_fragments = [p[\"prompt_fragment\"] for p in success_patterns]\n        patterns_text = f\"\\n\\n過去に高評価だったプロンプト要素:\\n\" + \"\\n\".join(f\"- {f}\" for f in pattern_fragments)\n\n    # LLMでプロンプト強化\n    try:\n        profile = json.loads(style[\"style_profile_json\"])\n        system_prompt = f\"\"\"あなたは画像生成プロンプトの専門家です。\nユーザーのプロンプトに対して、指定されたサイトのビジュアルスタイルを適用した画像生成プロンプトを英語で生成してください。\n\n## サイトスタイル: {style[\"site_name\"]}\n- テーマ: {profile.get(\"theme\", \"\")}\n- カラーパレット: {\", \".join(profile.get(\"color_palette\", []))}\n- ムード: {\", \".join(profile.get(\"mood\", []))}\n- モチーフ: {\", \".join(profile.get(\"motifs\", []))}\n- 構図: {profile.get(\"composition\", \"\")}\n- テクスチャ: {profile.get(\"texture\", \"\")}\n{patterns_text}\n\n## ルール\n1. ユーザーの元のプロンプトの意図を維持する\n2. スタイルの色彩・雰囲気・モチーフを自然に組み込む\n3. 英語の画像生成プロンプトとして出力する\n4. プロンプトのみ出力（説明不要）\n5. 300文字以内\"\"\"\n\n        client = _get_client()\n        response = client.models.generate_content(\n            model=\"gemini-2.5-flash\",\n            contents=f\"以下のプロンプトにスタイルを適用してください:\\n{prompt}\",\n            config=types.GenerateContentConfig(\n                system_instruction=system_prompt,\n            ),\n        )\n\n        enhanced = response.text.strip() if response.text else None\n        if enhanced:\n            return {\n                \"original\": prompt,\n                \"enhanced\": enhanced,\n                \"style_key\": site_style_key,\n                \"style_name\": style[\"site_name\"],\n                \"method\": \"llm\",\n            }\n    except Exception as e:\n        logger.warning(f\"LLMプロンプト強化失敗、フォールバック: {e}\")\n\n    # フォールバック: 静的結合\n    prefix = style.get(\"prompt_prefix\", \"\")\n    suffix = style.get(\"prompt_suffix\", \"\")\n    enhanced_static = f\"{prefix}{prompt}{suffix}\"\n    return {\n        \"original\": prompt,\n        \"enhanced\": enhanced_static,\n        \"style_key\": site_style_key,\n        \"style_name\": style[\"site_name\"],\n        \"method\": \"static_fallback\",\n    }\n```\n\n### 4. backend/routers/styles.py (NEW FILE)\n```python\n\"\"\"サイトスタイルAPI\"\"\"\nfrom __future__ import annotations\n\nimport json\nimport logging\nfrom typing import Optional\n\nfrom pydantic import BaseModel\n\nfrom fastapi import APIRouter, HTTPException\n\nfrom backend.services.style_profile import (\n    get_all_styles,\n    get_style_by_key,\n    create_style,\n    update_style,\n    delete_style,\n)\n\nlogger = logging.getLogger(__name__)\nrouter = APIRouter(prefix=\"/api/styles\", tags=[\"styles\"])\n\n\nclass StyleCreateRequest(BaseModel):\n    site_key: str\n    site_name: str\n    site_url: str = \"\"\n    style_profile_json: dict = {}\n    reference_image_ids: list = []\n    prompt_prefix: str = \"\"\n    prompt_suffix: str = \"\"\n\n\nclass StyleUpdateRequest(BaseModel):\n    site_name: Optional[str] = None\n    site_url: Optional[str] = None\n    style_profile_json: Optional[dict] = None\n    reference_image_ids: Optional[list] = None\n    prompt_prefix: Optional[str] = None\n    prompt_suffix: Optional[str] = None\n\n\n@router.get(\"\")\ndef list_styles():\n    \"\"\"全スタイル一覧\"\"\"\n    styles = get_all_styles()\n    # style_profile_jsonをパースして返す\n    for s in styles:\n        if isinstance(s.get(\"style_profile_json\"), str):\n            try:\n                s[\"style_profile\"] = json.loads(s[\"style_profile_json\"])\n            except (json.JSONDecodeError, TypeError):\n                s[\"style_profile\"] = {}\n    return {\"items\": styles}\n\n\n@router.get(\"/{site_key}\")\ndef get_style(site_key: str):\n    \"\"\"スタイル詳細\"\"\"\n    style = get_style_by_key(site_key)\n    if not style:\n        raise HTTPException(status_code=404, detail=f\"スタイル '{site_key}' が見つかりません\")\n    if isinstance(style.get(\"style_profile_json\"), str):\n        try:\n            style[\"style_profile\"] = json.loads(style[\"style_profile_json\"])\n        except (json.JSONDecodeError, TypeError):\n            style[\"style_profile\"] = {}\n    return style\n\n\n@router.post(\"\")\ndef create_new_style(req: StyleCreateRequest):\n    \"\"\"新規スタイル作成\"\"\"\n    existing = get_style_by_key(req.site_key)\n    if existing:\n        raise HTTPException(status_code=409, detail=f\"スタイル '{req.site_key}' は既に存在します\")\n    data = req.model_dump()\n    data[\"style_profile_json\"] = json.dumps(data[\"style_profile_json\"], ensure_ascii=False)\n    data[\"reference_image_ids\"] = json.dumps(data[\"reference_image_ids\"])\n    result = create_style(data)\n    return result\n\n\n@router.put(\"/{site_key}\")\ndef update_existing_style(site_key: str, req: StyleUpdateRequest):\n    \"\"\"スタイル更新\"\"\"\n    existing = get_style_by_key(site_key)\n    if not existing:\n        raise HTTPException(status_code=404, detail=f\"スタイル '{site_key}' が見つかりません\")\n    data = {k: v for k, v in req.model_dump().items() if v is not None}\n    result = update_style(site_key, data)\n    return result\n\n\n@router.delete(\"/{site_key}\")\ndef delete_existing_style(site_key: str):\n    \"\"\"スタイル削除\"\"\"\n    deleted = delete_style(site_key)\n    if not deleted:\n        raise HTTPException(status_code=404, detail=f\"スタイル '{site_key}' が見つかりません\")\n    return {\"message\": f\"スタイル '{site_key}' を削除しました\"}\n```\n\n### 5. backend/routers/generation.py - Modify GenerateRequest and generate_images\nAdd `site_style_key: Optional[str] = None` to GenerateRequest.\nAdd import for style_prompt_enhancer.\nWhen site_style_key is provided, use style_prompt_enhancer instead of regular enhancer.\nAdd BackgroundTasks support for auto-evaluation after style-guided generation.\n\nIn the GenerateRequest class, add:\n```python\nsite_style_key: Optional[str] = None\n```\n\nAdd imports at top:\n```python\nfrom fastapi import APIRouter, HTTPException, BackgroundTasks\n```\n\nModify generate_images function signature to include `background_tasks: BackgroundTasks`:\n```python\nasync def generate_images(req: GenerateRequest, background_tasks: BackgroundTasks):\n```\n\nAdd style enhancement logic BEFORE the existing enhance_prompt block:\n```python\n    style_enhanced = None\n    if req.site_style_key:\n        from backend.services.style_prompt_enhancer import enhance_prompt_with_style\n        style_result = await enhance_prompt_with_style(req.prompt, req.site_style_key)\n        actual_prompt = style_result[\"enhanced\"]\n        style_enhanced = style_result\n    elif req.enhance_prompt:\n        enhancement = enhance_prompt_service(req.prompt)\n        actual_prompt = enhancement[\"enhanced\"]\n        enhanced_prompt_text = actual_prompt\n```\n\nUpdate the return to include style info:\n```python\n    return {\n        \"session_id\": session_id,\n        \"images\": saved_images,\n        \"model\": req.model,\n        \"prompt\": req.prompt,\n        \"enhanced_prompt\": enhanced_prompt_text,\n        \"style_enhanced\": style_enhanced,\n    }\n```\n\n### 6. backend/main.py - Register styles router + seed styles\nAdd to imports:\n```python\nfrom backend.routers import images, generation, feedback, prompts, references, analytics, collection, styles\n```\n\nAdd after other include_router calls:\n```python\napp.include_router(styles.router)\n```\n\nIn the startup function, add seed:\n```python\nfrom backend.services.style_profile import seed_default_styles\nseed_default_styles()\n```\n\n## IMPORTANT\n- All file paths must be absolute under /Users/masaaki_nagasawa/Desktop/prm/aiimg/\n- Use Edit tool for existing files, Write tool for new files\n- Read each file BEFORE editing\n- Do NOT modify backend/services/prompt_enhancer.py\n- When done, mark task #1 as completed via TaskUpdate\n- Send a message to \"team-lead\" when complete",
      "color": "blue",
      "planModeRequired": false,
      "joinedAt": 1771425202650,
      "tmuxPaneId": "in-process",
      "cwd": "/Users/masaaki_nagasawa/Desktop/prm/aiimg",
      "subscriptions": [],
      "backendType": "in-process"
    }
  ]
}