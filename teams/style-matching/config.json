{
  "name": "style-matching",
  "description": "占いサイト画像生成「スタイル一致度」改善 - LLM駆動プロンプト強化 + 評価PDCAループ",
  "createdAt": 1771425044211,
  "leadAgentId": "team-lead@style-matching",
  "leadSessionId": "7b2b3dfe-160e-4fdb-ab23-62dca26559ae",
  "members": [
    {
      "agentId": "team-lead@style-matching",
      "name": "team-lead",
      "agentType": "orchestrator",
      "model": "claude-opus-4-6",
      "joinedAt": 1771425044211,
      "tmuxPaneId": "",
      "cwd": "/Users/masaaki_nagasawa/Desktop/prm/aiimg",
      "subscriptions": []
    },
    {
      "agentId": "style-backend@style-matching",
      "name": "style-backend",
      "agentType": "general-purpose",
      "model": "claude-opus-4-6",
      "prompt": "You are `style-backend`, a teammate on team `style-matching`. Your task is Phase 1-2: DB schema + Style profiles + LLM-driven prompt enhancement.\n\n## Working Directory\n/Users/masaaki_nagasawa/Desktop/prm/aiimg\n\n## Your Task (Task #1)\nFirst, mark task #1 as in_progress using TaskUpdate with owner \"style-backend\".\n\nThen implement ALL of the following:\n\n### 1. backend/database.py - Add 3 new tables to SCHEMA_SQL\nAdd BEFORE the closing `\"\"\"` of SCHEMA_SQL:\n\n```sql\n-- サイトスタイル\nCREATE TABLE IF NOT EXISTS site_styles (\n    id INTEGER PRIMARY KEY AUTOINCREMENT,\n    site_key TEXT NOT NULL UNIQUE,\n    site_name TEXT NOT NULL,\n    site_url TEXT DEFAULT '',\n    style_profile_json TEXT NOT NULL,\n    reference_image_ids TEXT DEFAULT '[]',\n    prompt_prefix TEXT DEFAULT '',\n    prompt_suffix TEXT DEFAULT '',\n    created_at TEXT DEFAULT (datetime('now')),\n    updated_at TEXT DEFAULT (datetime('now'))\n);\n\n-- スタイル評価\nCREATE TABLE IF NOT EXISTS style_evaluations (\n    id INTEGER PRIMARY KEY AUTOINCREMENT,\n    image_id INTEGER NOT NULL,\n    site_style_id INTEGER NOT NULL,\n    overall_score REAL DEFAULT 0,\n    color_match REAL DEFAULT 0,\n    mood_match REAL DEFAULT 0,\n    composition_match REAL DEFAULT 0,\n    detail_scores_json TEXT DEFAULT '{}',\n    improvement_hints TEXT DEFAULT '',\n    created_at TEXT DEFAULT (datetime('now')),\n    FOREIGN KEY (image_id) REFERENCES generated_images(id),\n    FOREIGN KEY (site_style_id) REFERENCES site_styles(id)\n);\n\n-- スタイル成功パターン\nCREATE TABLE IF NOT EXISTS style_patterns (\n    id INTEGER PRIMARY KEY AUTOINCREMENT,\n    site_style_id INTEGER NOT NULL,\n    prompt_fragment TEXT NOT NULL,\n    avg_score REAL DEFAULT 0,\n    usage_count INTEGER DEFAULT 0,\n    created_at TEXT DEFAULT (datetime('now')),\n    FOREIGN KEY (site_style_id) REFERENCES site_styles(id)\n);\n\n-- スタイル関連インデックス\nCREATE INDEX IF NOT EXISTS idx_site_styles_key ON site_styles(site_key);\nCREATE INDEX IF NOT EXISTS idx_style_evaluations_image ON style_evaluations(image_id);\nCREATE INDEX IF NOT EXISTS idx_style_evaluations_style ON style_evaluations(site_style_id);\nCREATE INDEX IF NOT EXISTS idx_style_patterns_style ON style_patterns(site_style_id);\n```\n\n### 2. backend/services/style_profile.py (NEW FILE)\nCreate a complete style profile service:\n\n```python\n\"\"\"サイトスタイルプロファイル管理\"\"\"\nfrom __future__ import annotations\n\nimport json\nimport logging\nfrom typing import Dict, List, Optional\n\nfrom backend.database import get_connection, dict_from_row, dicts_from_rows\n\nlogger = logging.getLogger(__name__)\n\n# 3サイトの初期スタイルプロファイル\nDEFAULT_STYLES = [\n    {\n        \"site_key\": \"izumo\",\n        \"site_name\": \"出雲の母\",\n        \"site_url\": \"\",\n        \"style_profile_json\": json.dumps({\n            \"theme\": \"和風×モダン\",\n            \"color_palette\": [\"金色\", \"朱色\", \"深緑\", \"白\", \"墨色\"],\n            \"color_hex\": [\"#C5A032\", \"#C14545\", \"#2D6A4F\", \"#FFFFFF\", \"#1A1A2E\"],\n            \"mood\": [\"荘厳\", \"神秘的\", \"格式高い\", \"伝統的\"],\n            \"motifs\": [\"神社\", \"しめ縄\", \"光芒\", \"雲海\", \"和紋様\", \"鳥居\"],\n            \"typography\": \"筆文字・明朝体\",\n            \"composition\": \"中央配置・シンメトリー\",\n            \"texture\": \"和紙風・金箔テクスチャ\",\n        }, ensure_ascii=False),\n        \"prompt_prefix\": \"Japanese traditional shrine style, golden and vermillion colors, sacred atmosphere, \",\n        \"prompt_suffix\": \", zen aesthetic, mystical light rays, traditional Japanese patterns\",\n    },\n    {\n        \"site_key\": \"harura\",\n        \"site_name\": \"はるらすまいる\",\n        \"site_url\": \"\",\n        \"style_profile_json\": json.dumps({\n            \"theme\": \"フェミニン・癒し系\",\n            \"color_palette\": [\"ピンク\", \"ラベンダー\", \"ミントグリーン\", \"白\", \"ゴールド\"],\n            \"color_hex\": [\"#FFB6C1\", \"#E6E6FA\", \"#98FB98\", \"#FFFFFF\", \"#FFD700\"],\n            \"mood\": [\"優しい\", \"癒し\", \"ふんわり\", \"可愛い\"],\n            \"motifs\": [\"花\", \"ハート\", \"リボン\", \"蝶\", \"星\", \"水彩\"],\n            \"typography\": \"丸ゴシック・手書き風\",\n            \"composition\": \"やわらかい曲線・散りばめ配置\",\n            \"texture\": \"水彩風・パステルグラデーション\",\n        }, ensure_ascii=False),\n        \"prompt_prefix\": \"Soft feminine pastel style, pink and lavender watercolor, healing atmosphere, \",\n        \"prompt_suffix\": \", dreamy soft focus, flower petals, gentle warm lighting, kawaii aesthetic\",\n    },\n    {\n        \"site_key\": \"gal\",\n        \"site_name\": \"ギャル霊媒師\",\n        \"site_url\": \"\",\n        \"style_profile_json\": json.dumps({\n            \"theme\": \"グラマラス・ネオンスピリチュアル\",\n            \"color_palette\": [\"紫\", \"ピンク\", \"ゴールド\", \"ネオンブルー\", \"黒\"],\n            \"color_hex\": [\"#8B00FF\", \"#FF69B4\", \"#FFD700\", \"#00FFFF\", \"#0D0D0D\"],\n            \"mood\": [\"ゴージャス\", \"ミステリアス\", \"派手\", \"エッジー\"],\n            \"motifs\": [\"キラキラ\", \"宝石\", \"クリスタル\", \"月\", \"タロット\", \"ネオンサイン\"],\n            \"typography\": \"デコラティブ・ネオン風\",\n            \"composition\": \"ダイナミック・斜め構図\",\n            \"texture\": \"グリッター・ホログラフィック\",\n        }, ensure_ascii=False),\n        \"prompt_prefix\": \"Glamorous neon spiritual style, purple and pink with gold accents, \",\n        \"prompt_suffix\": \", sparkling crystals, holographic effects, dramatic neon lighting, luxurious dark background\",\n    },\n]\n\n\ndef seed_default_styles():\n    \"\"\"3サイトの初期スタイルプロファイルをDBに投入\"\"\"\n    conn = get_connection()\n    try:\n        for style in DEFAULT_STYLES:\n            existing = conn.execute(\n                \"SELECT id FROM site_styles WHERE site_key = ?\",\n                (style[\"site_key\"],)\n            ).fetchone()\n            if not existing:\n                conn.execute(\"\"\"\n                    INSERT INTO site_styles (site_key, site_name, site_url, style_profile_json, prompt_prefix, prompt_suffix)\n                    VALUES (?, ?, ?, ?, ?, ?)\n                \"\"\", (\n                    style[\"site_key\"],\n                    style[\"site_name\"],\n                    style[\"site_url\"],\n                    style[\"style_profile_json\"],\n                    style[\"prompt_prefix\"],\n                    style[\"prompt_suffix\"],\n                ))\n        conn.commit()\n        logger.info(\"デフォルトスタイルプロファイル投入完了\")\n    finally:\n        conn.close()\n\n\ndef get_all_styles() -> List[Dict]:\n    \"\"\"全スタイルを取得\"\"\"\n    conn = get_connection()\n    try:\n        rows = conn.execute(\"SELECT * FROM site_styles ORDER BY id\").fetchall()\n        return dicts_from_rows(rows)\n    finally:\n        conn.close()\n\n\ndef get_style_by_key(site_key: str) -> Optional[Dict]:\n    \"\"\"キー指定でスタイルを取得\"\"\"\n    conn = get_connection()\n    try:\n        row = conn.execute(\n            \"SELECT * FROM site_styles WHERE site_key = ?\",\n            (site_key,)\n        ).fetchone()\n        return dict_from_row(row)\n    finally:\n        conn.close()\n\n\ndef create_style(data: Dict) -> Dict:\n    \"\"\"新規スタイルを作成\"\"\"\n    conn = get_connection()\n    try:\n        cursor = conn.execute(\"\"\"\n            INSERT INTO site_styles (site_key, site_name, site_url, style_profile_json, reference_image_ids, prompt_prefix, prompt_suffix)\n            VALUES (?, ?, ?, ?, ?, ?, ?)\n        \"\"\", (\n            data[\"site_key\"],\n            data[\"site_name\"],\n            data.get(\"site_url\", \"\"),\n            data[\"style_profile_json\"] if isinstance(data.get(\"style_profile_json\"), str) else json.dumps(data.get(\"style_profile_json\", {}), ensure_ascii=False),\n            json.dumps(data.get(\"reference_image_ids\", []))  if isinstance(data.get(\"reference_image_ids\"), list) else data.get(\"reference_image_ids\", \"[]\"),\n            data.get(\"prompt_prefix\", \"\"),\n            data.get(\"prompt_suffix\", \"\"),\n        ))\n        conn.commit()\n        return get_style_by_key(data[\"site_key\"])\n    finally:\n        conn.close()\n\n\ndef update_style(site_key: str, data: Dict) -> Optional[Dict]:\n    \"\"\"スタイルを更新\"\"\"\n    conn = get_connection()\n    try:\n        fields = []\n        values = []\n        for field in [\"site_name\", \"site_url\", \"prompt_prefix\", \"prompt_suffix\"]:\n            if field in data:\n                fields.append(f\"{field} = ?\")\n                values.append(data[field])\n        if \"style_profile_json\" in data:\n            fields.append(\"style_profile_json = ?\")\n            val = data[\"style_profile_json\"]\n            values.append(val if isinstance(val, str) else json.dumps(val, ensure_ascii=False))\n        if \"reference_image_ids\" in data:\n            fields.append(\"reference_image_ids = ?\")\n            val = data[\"reference_image_ids\"]\n            values.append(json.dumps(val) if isinstance(val, list) else val)\n\n        if not fields:\n            return get_style_by_key(site_key)\n\n        fields.append(\"updated_at = datetime('now')\")\n        values.append(site_key)\n        conn.execute(\n            f\"UPDATE site_styles SET {', '.join(fields)} WHERE site_key = ?\",\n            values\n        )\n        conn.commit()\n        return get_style_by_key(site_key)\n    finally:\n        conn.close()\n\n\ndef delete_style(site_key: str) -> bool:\n    \"\"\"スタイルを削除\"\"\"\n    conn = get_connection()\n    try:\n        cursor = conn.execute(\n            \"DELETE FROM site_styles WHERE site_key = ?\",\n            (site_key,)\n        )\n        conn.commit()\n        return cursor.rowcount > 0\n    finally:\n        conn.close()\n\n\ndef get_success_patterns(site_style_id: int, limit: int = 10) -> List[Dict]:\n    \"\"\"成功パターンを取得（avg_score降順）\"\"\"\n    conn = get_connection()\n    try:\n        rows = conn.execute(\"\"\"\n            SELECT * FROM style_patterns\n            WHERE site_style_id = ? AND usage_count > 0\n            ORDER BY avg_score DESC\n            LIMIT ?\n        \"\"\", (site_style_id, limit)).fetchall()\n        return dicts_from_rows(rows)\n    finally:\n        conn.close()\n```\n\n### 3. backend/services/style_prompt_enhancer.py (NEW FILE)\n```python\n\"\"\"LLM駆動スタイル適用プロンプト強化\"\"\"\nfrom __future__ import annotations\n\nimport json\nimport logging\nfrom typing import Dict, Optional\n\nfrom google import genai\nfrom google.genai import types\n\nfrom backend.config import GEMINI_API_KEY\nfrom backend.services.style_profile import get_style_by_key, get_success_patterns\n\nlogger = logging.getLogger(__name__)\n\n\ndef _get_client() -> genai.Client:\n    \"\"\"Gemini APIクライアントを取得\"\"\"\n    return genai.Client(api_key=GEMINI_API_KEY)\n\n\nasync def enhance_prompt_with_style(prompt: str, site_style_key: str) -> Dict:\n    \"\"\"LLM駆動でスタイルを適用したプロンプトを生成\n\n    Args:\n        prompt: ユーザーの元プロンプト\n        site_style_key: サイトスタイルキー (izumo, harura, gal)\n\n    Returns:\n        {\n            \"original\": str,\n            \"enhanced\": str,\n            \"style_key\": str,\n            \"style_name\": str,\n            \"method\": \"llm\" | \"static_fallback\",\n        }\n    \"\"\"\n    style = get_style_by_key(site_style_key)\n    if not style:\n        return {\n            \"original\": prompt,\n            \"enhanced\": prompt,\n            \"style_key\": site_style_key,\n            \"style_name\": \"\",\n            \"method\": \"no_style_found\",\n        }\n\n    # 成功パターンを取得\n    success_patterns = get_success_patterns(style[\"id\"], limit=5)\n    patterns_text = \"\"\n    if success_patterns:\n        pattern_fragments = [p[\"prompt_fragment\"] for p in success_patterns]\n        patterns_text = f\"\\n\\n過去に高評価だったプロンプト要素:\\n\" + \"\\n\".join(f\"- {f}\" for f in pattern_fragments)\n\n    # LLMでプロンプト強化\n    try:\n        profile = json.loads(style[\"style_profile_json\"])\n        system_prompt = f\"\"\"あなたは画像生成プロンプトの専門家です。\nユーザーのプロンプトに対して、指定されたサイトのビジュアルスタイルを適用した画像生成プロンプトを英語で生成してください。\n\n## サイトスタイル: {style[\"site_name\"]}\n- テーマ: {profile.get(\"theme\", \"\")}\n- カラーパレット: {\", \".join(profile.get(\"color_palette\", []))}\n- ムード: {\", \".join(profile.get(\"mood\", []))}\n- モチーフ: {\", \".join(profile.get(\"motifs\", []))}\n- 構図: {profile.get(\"composition\", \"\")}\n- テクスチャ: {profile.get(\"texture\", \"\")}\n{patterns_text}\n\n## ルール\n1. ユーザーの元のプロンプトの意図を維持する\n2. スタイルの色彩・雰囲気・モチーフを自然に組み込む\n3. 英語の画像生成プロンプトとして出力する\n4. プロンプトのみ出力（説明不要）\n5. 300文字以内\"\"\"\n\n        client = _get_client()\n        response = client.models.generate_content(\n            model=\"gemini-2.5-flash\",\n            contents=f\"以下のプロンプトにスタイルを適用してください:\\n{prompt}\",\n            config=types.GenerateContentConfig(\n                system_instruction=system_prompt,\n            ),\n        )\n\n        enhanced = response.text.strip() if response.text else None\n        if enhanced:\n            return {\n                \"original\": prompt,\n                \"enhanced\": enhanced,\n                \"style_key\": site_style_key,\n                \"style_name\": style[\"site_name\"],\n                \"method\": \"llm\",\n            }\n    except Exception as e:\n        logger.warning(f\"LLMプロンプト強化失敗、フォールバック: {e}\")\n\n    # フォールバック: 静的結合\n    prefix = style.get(\"prompt_prefix\", \"\")\n    suffix = style.get(\"prompt_suffix\", \"\")\n    enhanced_static = f\"{prefix}{prompt}{suffix}\"\n    return {\n        \"original\": prompt,\n        \"enhanced\": enhanced_static,\n        \"style_key\": site_style_key,\n        \"style_name\": style[\"site_name\"],\n        \"method\": \"static_fallback\",\n    }\n```\n\n### 4. backend/routers/styles.py (NEW FILE)\n```python\n\"\"\"サイトスタイルAPI\"\"\"\nfrom __future__ import annotations\n\nimport json\nimport logging\nfrom typing import Optional\n\nfrom pydantic import BaseModel\n\nfrom fastapi import APIRouter, HTTPException\n\nfrom backend.services.style_profile import (\n    get_all_styles,\n    get_style_by_key,\n    create_style,\n    update_style,\n    delete_style,\n)\n\nlogger = logging.getLogger(__name__)\nrouter = APIRouter(prefix=\"/api/styles\", tags=[\"styles\"])\n\n\nclass StyleCreateRequest(BaseModel):\n    site_key: str\n    site_name: str\n    site_url: str = \"\"\n    style_profile_json: dict = {}\n    reference_image_ids: list = []\n    prompt_prefix: str = \"\"\n    prompt_suffix: str = \"\"\n\n\nclass StyleUpdateRequest(BaseModel):\n    site_name: Optional[str] = None\n    site_url: Optional[str] = None\n    style_profile_json: Optional[dict] = None\n    reference_image_ids: Optional[list] = None\n    prompt_prefix: Optional[str] = None\n    prompt_suffix: Optional[str] = None\n\n\n@router.get(\"\")\ndef list_styles():\n    \"\"\"全スタイル一覧\"\"\"\n    styles = get_all_styles()\n    # style_profile_jsonをパースして返す\n    for s in styles:\n        if isinstance(s.get(\"style_profile_json\"), str):\n            try:\n                s[\"style_profile\"] = json.loads(s[\"style_profile_json\"])\n            except (json.JSONDecodeError, TypeError):\n                s[\"style_profile\"] = {}\n    return {\"items\": styles}\n\n\n@router.get(\"/{site_key}\")\ndef get_style(site_key: str):\n    \"\"\"スタイル詳細\"\"\"\n    style = get_style_by_key(site_key)\n    if not style:\n        raise HTTPException(status_code=404, detail=f\"スタイル '{site_key}' が見つかりません\")\n    if isinstance(style.get(\"style_profile_json\"), str):\n        try:\n            style[\"style_profile\"] = json.loads(style[\"style_profile_json\"])\n        except (json.JSONDecodeError, TypeError):\n            style[\"style_profile\"] = {}\n    return style\n\n\n@router.post(\"\")\ndef create_new_style(req: StyleCreateRequest):\n    \"\"\"新規スタイル作成\"\"\"\n    existing = get_style_by_key(req.site_key)\n    if existing:\n        raise HTTPException(status_code=409, detail=f\"スタイル '{req.site_key}' は既に存在します\")\n    data = req.model_dump()\n    data[\"style_profile_json\"] = json.dumps(data[\"style_profile_json\"], ensure_ascii=False)\n    data[\"reference_image_ids\"] = json.dumps(data[\"reference_image_ids\"])\n    result = create_style(data)\n    return result\n\n\n@router.put(\"/{site_key}\")\ndef update_existing_style(site_key: str, req: StyleUpdateRequest):\n    \"\"\"スタイル更新\"\"\"\n    existing = get_style_by_key(site_key)\n    if not existing:\n        raise HTTPException(status_code=404, detail=f\"スタイル '{site_key}' が見つかりません\")\n    data = {k: v for k, v in req.model_dump().items() if v is not None}\n    result = update_style(site_key, data)\n    return result\n\n\n@router.delete(\"/{site_key}\")\ndef delete_existing_style(site_key: str):\n    \"\"\"スタイル削除\"\"\"\n    deleted = delete_style(site_key)\n    if not deleted:\n        raise HTTPException(status_code=404, detail=f\"スタイル '{site_key}' が見つかりません\")\n    return {\"message\": f\"スタイル '{site_key}' を削除しました\"}\n```\n\n### 5. backend/routers/generation.py - Modify GenerateRequest and generate_images\nAdd `site_style_key: Optional[str] = None` to GenerateRequest.\nAdd import for style_prompt_enhancer.\nWhen site_style_key is provided, use style_prompt_enhancer instead of regular enhancer.\nAdd BackgroundTasks support for auto-evaluation after style-guided generation.\n\nIn the GenerateRequest class, add:\n```python\nsite_style_key: Optional[str] = None\n```\n\nAdd imports at top:\n```python\nfrom fastapi import APIRouter, HTTPException, BackgroundTasks\n```\n\nModify generate_images function signature to include `background_tasks: BackgroundTasks`:\n```python\nasync def generate_images(req: GenerateRequest, background_tasks: BackgroundTasks):\n```\n\nAdd style enhancement logic BEFORE the existing enhance_prompt block:\n```python\n    style_enhanced = None\n    if req.site_style_key:\n        from backend.services.style_prompt_enhancer import enhance_prompt_with_style\n        style_result = await enhance_prompt_with_style(req.prompt, req.site_style_key)\n        actual_prompt = style_result[\"enhanced\"]\n        style_enhanced = style_result\n    elif req.enhance_prompt:\n        enhancement = enhance_prompt_service(req.prompt)\n        actual_prompt = enhancement[\"enhanced\"]\n        enhanced_prompt_text = actual_prompt\n```\n\nUpdate the return to include style info:\n```python\n    return {\n        \"session_id\": session_id,\n        \"images\": saved_images,\n        \"model\": req.model,\n        \"prompt\": req.prompt,\n        \"enhanced_prompt\": enhanced_prompt_text,\n        \"style_enhanced\": style_enhanced,\n    }\n```\n\n### 6. backend/main.py - Register styles router + seed styles\nAdd to imports:\n```python\nfrom backend.routers import images, generation, feedback, prompts, references, analytics, collection, styles\n```\n\nAdd after other include_router calls:\n```python\napp.include_router(styles.router)\n```\n\nIn the startup function, add seed:\n```python\nfrom backend.services.style_profile import seed_default_styles\nseed_default_styles()\n```\n\n## IMPORTANT\n- All file paths must be absolute under /Users/masaaki_nagasawa/Desktop/prm/aiimg/\n- Use Edit tool for existing files, Write tool for new files\n- Read each file BEFORE editing\n- Do NOT modify backend/services/prompt_enhancer.py\n- When done, mark task #1 as completed via TaskUpdate\n- Send a message to \"team-lead\" when complete",
      "color": "blue",
      "planModeRequired": false,
      "joinedAt": 1771425202650,
      "tmuxPaneId": "in-process",
      "cwd": "/Users/masaaki_nagasawa/Desktop/prm/aiimg",
      "subscriptions": [],
      "backendType": "in-process"
    },
    {
      "agentId": "style-evaluator@style-matching",
      "name": "style-evaluator",
      "agentType": "general-purpose",
      "model": "claude-opus-4-6",
      "prompt": "You are `style-evaluator`, a teammate on team `style-matching`. Your task is Phase 3: Style evaluation + reference image selection.\n\n## Working Directory\n/Users/masaaki_nagasawa/Desktop/prm/aiimg\n\n## Your Task (Task #2)\nFirst, mark task #2 as in_progress using TaskUpdate with owner \"style-evaluator\".\n\nThen implement ALL of the following:\n\n### 1. backend/services/style_evaluator.py (NEW FILE)\nCreate this file at /Users/masaaki_nagasawa/Desktop/prm/aiimg/backend/services/style_evaluator.py\n\n```python\n\"\"\"スタイル一致度評価サービス（Gemini Vision）\"\"\"\nfrom __future__ import annotations\n\nimport base64\nimport json\nimport logging\nfrom pathlib import Path\nfrom typing import Dict, List, Optional\n\nfrom google import genai\nfrom google.genai import types\n\nfrom backend.config import GEMINI_API_KEY, PROJECT_ROOT\nfrom backend.database import get_connection, dict_from_row, dicts_from_rows\nfrom backend.services.style_profile import get_style_by_key\n\nlogger = logging.getLogger(__name__)\n\n\ndef _get_client() -> genai.Client:\n    \"\"\"Gemini APIクライアントを取得\"\"\"\n    return genai.Client(api_key=GEMINI_API_KEY)\n\n\ndef _load_image_as_base64(file_path: str) -> Optional[str]:\n    \"\"\"画像ファイルをbase64エンコード\"\"\"\n    try:\n        abs_path = PROJECT_ROOT / file_path\n        if abs_path.exists():\n            return base64.b64encode(abs_path.read_bytes()).decode()\n    except Exception as e:\n        logger.warning(f\"画像読み込み失敗: {file_path} - {e}\")\n    return None\n\n\nasync def evaluate_style_match(image_id: int, site_style_key: str) -> Optional[Dict]:\n    \"\"\"生成画像のスタイル一致度を評価\n\n    Args:\n        image_id: generated_images テーブルのID\n        site_style_key: サイトスタイルキー\n\n    Returns:\n        評価結果のdict、または失敗時None\n    \"\"\"\n    style = get_style_by_key(site_style_key)\n    if not style:\n        logger.error(f\"スタイル '{site_style_key}' が見つかりません\")\n        return None\n\n    conn = get_connection()\n    try:\n        image_row = conn.execute(\n            \"SELECT * FROM generated_images WHERE id = ?\", (image_id,)\n        ).fetchone()\n        if not image_row:\n            logger.error(f\"画像 ID={image_id} が見つかりません\")\n            return None\n        image_data = dict(image_row)\n    finally:\n        conn.close()\n\n    # 画像をbase64で読み込み\n    image_b64 = _load_image_as_base64(image_data[\"file_path\"])\n    if not image_b64:\n        logger.error(f\"画像ファイル読み込み失敗: {image_data['file_path']}\")\n        return None\n\n    profile = json.loads(style[\"style_profile_json\"])\n\n    # Gemini Visionで評価\n    try:\n        client = _get_client()\n\n        eval_prompt = f\"\"\"この画像を以下のサイトスタイルと比較して、一致度を評価してください。\n\n## サイトスタイル: {style[\"site_name\"]}\n- テーマ: {profile.get(\"theme\", \"\")}\n- カラーパレット: {\", \".join(profile.get(\"color_palette\", []))}\n- ムード: {\", \".join(profile.get(\"mood\", []))}\n- モチーフ: {\", \".join(profile.get(\"motifs\", []))}\n- 構図: {profile.get(\"composition\", \"\")}\n- テクスチャ: {profile.get(\"texture\", \"\")}\n\n## 評価基準（各0-100点）\n1. color_match: 色彩の一致度（カラーパレットとの一致）\n2. mood_match: 雰囲気の一致度（ムード・テーマとの一致）\n3. composition_match: 構図・構成の一致度\n\n## 出力形式（JSONのみ）\n{{\"overall_score\": 75, \"color_match\": 80, \"mood_match\": 70, \"composition_match\": 75, \"improvement_hints\": \"改善提案テキスト\"}}\"\"\"\n\n        from PIL import Image\n        from io import BytesIO\n        abs_path = PROJECT_ROOT / image_data[\"file_path\"]\n        pil_image = Image.open(abs_path)\n\n        response = client.models.generate_content(\n            model=\"gemini-2.5-flash\",\n            contents=[pil_image, eval_prompt],\n            config=types.GenerateContentConfig(\n                response_mime_type=\"application/json\",\n            ),\n        )\n\n        if not response.text:\n            logger.warning(\"評価応答が空です\")\n            return None\n\n        scores = json.loads(response.text)\n\n        # DB保存\n        conn = get_connection()\n        try:\n            cursor = conn.execute(\"\"\"\n                INSERT INTO style_evaluations\n                (image_id, site_style_id, overall_score, color_match, mood_match, composition_match, detail_scores_json, improvement_hints)\n                VALUES (?, ?, ?, ?, ?, ?, ?, ?)\n            \"\"\", (\n                image_id,\n                style[\"id\"],\n                scores.get(\"overall_score\", 0),\n                scores.get(\"color_match\", 0),\n                scores.get(\"mood_match\", 0),\n                scores.get(\"composition_match\", 0),\n                json.dumps(scores, ensure_ascii=False),\n                scores.get(\"improvement_hints\", \"\"),\n            ))\n            evaluation_id = cursor.lastrowid\n            conn.commit()\n\n            # 高スコアの場合、成功パターンを蓄積\n            if scores.get(\"overall_score\", 0) >= 70:\n                _record_success_pattern(conn, style[\"id\"], image_id)\n\n            result = {\n                \"id\": evaluation_id,\n                \"image_id\": image_id,\n                \"site_style_key\": site_style_key,\n                \"overall_score\": scores.get(\"overall_score\", 0),\n                \"color_match\": scores.get(\"color_match\", 0),\n                \"mood_match\": scores.get(\"mood_match\", 0),\n                \"composition_match\": scores.get(\"composition_match\", 0),\n                \"improvement_hints\": scores.get(\"improvement_hints\", \"\"),\n            }\n            return result\n        finally:\n            conn.close()\n\n    except Exception as e:\n        logger.error(f\"スタイル評価エラー: {e}\")\n        return None\n\n\ndef _record_success_pattern(conn, site_style_id: int, image_id: int):\n    \"\"\"高スコア画像のプロンプトを成功パターンとして蓄積\"\"\"\n    try:\n        session = conn.execute(\"\"\"\n            SELECT gs.prompt_text FROM generated_images gi\n            JOIN generation_sessions gs ON gs.id = gi.session_id\n            WHERE gi.id = ?\n        \"\"\", (image_id,)).fetchone()\n\n        if not session:\n            return\n\n        prompt_text = session[\"prompt_text\"]\n        # プロンプトの主要部分を抽出（最初の100文字）\n        fragment = prompt_text[:100].strip()\n\n        existing = conn.execute(\n            \"SELECT id, usage_count, avg_score FROM style_patterns WHERE site_style_id = ? AND prompt_fragment = ?\",\n            (site_style_id, fragment)\n        ).fetchone()\n\n        if existing:\n            # 既存パターンを更新\n            new_count = existing[\"usage_count\"] + 1\n            conn.execute(\n                \"UPDATE style_patterns SET usage_count = ?, avg_score = ? WHERE id = ?\",\n                (new_count, existing[\"avg_score\"], existing[\"id\"])\n            )\n        else:\n            conn.execute(\n                \"INSERT INTO style_patterns (site_style_id, prompt_fragment, avg_score, usage_count) VALUES (?, ?, 0, 1)\",\n                (site_style_id, fragment)\n            )\n        conn.commit()\n    except Exception as e:\n        logger.warning(f\"成功パターン蓄積エラー: {e}\")\n\n\ndef get_style_report(site_style_key: str) -> Dict:\n    \"\"\"スタイル別評価レポート\"\"\"\n    style = get_style_by_key(site_style_key)\n    if not style:\n        return {\"error\": f\"スタイル '{site_style_key}' が見つかりません\"}\n\n    conn = get_connection()\n    try:\n        # スコア統計\n        stats = conn.execute(\"\"\"\n            SELECT\n                COUNT(*) as total_evaluations,\n                COALESCE(AVG(overall_score), 0) as avg_overall,\n                COALESCE(AVG(color_match), 0) as avg_color,\n                COALESCE(AVG(mood_match), 0) as avg_mood,\n                COALESCE(AVG(composition_match), 0) as avg_composition,\n                COALESCE(MAX(overall_score), 0) as max_score,\n                COALESCE(MIN(overall_score), 0) as min_score\n            FROM style_evaluations\n            WHERE site_style_id = ?\n        \"\"\", (style[\"id\"],)).fetchone()\n\n        # スコア推移（直近20件）\n        trend = conn.execute(\"\"\"\n            SELECT se.overall_score, se.color_match, se.mood_match, se.composition_match, se.created_at\n            FROM style_evaluations se\n            WHERE se.site_style_id = ?\n            ORDER BY se.created_at DESC\n            LIMIT 20\n        \"\"\", (style[\"id\"],)).fetchall()\n\n        # 成功パターン\n        patterns = conn.execute(\"\"\"\n            SELECT * FROM style_patterns\n            WHERE site_style_id = ? AND usage_count > 0\n            ORDER BY avg_score DESC\n            LIMIT 10\n        \"\"\", (style[\"id\"],)).fetchall()\n\n        # 最新の改善提案\n        latest_hints = conn.execute(\"\"\"\n            SELECT improvement_hints, overall_score, created_at\n            FROM style_evaluations\n            WHERE site_style_id = ? AND improvement_hints != ''\n            ORDER BY created_at DESC\n            LIMIT 5\n        \"\"\", (style[\"id\"],)).fetchall()\n\n        return {\n            \"style\": {\n                \"site_key\": style[\"site_key\"],\n                \"site_name\": style[\"site_name\"],\n            },\n            \"stats\": dict(stats) if stats else {},\n            \"trend\": [dict(r) for r in trend],\n            \"patterns\": [dict(r) for r in patterns],\n            \"recent_hints\": [dict(r) for r in latest_hints],\n        }\n    finally:\n        conn.close()\n\n\nasync def evaluate_batch(image_ids: List[int], site_style_key: str) -> List[Dict]:\n    \"\"\"複数画像のバッチ評価\"\"\"\n    results = []\n    for image_id in image_ids:\n        result = await evaluate_style_match(image_id, site_style_key)\n        if result:\n            results.append(result)\n    return results\n```\n\n### 2. backend/services/reference_selector.py (NEW FILE)\nCreate this file at /Users/masaaki_nagasawa/Desktop/prm/aiimg/backend/services/reference_selector.py\n\n```python\n\"\"\"スタイル別参考画像自動選択\"\"\"\nfrom __future__ import annotations\n\nimport json\nimport logging\nfrom typing import Dict, List\n\nfrom backend.database import get_connection, dicts_from_rows\nfrom backend.services.style_profile import get_style_by_key\n\nlogger = logging.getLogger(__name__)\n\n\ndef select_references_for_style(site_style_key: str, max_count: int = 5) -> List[Dict]:\n    \"\"\"スタイルに紐づく参考画像を自動選択\n\n    Args:\n        site_style_key: サイトスタイルキー\n        max_count: 最大選択数（デフォルト5、最大14枚中のスタイル参考枠）\n\n    Returns:\n        参考画像のリスト\n    \"\"\"\n    style = get_style_by_key(site_style_key)\n    if not style:\n        logger.warning(f\"スタイル '{site_style_key}' が見つかりません\")\n        return []\n\n    # スタイルに紐づく参考画像IDを取得\n    try:\n        ref_ids = json.loads(style.get(\"reference_image_ids\", \"[]\"))\n    except (json.JSONDecodeError, TypeError):\n        ref_ids = []\n\n    if not ref_ids:\n        return []\n\n    conn = get_connection()\n    try:\n        # 紐づき画像を取得\n        placeholders = \",\".join(\"?\" for _ in ref_ids)\n        rows = conn.execute(\n            f\"SELECT * FROM reference_images WHERE id IN ({placeholders})\",\n            ref_ids\n        ).fetchall()\n\n        refs = dicts_from_rows(rows)\n\n        # max_countで制限\n        return refs[:max_count]\n    finally:\n        conn.close()\n\n\ndef get_style_reference_ids(site_style_key: str) -> List[int]:\n    \"\"\"スタイル紐づき参考画像のIDリストを取得\"\"\"\n    style = get_style_by_key(site_style_key)\n    if not style:\n        return []\n    try:\n        return json.loads(style.get(\"reference_image_ids\", \"[]\"))\n    except (json.JSONDecodeError, TypeError):\n        return []\n```\n\n### 3. backend/routers/style_evaluation.py (NEW FILE)\nCreate this file at /Users/masaaki_nagasawa/Desktop/prm/aiimg/backend/routers/style_evaluation.py\n\n```python\n\"\"\"スタイル評価API\"\"\"\nfrom __future__ import annotations\n\nimport logging\nfrom typing import List\n\nfrom pydantic import BaseModel\n\nfrom fastapi import APIRouter, HTTPException\n\nfrom backend.services.style_evaluator import (\n    evaluate_style_match,\n    evaluate_batch,\n    get_style_report,\n)\nfrom backend.services.style_profile import get_style_by_key, get_success_patterns\n\nlogger = logging.getLogger(__name__)\nrouter = APIRouter(prefix=\"/api/style-evaluation\", tags=[\"style-evaluation\"])\n\n\nclass EvaluateRequest(BaseModel):\n    image_id: int\n    site_style_key: str\n\n\nclass BatchEvaluateRequest(BaseModel):\n    image_ids: List[int]\n    site_style_key: str\n\n\n@router.post(\"/evaluate\")\nasync def evaluate_single(req: EvaluateRequest):\n    \"\"\"単一画像のスタイル一致度評価\"\"\"\n    result = await evaluate_style_match(req.image_id, req.site_style_key)\n    if result is None:\n        raise HTTPException(status_code=500, detail=\"評価に失敗しました\")\n    return result\n\n\n@router.post(\"/batch\")\nasync def evaluate_batch_endpoint(req: BatchEvaluateRequest):\n    \"\"\"複数画像のバッチ評価\"\"\"\n    results = await evaluate_batch(req.image_ids, req.site_style_key)\n    return {\"results\": results, \"total\": len(results)}\n\n\n@router.get(\"/report/{site_style_key}\")\ndef get_report(site_style_key: str):\n    \"\"\"スタイル別評価レポート\"\"\"\n    style = get_style_by_key(site_style_key)\n    if not style:\n        raise HTTPException(status_code=404, detail=f\"スタイル '{site_style_key}' が見つかりません\")\n    report = get_style_report(site_style_key)\n    return report\n\n\n@router.get(\"/patterns/{site_style_key}\")\ndef get_patterns(site_style_key: str):\n    \"\"\"成功パターン取得\"\"\"\n    style = get_style_by_key(site_style_key)\n    if not style:\n        raise HTTPException(status_code=404, detail=f\"スタイル '{site_style_key}' が見つかりません\")\n    patterns = get_success_patterns(style[\"id\"])\n    return {\"patterns\": patterns}\n```\n\n### 4. backend/main.py - Register style_evaluation router\nRead the current main.py, then add:\n- Import: add `style_evaluation` to the import from backend.routers\n- Router: add `app.include_router(style_evaluation.router)` after the styles router\n\n### 5. backend/routers/generation.py - Add auto-evaluation hook\nRead the current generation.py (it may have been modified by style-backend), then:\n- Add a background task function for auto-evaluation after style-guided generation\n- Add this function at module level:\n\n```python\nasync def _auto_evaluate_style(session_id: int, site_style_key: str):\n    \"\"\"スタイル指定生成後の自動評価（BackgroundTask）\"\"\"\n    try:\n        from backend.services.style_evaluator import evaluate_style_match\n        conn = get_connection()\n        try:\n            images = conn.execute(\n                \"SELECT id FROM generated_images WHERE session_id = ?\",\n                (session_id,)\n            ).fetchall()\n        finally:\n            conn.close()\n\n        for img in images:\n            await evaluate_style_match(img[\"id\"], site_style_key)\n        logger.info(f\"スタイル自動評価完了: session={session_id}, style={site_style_key}\")\n    except Exception as e:\n        logger.error(f\"スタイル自動評価エラー: {e}\")\n```\n\n- In the generate_images function, after the successful return block, add background task:\n  If `req.site_style_key` is set, add: `background_tasks.add_task(_auto_evaluate_style, session_id, req.site_style_key)`\n\n## IMPORTANT\n- All file paths must be absolute under /Users/masaaki_nagasawa/Desktop/prm/aiimg/\n- Use Write tool for new files, Edit tool for existing files\n- Read each existing file BEFORE editing\n- When done, mark task #2 as completed via TaskUpdate\n- Send a message to \"team-lead\" when complete",
      "color": "green",
      "planModeRequired": false,
      "joinedAt": 1771425273843,
      "tmuxPaneId": "in-process",
      "cwd": "/Users/masaaki_nagasawa/Desktop/prm/aiimg",
      "subscriptions": [],
      "backendType": "in-process"
    },
    {
      "agentId": "style-frontend@style-matching",
      "name": "style-frontend",
      "agentType": "general-purpose",
      "model": "claude-opus-4-6",
      "prompt": "You are `style-frontend`, a teammate on team `style-matching`. Your task is Phase 4: Frontend UI for style selection and evaluation reporting.\n\n## Working Directory\n/Users/masaaki_nagasawa/Desktop/prm/aiimg\n\n## Your Task (Task #3)\nFirst, mark task #3 as in_progress using TaskUpdate with owner \"style-frontend\".\n\nThen implement ALL of the following:\n\n### 1. frontend/config.js - Add style endpoints\nRead the current file, then add these endpoints inside the ENDPOINTS object:\n\n```javascript\n// スタイル\nSTYLES: '/api/styles',\nSTYLE_DETAIL: (key) => `/api/styles/${key}`,\nSTYLE_ANALYZE: (key) => `/api/styles/${key}/analyze-references`,\n// スタイル評価\nSTYLE_EVALUATE: '/api/style-evaluation/evaluate',\nSTYLE_EVALUATE_BATCH: '/api/style-evaluation/batch',\nSTYLE_REPORT: (key) => `/api/style-evaluation/report/${key}`,\nSTYLE_PATTERNS: (key) => `/api/style-evaluation/patterns/${key}`,\n```\n\n### 2. frontend/components/style-selector.js (NEW FILE)\nCreate at /Users/masaaki_nagasawa/Desktop/prm/aiimg/frontend/components/style-selector.js\n\n```javascript\n/**\n * スタイル選択コンポーネント\n * 3サイトのスタイルカードを表示し、選択状態を管理\n */\nlet selectedStyleKey = null;\n\nconst STYLE_CARD_COLORS = {\n    izumo: {\n        gradient: 'linear-gradient(135deg, #C5A032 0%, #C14545 50%, #2D6A4F 100%)',\n        border: '#C5A032',\n    },\n    harura: {\n        gradient: 'linear-gradient(135deg, #FFB6C1 0%, #E6E6FA 50%, #98FB98 100%)',\n        border: '#FFB6C1',\n    },\n    gal: {\n        gradient: 'linear-gradient(135deg, #8B00FF 0%, #FF69B4 50%, #FFD700 100%)',\n        border: '#8B00FF',\n    },\n};\n\nasync function renderStyleSelector(containerId) {\n    const container = document.getElementById(containerId);\n    if (!container) return;\n\n    container.innerHTML = '<div class=\"loading-state\" style=\"padding:12px\">スタイル読み込み中...</div>';\n\n    try {\n        const data = await apiRequest(CONFIG.ENDPOINTS.STYLES);\n        if (!data.items || data.items.length === 0) {\n            container.innerHTML = '<p style=\"font-size:13px;color:var(--text-secondary)\">スタイルが登録されていません</p>';\n            return;\n        }\n\n        container.innerHTML = `\n            <div class=\"style-cards\" style=\"display:flex;gap:12px;flex-wrap:wrap\">\n                ${data.items.map(style => {\n                    const colors = STYLE_CARD_COLORS[style.site_key] || {\n                        gradient: 'linear-gradient(135deg, #666 0%, #999 100%)',\n                        border: '#666',\n                    };\n                    const profile = style.style_profile || {};\n                    return `\n                        <div class=\"style-card ${selectedStyleKey === style.site_key ? 'style-card-selected' : ''}\"\n                             data-style-key=\"${style.site_key}\"\n                             onclick=\"toggleStyleSelection('${style.site_key}')\"\n                             style=\"flex:1;min-width:160px;max-width:240px;cursor:pointer;border:2px solid ${selectedStyleKey === style.site_key ? colors.border : 'var(--border)'};border-radius:12px;padding:12px;transition:all 0.2s\">\n                            <div style=\"height:40px;border-radius:8px;margin-bottom:8px;background:${colors.gradient}\"></div>\n                            <div style=\"font-weight:bold;font-size:14px;margin-bottom:4px\">${escapeHtml(style.site_name)}</div>\n                            <div style=\"font-size:11px;color:var(--text-secondary);margin-bottom:6px\">${escapeHtml(profile.theme || '')}</div>\n                            <div style=\"display:flex;gap:4px;flex-wrap:wrap\">\n                                ${(profile.mood || []).slice(0, 3).map(m =>\n                                    `<span style=\"font-size:10px;background:var(--bg);padding:2px 6px;border-radius:4px\">${escapeHtml(m)}</span>`\n                                ).join('')}\n                            </div>\n                            ${(profile.color_hex || []).length > 0 ? `\n                                <div style=\"display:flex;gap:3px;margin-top:8px\">\n                                    ${profile.color_hex.slice(0, 5).map(c =>\n                                        `<div style=\"width:16px;height:16px;border-radius:50%;background:${c};border:1px solid rgba(0,0,0,0.1)\"></div>`\n                                    ).join('')}\n                                </div>\n                            ` : ''}\n                        </div>\n                    `;\n                }).join('')}\n            </div>\n            <div id=\"style-selection-info\" style=\"margin-top:8px;font-size:12px;color:var(--text-secondary)\">\n                ${selectedStyleKey ? `選択中: <strong>${escapeHtml(data.items.find(s => s.site_key === selectedStyleKey)?.site_name || selectedStyleKey)}</strong>` : 'スタイルを選択するとLLM駆動のプロンプト強化が適用されます'}\n            </div>\n        `;\n    } catch (e) {\n        container.innerHTML = `<p style=\"color:var(--danger);font-size:13px\">スタイル読み込みエラー: ${escapeHtml(e.message)}</p>`;\n    }\n}\n\nfunction toggleStyleSelection(styleKey) {\n    if (selectedStyleKey === styleKey) {\n        selectedStyleKey = null;\n    } else {\n        selectedStyleKey = styleKey;\n    }\n\n    // Update visual state\n    document.querySelectorAll('.style-card').forEach(card => {\n        const key = card.dataset.styleKey;\n        const colors = STYLE_CARD_COLORS[key] || { border: '#666' };\n        if (key === selectedStyleKey) {\n            card.classList.add('style-card-selected');\n            card.style.borderColor = colors.border;\n            card.style.boxShadow = `0 0 12px ${colors.border}40`;\n        } else {\n            card.classList.remove('style-card-selected');\n            card.style.borderColor = 'var(--border)';\n            card.style.boxShadow = 'none';\n        }\n    });\n\n    // Update info text\n    const info = document.getElementById('style-selection-info');\n    if (info) {\n        if (selectedStyleKey) {\n            const card = document.querySelector(`.style-card[data-style-key=\"${selectedStyleKey}\"]`);\n            const name = card?.querySelector('[style*=\"font-weight:bold\"]')?.textContent || selectedStyleKey;\n            info.innerHTML = `選択中: <strong>${escapeHtml(name)}</strong> — LLMスタイル強化が適用されます`;\n        } else {\n            info.textContent = 'スタイルを選択するとLLM駆動のプロンプト強化が適用されます';\n        }\n    }\n}\n```\n\n### 3. frontend/components/style-report.js (NEW FILE)\nCreate at /Users/masaaki_nagasawa/Desktop/prm/aiimg/frontend/components/style-report.js\n\n```javascript\n/**\n * スタイル評価レポートコンポーネント\n */\nasync function renderStyleReport(container) {\n    container.innerHTML = `\n        <h2 class=\"section-title\">Style Report</h2>\n        <div id=\"style-tabs\" style=\"display:flex;gap:8px;margin-bottom:20px\"></div>\n        <div id=\"style-report-content\">\n            <div class=\"loading-state\">スタイルを選択してください</div>\n        </div>\n    `;\n\n    // スタイルタブを読み込み\n    try {\n        const data = await apiRequest(CONFIG.ENDPOINTS.STYLES);\n        const tabsDiv = document.getElementById('style-tabs');\n        if (data.items && data.items.length > 0) {\n            tabsDiv.innerHTML = data.items.map(style => {\n                const colors = STYLE_CARD_COLORS[style.site_key] || { gradient: 'linear-gradient(135deg, #666, #999)' };\n                return `\n                    <button class=\"btn btn-secondary style-tab\" data-key=\"${style.site_key}\"\n                            onclick=\"loadStyleReport('${style.site_key}')\"\n                            style=\"position:relative;overflow:hidden\">\n                        <span style=\"position:relative;z-index:1\">${escapeHtml(style.site_name)}</span>\n                    </button>\n                `;\n            }).join('');\n\n            // 最初のスタイルを自動選択\n            loadStyleReport(data.items[0].site_key);\n        }\n    } catch (e) {\n        document.getElementById('style-tabs').innerHTML = `<p style=\"color:var(--danger)\">${escapeHtml(e.message)}</p>`;\n    }\n}\n\nasync function loadStyleReport(siteStyleKey) {\n    // タブのアクティブ状態を更新\n    document.querySelectorAll('.style-tab').forEach(tab => {\n        tab.classList.toggle('btn-primary', tab.dataset.key === siteStyleKey);\n        tab.classList.toggle('btn-secondary', tab.dataset.key !== siteStyleKey);\n    });\n\n    const content = document.getElementById('style-report-content');\n    content.innerHTML = '<div class=\"loading-state\">レポート読み込み中...</div>';\n\n    try {\n        const report = await apiRequest(CONFIG.ENDPOINTS.STYLE_REPORT(siteStyleKey));\n\n        const stats = report.stats || {};\n        const trend = report.trend || [];\n        const patterns = report.patterns || [];\n        const hints = report.recent_hints || [];\n\n        content.innerHTML = `\n            <div style=\"display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:16px;margin-bottom:24px\">\n                <div class=\"card\" style=\"text-align:center\">\n                    <div style=\"font-size:32px;font-weight:bold;color:var(--primary)\">${Math.round(stats.avg_overall || 0)}</div>\n                    <div style=\"font-size:12px;color:var(--text-secondary)\">平均スコア</div>\n                </div>\n                <div class=\"card\" style=\"text-align:center\">\n                    <div style=\"font-size:32px;font-weight:bold;color:var(--success, #22c55e)\">${Math.round(stats.avg_color || 0)}</div>\n                    <div style=\"font-size:12px;color:var(--text-secondary)\">色彩一致度</div>\n                </div>\n                <div class=\"card\" style=\"text-align:center\">\n                    <div style=\"font-size:32px;font-weight:bold;color:var(--warning, #f59e0b)\">${Math.round(stats.avg_mood || 0)}</div>\n                    <div style=\"font-size:12px;color:var(--text-secondary)\">雰囲気一致度</div>\n                </div>\n                <div class=\"card\" style=\"text-align:center\">\n                    <div style=\"font-size:32px;font-weight:bold;color:var(--info, #3b82f6)\">${Math.round(stats.avg_composition || 0)}</div>\n                    <div style=\"font-size:12px;color:var(--text-secondary)\">構図一致度</div>\n                </div>\n            </div>\n\n            <div style=\"display:grid;grid-template-columns:1fr 1fr;gap:16px\">\n                <div class=\"card\">\n                    <div class=\"section-subtitle\">スコア推移</div>\n                    <div style=\"height:250px\">\n                        <canvas id=\"style-trend-chart\"></canvas>\n                    </div>\n                    <div style=\"font-size:11px;color:var(--text-secondary);margin-top:8px\">\n                        評価数: ${stats.total_evaluations || 0} | 最高: ${Math.round(stats.max_score || 0)} | 最低: ${Math.round(stats.min_score || 0)}\n                    </div>\n                </div>\n                <div>\n                    <div class=\"card\" style=\"margin-bottom:16px\">\n                        <div class=\"section-subtitle\">成功パターン</div>\n                        ${patterns.length > 0 ? patterns.map(p => `\n                            <div style=\"padding:8px;background:var(--bg);border-radius:6px;margin-bottom:6px;font-size:12px\">\n                                <div style=\"color:var(--text-primary)\">${escapeHtml(p.prompt_fragment)}</div>\n                                <div style=\"color:var(--text-secondary);margin-top:4px\">\n                                    使用: ${p.usage_count}回 | 平均スコア: ${Math.round(p.avg_score || 0)}\n                                </div>\n                            </div>\n                        `).join('') : '<p style=\"font-size:13px;color:var(--text-secondary)\">まだ成功パターンがありません</p>'}\n                    </div>\n                    <div class=\"card\">\n                        <div class=\"section-subtitle\">最新の改善提案</div>\n                        ${hints.length > 0 ? hints.map(h => `\n                            <div style=\"padding:8px;background:var(--bg);border-radius:6px;margin-bottom:6px;font-size:12px\">\n                                <div style=\"color:var(--text-primary)\">${escapeHtml(h.improvement_hints)}</div>\n                                <div style=\"color:var(--text-secondary);margin-top:4px\">\n                                    スコア: ${Math.round(h.overall_score)} | ${h.created_at}\n                                </div>\n                            </div>\n                        `).join('') : '<p style=\"font-size:13px;color:var(--text-secondary)\">まだ改善提案がありません</p>'}\n                    </div>\n                </div>\n            </div>\n        `;\n\n        // Chart.js でスコア推移チャートを描画\n        if (trend.length > 0) {\n            const ctx = document.getElementById('style-trend-chart');\n            if (ctx) {\n                const labels = trend.map((_, i) => `#${trend.length - i}`).reverse();\n                const reversedTrend = [...trend].reverse();\n                new Chart(ctx, {\n                    type: 'line',\n                    data: {\n                        labels,\n                        datasets: [\n                            {\n                                label: '総合',\n                                data: reversedTrend.map(t => t.overall_score),\n                                borderColor: 'var(--primary)',\n                                backgroundColor: 'transparent',\n                                tension: 0.3,\n                            },\n                            {\n                                label: '色彩',\n                                data: reversedTrend.map(t => t.color_match),\n                                borderColor: '#22c55e',\n                                backgroundColor: 'transparent',\n                                tension: 0.3,\n                            },\n                            {\n                                label: '雰囲気',\n                                data: reversedTrend.map(t => t.mood_match),\n                                borderColor: '#f59e0b',\n                                backgroundColor: 'transparent',\n                                tension: 0.3,\n                            },\n                            {\n                                label: '構図',\n                                data: reversedTrend.map(t => t.composition_match),\n                                borderColor: '#3b82f6',\n                                backgroundColor: 'transparent',\n                                tension: 0.3,\n                            },\n                        ],\n                    },\n                    options: {\n                        responsive: true,\n                        maintainAspectRatio: false,\n                        scales: {\n                            y: { min: 0, max: 100 },\n                        },\n                        plugins: {\n                            legend: { position: 'bottom', labels: { boxWidth: 12, font: { size: 11 } } },\n                        },\n                    },\n                });\n            }\n        }\n    } catch (e) {\n        content.innerHTML = `<div class=\"error-state\"><p>${escapeHtml(e.message)}</p></div>`;\n    }\n}\n```\n\n### 4. frontend/components/prompt-manager.js - Add style selector to Generate page\nRead the current file, then modify the `renderGenerate` function:\n\n**Add this section** AFTER the \"プロンプト自動補強\" section and BEFORE the model/aspect ratio grid, inside the card div:\n\n```html\n<div class=\"form-group\">\n    <div class=\"section-subtitle\" style=\"margin-bottom:8px\">サイトスタイル（任意）</div>\n    <div id=\"style-selector-area\"></div>\n</div>\n```\n\n**After** the `renderGenerate` function finishes setting up (after `loadModelOptions();`), add:\n```javascript\nrenderStyleSelector('style-selector-area');\n```\n\n**In the `generateImages` function**, modify the body object to include:\n```javascript\nsite_style_key: selectedStyleKey || null,\n```\n\n**In the generation result display**, after the enhanced_prompt display, add style info:\n```javascript\n${result.style_enhanced ? `<div style=\"font-size:11px;color:var(--text-secondary);margin-top:4px;padding:0 8px\">スタイル: ${escapeHtml(result.style_enhanced.style_name)} (${result.style_enhanced.method})</div>` : ''}\n```\n\n### 5. frontend/index.html - Add script tags and nav link\nRead the current file, then:\n- Add `<a href=\"#styles\" class=\"nav-link\">Styles</a>` in the nav bar after Collection\n- Add script tags before closing body:\n  ```html\n  <script src=\"/static/components/style-selector.js?v=20260218\"></script>\n  <script src=\"/static/components/style-report.js?v=20260218\"></script>\n  ```\n\n### 6. frontend/app.js - Add styles route\nRead the current file, then add in the handleRoute switch:\n```javascript\ncase 'styles':\n    await renderStyleReport(content);\n    break;\n```\n\n## IMPORTANT\n- All file paths must be absolute under /Users/masaaki_nagasawa/Desktop/prm/aiimg/\n- Use Write tool for new files, Edit tool for existing files\n- Read each existing file BEFORE editing to understand the current state\n- DO NOT modify any backend files\n- When done, mark task #3 as completed via TaskUpdate\n- Send a message to \"team-lead\" when complete",
      "color": "yellow",
      "planModeRequired": false,
      "joinedAt": 1771425336528,
      "tmuxPaneId": "in-process",
      "cwd": "/Users/masaaki_nagasawa/Desktop/prm/aiimg",
      "subscriptions": [],
      "backendType": "in-process"
    },
    {
      "agentId": "style-tester@style-matching",
      "name": "style-tester",
      "agentType": "general-purpose",
      "model": "claude-opus-4-6",
      "prompt": "You are `style-tester`, a teammate on team `style-matching`. Your task is Phase 5: Write tests for all new style-related modules.\n\n## Working Directory\n/Users/masaaki_nagasawa/Desktop/prm/aiimg\n\n## Your Task (Task #4)\nFirst, mark task #4 as in_progress using TaskUpdate with owner \"style-tester\".\n\nBefore writing tests, READ the actual implementation files to understand what was implemented:\n1. Read backend/database.py (to see the new tables)\n2. Read backend/services/style_profile.py\n3. Read backend/services/style_prompt_enhancer.py\n4. Read backend/services/style_evaluator.py\n5. Read backend/services/reference_selector.py\n6. Read backend/routers/styles.py\n7. Read backend/routers/style_evaluation.py\n8. Read backend/routers/generation.py (to see the site_style_key changes)\n9. Read tests/test_prompt_enhancer.py (to follow existing test patterns)\n10. Read tests/test_database.py (to understand DB test setup patterns)\n\nThen implement ALL of the following test files:\n\n### 1. tests/test_style_profile.py (NEW FILE)\nTest the style_profile service:\n- Use a temporary DB (monkeypatch backend.config.DB_PATH to a tmp file, then call init_database())\n- Test seed_default_styles: after seeding, 3 styles exist\n- Test get_all_styles: returns list of dicts\n- Test get_style_by_key: izumo, harura, gal each return correct data\n- Test get_style_by_key with nonexistent key: returns None\n- Test create_style: creates and retrieves\n- Test update_style: updates fields\n- Test delete_style: removes and confirms gone\n- Test get_success_patterns: returns empty list initially\n\n### 2. tests/test_style_prompt_enhancer.py (NEW FILE)\nTest the style prompt enhancer:\n- Use monkeypatch for DB path + init_database + seed_default_styles\n- Mock the Gemini API call (unittest.mock.patch on `google.genai.Client` or the `_get_client` function)\n- Test enhance_prompt_with_style with valid style: returns enhanced prompt with method=\"llm\"\n- Test enhance_prompt_with_style with nonexistent style: returns method=\"no_style_found\"\n- Test fallback on LLM error: when mock raises, returns method=\"static_fallback\"\n- Verify response dict structure: original, enhanced, style_key, style_name, method\n\n### 3. tests/test_style_evaluator.py (NEW FILE)\nTest the style evaluator:\n- Use monkeypatch for DB path + init_database + seed_default_styles\n- Mock Gemini Vision API calls\n- Test evaluate_style_match: mocked response returns scores, saves to DB\n- Test get_style_report: returns proper structure\n- Test evaluate_batch: processes multiple images\n- Note: You'll need to create fake image entries in generated_images and generation_sessions tables for testing\n\n### 4. tests/test_reference_selector.py (NEW FILE)\nTest the reference selector:\n- Use monkeypatch for DB path + init_database + seed_default_styles\n- Test select_references_for_style: with empty reference_image_ids returns []\n- Test get_style_reference_ids: returns list\n- Test with actual reference_image_ids set in style: returns matching images\n\n### 5. tests/test_style_api.py (NEW FILE)\nIntegration tests using FastAPI TestClient:\n- Import and use TestClient from fastapi.testclient\n- Use the app from backend.main\n- Monkeypatch DB_PATH before importing app\n- Test GET /api/styles: returns list\n- Test GET /api/styles/izumo: returns style detail\n- Test GET /api/styles/nonexistent: returns 404\n- Test POST /api/styles: creates new style\n- Test PUT /api/styles/izumo: updates style\n- Test DELETE /api/styles/{key}: deletes style\n- Test GET /api/style-evaluation/report/izumo: returns report structure\n- Test GET /api/style-evaluation/patterns/izumo: returns patterns\n- All requests include header: {\"x-api-token\": \"makeimg_dev_token\"}\n\n### IMPORTANT PATTERNS\nFor DB setup in tests, use this pattern (adapted from existing test files):\n\n```python\nimport pytest\nimport tempfile\nfrom pathlib import Path\nfrom unittest.mock import patch, MagicMock, AsyncMock\n\n@pytest.fixture(autouse=True)\ndef tmp_db(monkeypatch, tmp_path):\n    \"\"\"一時DBを使用\"\"\"\n    db_path = tmp_path / \"test.db\"\n    monkeypatch.setattr(\"backend.config.DB_PATH\", db_path)\n    from backend.database import init_database\n    init_database()\n    return db_path\n```\n\nFor mocking Gemini API:\n```python\n@pytest.fixture\ndef mock_genai():\n    with patch(\"backend.services.style_prompt_enhancer._get_client\") as mock:\n        client = MagicMock()\n        mock.return_value = client\n        response = MagicMock()\n        response.text = \"Enhanced prompt text here\"\n        client.models.generate_content.return_value = response\n        yield client\n```\n\n## IMPORTANT\n- All test files must be at /Users/masaaki_nagasawa/Desktop/prm/aiimg/tests/\n- Read ALL source files before writing tests\n- Follow the existing test patterns in the project\n- Use Write tool for new files\n- When done, mark task #4 as completed via TaskUpdate\n- Send a message to \"team-lead\" when complete",
      "color": "purple",
      "planModeRequired": false,
      "joinedAt": 1771425374681,
      "tmuxPaneId": "in-process",
      "cwd": "/Users/masaaki_nagasawa/Desktop/prm/aiimg",
      "subscriptions": [],
      "backendType": "in-process"
    }
  ]
}