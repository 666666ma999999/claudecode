{
  "name": "sse-streaming",
  "description": "SSE化: 商品候補生成のストリーミング対応",
  "createdAt": 1770633202218,
  "leadAgentId": "team-lead@sse-streaming",
  "leadSessionId": "20cdd745-e935-40cb-806d-252e244ec03b",
  "members": [
    {
      "agentId": "team-lead@sse-streaming",
      "name": "team-lead",
      "agentType": "team-lead",
      "model": "claude-opus-4-6",
      "joinedAt": 1770633202218,
      "tmuxPaneId": "",
      "cwd": "/Users/masaaki/Desktop/prm/rohan",
      "subscriptions": []
    },
    {
      "agentId": "be-sse@sse-streaming",
      "name": "be-sse",
      "agentType": "general-purpose",
      "model": "sonnet",
      "prompt": "You are \"be-sse\" teammate in team \"sse-streaming\". Your task is Task #1: Backend SSE endpoint + Gemini async.\n\n## Your files to edit:\n1. `backend/routers/product_development_v2.py` \n2. `backend/main.py` (1 line addition only)\n\n## Task details:\n\n### File 1: `backend/routers/product_development_v2.py`\n\n**A. Add imports at top (after existing imports, line ~19):**\n```python\nfrom fastapi.responses import StreamingResponse\nfrom fastapi import Request\nimport asyncio\nimport json\n```\nNote: `APIRouter` and `HTTPException` are already imported from fastapi on line 10. Modify line 10 to add `Request`:\n`from fastapi import APIRouter, HTTPException, Request`\n\n**B. Add \"executor\" to `_deps` dict (line 28-36):**\nAdd `\"executor\": None,` to the `_deps` dictionary.\n\n**C. Make Gemini calls non-blocking in ALL THREE step functions:**\n\nIn `_generate_step1` (line ~442), `_generate_step2` (line ~544), and `_rewrite_with_teacher` (line ~596), change the synchronous call pattern:\n```python\n# BEFORE:\nresponse, error = call_gemini_with_fallback(\n    prompt, \"商品開発V2-Step1\",\n    _deps[\"get_current_model\"],\n    _deps[\"switch_to_fallback_model\"],\n    _deps[\"gemini_fallback_model\"]\n)\n\n# AFTER:\nloop = asyncio.get_event_loop()\nresponse, error = await loop.run_in_executor(\n    _deps[\"executor\"],\n    lambda: call_gemini_with_fallback(\n        prompt, \"商品開発V2-Step1\",\n        _deps[\"get_current_model\"],\n        _deps[\"switch_to_fallback_model\"],\n        _deps[\"gemini_fallback_model\"]\n    )\n)\n```\nDo this for all three functions (Step1, Step2, Step3/rewrite).\n\n**D. Add `_sse_event()` helper function (after the existing helper functions section, before the API endpoints section):**\n```python\ndef _sse_event(event_type: str, data: dict) -> str:\n    \"\"\"SSEイベントをフォーマット\"\"\"\n    return f\"event: {event_type}\\ndata: {json.dumps(data, ensure_ascii=False)}\\n\\n\"\n```\n\n**E. Add SSE streaming endpoint (after the existing `generate_product_v2` endpoint, before `_generate_step1`):**\n\n```python\n@router.post(\"/api/product-development-v2/stream\")\nasync def stream_product_v2(request: ProductDevV2Request, http_request: Request):\n    \"\"\"SSEストリーミングで商品候補を逐次生成\"\"\"\n    \n    if not _deps[\"model\"]:\n        raise HTTPException(status_code=500, detail=\"Gemini APIが設定されていません\")\n    \n    pattern_csv_content = load_builtin_pattern_csv()\n    patterns = parse_pattern_csv(pattern_csv_content) if pattern_csv_content else []\n    blank_count = calculate_blank_count(request.subtitle_count)\n    \n    async def event_generator():\n        # 開始イベント\n        yield _sse_event(\"progress\", {\n            \"type\": \"start\",\n            \"total\": request.candidate_count,\n            \"blank_count\": blank_count\n        })\n        \n        for i in range(request.candidate_count):\n            # クライアント切断チェック\n            if await http_request.is_disconnected():\n                logger.info(f\"クライアント切断検知 - 候補{i+1}生成前に中止\")\n                return\n            \n            # 生成中イベント\n            yield _sse_event(\"progress\", {\n                \"type\": \"generating\",\n                \"current\": i + 1,\n                \"total\": request.candidate_count\n            })\n            \n            emotion_hook = EMOTION_HOOKS[i % len(EMOTION_HOOKS)]\n            pattern = patterns[i % len(patterns)] if patterns else None\n            \n            try:\n                # Step 1\n                step1_result = await _generate_step1(\n                    theme=request.theme,\n                    season=request.season,\n                    subtitle_count=request.subtitle_count,\n                    emotion_hook=emotion_hook,\n                    pattern=pattern\n                )\n                \n                # Step 2\n                step2_result = await _generate_step2(\n                    product_name=step1_result[\"title\"],\n                    subtitles=step1_result[\"subtitles\"],\n                    subtitle_count=request.subtitle_count,\n                    blank_count=blank_count\n                )\n                \n                # Step 3\n                if request.teacher_data and request.teacher_data.strip():\n                    step3_result = await _rewrite_with_teacher(\n                        title=step2_result[\"title\"],\n                        subtitles=step2_result[\"subtitles\"],\n                        teacher_data=request.teacher_data\n                    )\n                else:\n                    step3_result = step2_result\n                \n                candidate = {\n                    \"id\": i + 1,\n                    \"title\": step3_result[\"title\"],\n                    \"subtitles\": [\n                        {\n                            \"number\": j + 1,\n                            \"text\": s.get(\"text\", \"\"),\n                            \"pattern_code\": s.get(\"code\"),\n                            \"is_blank_filled\": s.get(\"is_filled\", False)\n                        }\n                        for j, s in enumerate(step3_result[\"subtitles\"])\n                    ],\n                    \"emotion_hook\": emotion_hook[\"name\"],\n                    \"pattern_type\": pattern[\"type\"] if pattern else \"カスタム\",\n                    \"score\": pattern[\"score\"] if pattern else 50\n                }\n                \n                yield _sse_event(\"candidate\", candidate)\n                logger.info(f\"✅ SSE候補 {i+1}/{request.candidate_count} 送信完了\")\n                \n            except Exception as e:\n                logger.error(f\"❌ SSE候補 {i+1} 生成エラー: {e}\")\n                yield _sse_event(\"error\", {\n                    \"id\": i + 1,\n                    \"message\": str(e),\n                    \"emotion_hook\": emotion_hook[\"name\"]\n                })\n        \n        # 完了イベント\n        yield _sse_event(\"complete\", {\n            \"model_used\": _deps[\"current_model_info\"][\"name\"] if _deps[\"current_model_info\"] else \"unknown\",\n            \"using_fallback\": _deps[\"current_model_info\"][\"using_fallback\"] if _deps[\"current_model_info\"] else False,\n            \"blank_count\": blank_count\n        })\n    \n    return StreamingResponse(\n        event_generator(),\n        media_type=\"text/event-stream\",\n        headers={\n            \"Cache-Control\": \"no-cache\",\n            \"Connection\": \"keep-alive\",\n            \"X-Accel-Buffering\": \"no\",\n        }\n    )\n```\n\n### File 2: `backend/main.py` (line ~3203-3211)\n\nAdd `executor=executor,` to the product_development_v2_router.set_dependencies() call. The executor variable is already defined at line 110.\n\nCurrent code:\n```python\nproduct_development_v2_router.set_dependencies(\n    model=model,\n    fallback_model=fallback_model,\n    current_model_info=current_model_info,\n    get_current_model=get_current_model,\n    switch_to_fallback_model=switch_to_fallback_model,\n    gemini_fallback_model=GEMINI_FALLBACK_MODEL,\n    data_dir=DATA_DIR,\n)\n```\n\nChange to:\n```python\nproduct_development_v2_router.set_dependencies(\n    model=model,\n    fallback_model=fallback_model,\n    current_model_info=current_model_info,\n    get_current_model=get_current_model,\n    switch_to_fallback_model=switch_to_fallback_model,\n    gemini_fallback_model=GEMINI_FALLBACK_MODEL,\n    data_dir=DATA_DIR,\n    executor=executor,\n)\n```\n\n## IMPORTANT:\n- Read each file first before editing\n- Keep existing endpoint unchanged for backward compatibility\n- Use Edit tool for precise changes\n- Do NOT restart the server - the team lead will handle that",
      "color": "blue",
      "planModeRequired": false,
      "joinedAt": 1770633274368,
      "tmuxPaneId": "in-process",
      "cwd": "/Users/masaaki/Desktop/prm/rohan",
      "subscriptions": [],
      "backendType": "in-process"
    }
  ]
}