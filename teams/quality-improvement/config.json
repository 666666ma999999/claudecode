{
  "name": "quality-improvement",
  "description": "画像生成品質改善 - 参照画像指示ビルダー追加 + プロンプト強化",
  "createdAt": 1771238490204,
  "leadAgentId": "team-lead@quality-improvement",
  "leadSessionId": "0db5e270-6a9d-4ee1-92c7-074da1750738",
  "members": [
    {
      "agentId": "team-lead@quality-improvement",
      "name": "team-lead",
      "agentType": "orchestrator",
      "model": "claude-opus-4-6",
      "joinedAt": 1771238490204,
      "tmuxPaneId": "",
      "cwd": "/Users/masaaki/Desktop/prm/makeimg",
      "subscriptions": []
    },
    {
      "agentId": "worker-gemini@quality-improvement",
      "name": "worker-gemini",
      "agentType": "general-purpose",
      "model": "claude-opus-4-6",
      "prompt": "## Task\n`/Users/masaaki/Desktop/prm/makeimg/backend/services/gemini_image.py` を改修する。\n\n## 現在のコード内容（137行）\n以下の変更を行う:\n\n### 1. L48の後（`_load_reference_image`関数の後）に `_build_contents_with_references()` 関数を追加:\n\n```python\ndef _build_contents_with_references(\n    prompt: str,\n    reference_image_paths: List[str],\n    reference_descriptions: Optional[List[str]] = None,\n    reference_instruction: Optional[str] = None,\n) -> list:\n    \"\"\"参照画像付きcontentsを構築\n\n    参照画像をテキスト説明とインターリーブし、指示テンプレートで包む。\n    \"\"\"\n    contents = []\n\n    loaded_count = 0\n    for i, ref_path in enumerate(reference_image_paths[:14]):\n        ref_img = _load_reference_image(ref_path)\n        if ref_img:\n            contents.append(ref_img)\n            # 説明があれば画像の直後に付与\n            desc = \"\"\n            if reference_descriptions and i < len(reference_descriptions) and reference_descriptions[i]:\n                desc = reference_descriptions[i]\n            contents.append(f\"[参照画像{loaded_count + 1}: {desc}]\" if desc else f\"[参照画像{loaded_count + 1}]\")\n            loaded_count += 1\n\n    if loaded_count == 0:\n        return [prompt]\n\n    # 指示テンプレート\n    instruction = reference_instruction or (\n        \"以下の参照画像のスタイル・色調・構図・雰囲気を参考にして、\"\n        \"次の指示に基づいた画像を生成してください。\\n\"\n        \"参照画像の品質レベルと芸術性を維持または向上させてください。\\n\\n\"\n        f\"指示: {prompt}\"\n    )\n    if reference_instruction:\n        instruction = instruction.replace(\"{prompt}\", prompt)\n\n    contents.append(instruction)\n    return contents\n```\n\n### 2. `_build_contents_with_references`の後に `_enhance_prompt()` 関数を追加:\n\n```python\ndef _enhance_prompt(prompt: str, prefix: Optional[str] = None) -> str:\n    \"\"\"プロンプトに品質向上プレフィックスを追加\"\"\"\n    default_prefix = (\n        \"あなたはプロフェッショナルなアーティスト兼写真家です。\\n\"\n        \"以下の指示に基づいて、高品質で芸術的な画像を生成してください。\\n\"\n        \"細部まで精密に描写し、適切な光と影、豊かな色彩表現を心がけてください。\\n\\n\"\n    )\n    return (prefix or default_prefix) + prompt\n```\n\n### 3. `generate_image()` のシグネチャに新パラメータ追加:\n- `reference_descriptions: Optional[List[str]] = None`\n- `reference_instruction: Optional[str] = None`\n- `enhance_prompt: bool = False`\n\n### 4. `generate_image()` 内のコンテンツ構築ロジック（現在の L74-85）を置換:\n\n現在:\n```python\n    # コンテンツ構築（テキスト + 参考画像）\n    contents = []\n\n    # 参考画像を先に追加（最大14枚）\n    if reference_image_paths:\n        for ref_path in reference_image_paths[:14]:\n            ref_img = _load_reference_image(ref_path)\n            if ref_img:\n                contents.append(ref_img)\n\n    # プロンプトテキスト\n    contents.append(prompt)\n```\n\n新しいコード:\n```python\n    # プロンプト強化\n    final_prompt = _enhance_prompt(prompt) if enhance_prompt else prompt\n\n    # コンテンツ構築（テキスト + 参考画像）\n    if reference_image_paths:\n        contents = _build_contents_with_references(\n            prompt=final_prompt,\n            reference_image_paths=reference_image_paths,\n            reference_descriptions=reference_descriptions,\n            reference_instruction=reference_instruction,\n        )\n    else:\n        contents = [final_prompt]\n\n    logger.info(f\"コンテンツ構築完了: 参照画像={len(reference_image_paths or [])}, プロンプト強化={enhance_prompt}\")\n```\n\n## 重要\n- ファイルパス: `/Users/masaaki/Desktop/prm/makeimg/backend/services/gemini_image.py`\n- 既存の定数（NANO_BANANA_MODELS, ASPECT_RATIOS, IMAGE_SIZES）や`_get_client()`, `_load_reference_image()`, `list_available_models()`は変更しない\n- Docstringのパラメータ説明も更新すること",
      "color": "blue",
      "planModeRequired": false,
      "joinedAt": 1771238582424,
      "tmuxPaneId": "in-process",
      "cwd": "/Users/masaaki/Desktop/prm/makeimg",
      "subscriptions": [],
      "backendType": "in-process"
    },
    {
      "agentId": "worker-router@quality-improvement",
      "name": "worker-router",
      "agentType": "general-purpose",
      "model": "claude-opus-4-6",
      "prompt": "## Task\n`/Users/masaaki/Desktop/prm/makeimg/backend/routers/generation.py` を改修する。\n\n## 現在のコード内容（220行）\n以下の変更を行う:\n\n### 1. GenerateRequestクラス（L25-32）に `enhance_prompt` フィールドを追加:\n\n現在:\n```python\nclass GenerateRequest(BaseModel):\n    prompt: str\n    model: str = \"gemini-3-pro-image-preview\"\n    aspect_ratio: str = \"1:1\"\n    image_size: str = \"1K\"\n    number_of_images: int = Field(default=1, ge=1, le=4)\n    reference_image_ids: List[int] = Field(default_factory=list)\n    prompt_template_id: Optional[int] = None\n```\n\n変更後:\n```python\nclass GenerateRequest(BaseModel):\n    prompt: str\n    model: str = \"gemini-3-pro-image-preview\"\n    aspect_ratio: str = \"1:1\"\n    image_size: str = \"1K\"\n    number_of_images: int = Field(default=1, ge=1, le=4)\n    reference_image_ids: List[int] = Field(default_factory=list)\n    prompt_template_id: Optional[int] = None\n    enhance_prompt: bool = False\n```\n\n### 2. 参照画像クエリ拡張（L51-56）:\n\n現在:\n```python\n            placeholders = \",\".join(\"?\" for _ in req.reference_image_ids)\n            refs = conn.execute(\n                f\"SELECT id, file_path FROM reference_images WHERE id IN ({placeholders})\",\n                req.reference_image_ids\n            ).fetchall()\n            ref_paths = [r[\"file_path\"] for r in refs]\n```\n\n変更後:\n```python\n            placeholders = \",\".join(\"?\" for _ in req.reference_image_ids)\n            refs = conn.execute(\n                f\"SELECT id, file_path, description, category FROM reference_images WHERE id IN ({placeholders})\",\n                req.reference_image_ids\n            ).fetchall()\n            ref_paths = [r[\"file_path\"] for r in refs]\n            ref_descriptions = []\n            for r in refs:\n                desc_parts = []\n                if r[\"description\"]:\n                    desc_parts.append(r[\"description\"])\n                if r[\"category\"]:\n                    desc_parts.append(f\"カテゴリ: {r['category']}\")\n                ref_descriptions.append(\" / \".join(desc_parts) if desc_parts else \"\")\n```\n\n### 3. gemini_image.generate_image() 呼び出し更新（L92-98）:\n\n現在:\n```python\n                results = await gemini_image.generate_image(\n                    prompt=req.prompt,\n                    model=req.model,\n                    aspect_ratio=req.aspect_ratio,\n                    image_size=req.image_size,\n                    reference_image_paths=ref_paths if ref_paths else None,\n                    number_of_images=req.number_of_images,\n                )\n```\n\n変更後:\n```python\n                results = await gemini_image.generate_image(\n                    prompt=req.prompt,\n                    model=req.model,\n                    aspect_ratio=req.aspect_ratio,\n                    image_size=req.image_size,\n                    reference_image_paths=ref_paths if ref_paths else None,\n                    reference_descriptions=ref_descriptions if ref_paths else None,\n                    enhance_prompt=req.enhance_prompt,\n                    number_of_images=req.number_of_images,\n                )\n```\n\n### 4. parameters_json 拡張（L69付近）:\n\n現在:\n```python\n            json.dumps({\"reference_image_ids\": req.reference_image_ids, \"image_size\": req.image_size}),\n```\n\n変更後:\n```python\n            json.dumps({\n                \"reference_image_ids\": req.reference_image_ids,\n                \"image_size\": req.image_size,\n                \"enhance_prompt\": req.enhance_prompt,\n                \"reference_count\": len(ref_paths),\n            }),\n```\n\n**注意**: `ref_paths` は L49-56で定義済み。ただし `ref_paths` は `if req.reference_image_ids:` ブロック内でのみ定義されるので、ブロック外で使用する場合は事前に `ref_paths = []` と `ref_descriptions = []` を初期化する必要がある。\n\nつまり、L49の `if req.reference_image_ids:` の前に:\n```python\n        ref_paths = []\n        ref_descriptions = []\n```\nを追加すること。\n\n## 重要\n- ファイルパス: `/Users/masaaki/Desktop/prm/makeimg/backend/routers/generation.py`\n- 既存のバリデーションロジック、セッション管理、画像保存ロジックは変更しない\n- `enhance_prompt` のデフォルトは `False` で後方互換性を維持",
      "color": "green",
      "planModeRequired": false,
      "joinedAt": 1771238596376,
      "tmuxPaneId": "in-process",
      "cwd": "/Users/masaaki/Desktop/prm/makeimg",
      "subscriptions": [],
      "backendType": "in-process"
    },
    {
      "agentId": "worker-test@quality-improvement",
      "name": "worker-test",
      "agentType": "general-purpose",
      "model": "claude-opus-4-6",
      "prompt": "## Task\n`/Users/masaaki/Desktop/prm/makeimg/tests/test_generation.py` にユニットテストを追加する。\n\n## 現在のファイル内容（51行）\n\n```python\n\"\"\"generation関連テスト\"\"\"\nfrom backend.services.gemini_image import NANO_BANANA_MODELS, ASPECT_RATIOS, IMAGE_SIZES, list_available_models\nfrom backend.services.imagen import IMAGEN_MODELS, list_available_models as imagen_list_models\n\n\nclass TestGeminiImageService:\n    \"\"\"Gemini画像生成サービステスト\"\"\"\n\n    def test_models_defined(self):\n        \"\"\"モデル一覧が定義されていること\"\"\"\n        assert len(NANO_BANANA_MODELS) > 0\n        for m in NANO_BANANA_MODELS:\n            assert \"gemini\" in m.lower()\n\n    def test_aspect_ratios_defined(self):\n        \"\"\"アスペクト比が定義されていること（全10種）\"\"\"\n        assert \"1:1\" in ASPECT_RATIOS\n        assert \"16:9\" in ASPECT_RATIOS\n        assert \"9:16\" in ASPECT_RATIOS\n        assert \"2:3\" in ASPECT_RATIOS\n        assert \"21:9\" in ASPECT_RATIOS\n        assert len(ASPECT_RATIOS) == 10\n\n    def test_image_sizes_defined(self):\n        \"\"\"画像サイズが定義されていること\"\"\"\n        assert \"1K\" in IMAGE_SIZES\n        assert \"2K\" in IMAGE_SIZES\n        assert \"4K\" in IMAGE_SIZES\n\n    def test_list_models(self):\n        \"\"\"モデル一覧API\"\"\"\n        models = list_available_models()\n        assert len(models) > 0\n        for m in models:\n            assert \"id\" in m\n            assert \"name\" in m\n            assert m[\"type\"] == \"nano_banana\"\n\n\nclass TestImagenService:\n    \"\"\"Imagen画像生成サービステスト\"\"\"\n\n    def test_models_defined(self):\n        assert len(IMAGEN_MODELS) > 0\n\n    def test_list_models(self):\n        models = imagen_list_models()\n        assert len(models) > 0\n        for m in models:\n            assert m[\"type\"] == \"imagen\"\n```\n\n## 変更内容\n\n既存のコードの末尾（51行目の後）に以下の2つのテストクラスを追加する。\nまた、ファイル先頭のimport文に必要なimportを追加する。\n\n### import追加\n\nファイルの先頭を以下に変更:\n```python\n\"\"\"generation関連テスト\"\"\"\nfrom unittest.mock import patch, MagicMock\n\nfrom PIL import Image\n\nfrom backend.services.gemini_image import (\n    NANO_BANANA_MODELS, ASPECT_RATIOS, IMAGE_SIZES, list_available_models,\n    _build_contents_with_references, _enhance_prompt,\n)\nfrom backend.services.imagen import IMAGEN_MODELS, list_available_models as imagen_list_models\n```\n\n### 追加テスト1: TestBuildContentsWithReferences\n\n```python\nclass TestBuildContentsWithReferences:\n    \"\"\"_build_contents_with_references のテスト\"\"\"\n\n    def test_no_reference_images(self):\n        \"\"\"参照画像パスが空リストの場合、プロンプトのみ\"\"\"\n        result = _build_contents_with_references(\"テストプロンプト\", [])\n        assert result == [\"テストプロンプト\"]\n\n    @patch(\"backend.services.gemini_image._load_reference_image\")\n    def test_with_reference_images(self, mock_load):\n        \"\"\"参照画像がある場合、画像+ラベル+指示テンプレの構造になること\"\"\"\n        mock_img = MagicMock(spec=Image.Image)\n        mock_load.return_value = mock_img\n\n        result = _build_contents_with_references(\n            \"テストプロンプト\",\n            [\"path/to/img1.png\", \"path/to/img2.png\"]\n        )\n\n        # 画像1 + ラベル1 + 画像2 + ラベル2 + 指示テンプレート = 5要素\n        assert len(result) == 5\n        assert result[0] is mock_img\n        assert \"[参照画像1]\" in result[1]\n        assert result[2] is mock_img\n        assert \"[参照画像2]\" in result[3]\n        assert \"テストプロンプト\" in result[4]\n        assert \"スタイル\" in result[4]\n\n    @patch(\"backend.services.gemini_image._load_reference_image\")\n    def test_with_descriptions(self, mock_load):\n        \"\"\"参照画像に説明がある場合、ラベルに含まれること\"\"\"\n        mock_img = MagicMock(spec=Image.Image)\n        mock_load.return_value = mock_img\n\n        result = _build_contents_with_references(\n            \"テストプロンプト\",\n            [\"path/to/img1.png\"],\n            reference_descriptions=[\"風景写真\"]\n        )\n\n        assert \"[参照画像1: 風景写真]\" in result[1]\n\n    @patch(\"backend.services.gemini_image._load_reference_image\")\n    def test_with_custom_instruction(self, mock_load):\n        \"\"\"カスタム指示テンプレートの場合\"\"\"\n        mock_img = MagicMock(spec=Image.Image)\n        mock_load.return_value = mock_img\n\n        custom = \"この画像のように{prompt}を生成\"\n        result = _build_contents_with_references(\n            \"テストプロンプト\",\n            [\"path/to/img1.png\"],\n            reference_instruction=custom\n        )\n\n        assert \"この画像のようにテストプロンプトを生成\" in result[-1]\n\n    @patch(\"backend.services.gemini_image._load_reference_image\")\n    def test_all_images_fail_to_load(self, mock_load):\n        \"\"\"全画像のロードに失敗した場合、プロンプトのみ\"\"\"\n        mock_load.return_value = None\n\n        result = _build_contents_with_references(\n            \"テストプロンプト\",\n            [\"path/to/bad1.png\", \"path/to/bad2.png\"]\n        )\n        assert result == [\"テストプロンプト\"]\n```\n\n### 追加テスト2: TestEnhancePrompt\n\n```python\nclass TestEnhancePrompt:\n    \"\"\"_enhance_prompt のテスト\"\"\"\n\n    def test_default_prefix(self):\n        \"\"\"デフォルトプレフィックスが追加されること\"\"\"\n        result = _enhance_prompt(\"猫を描いて\")\n        assert \"猫を描いて\" in result\n        assert \"プロフェッショナル\" in result\n        assert result.endswith(\"猫を描いて\")\n\n    def test_custom_prefix(self):\n        \"\"\"カスタムプレフィックスで上書きできること\"\"\"\n        result = _enhance_prompt(\"猫を描いて\", prefix=\"カスタム: \")\n        assert result == \"カスタム: 猫を描いて\"\n```\n\n## 重要\n- ファイルパス: `/Users/masaaki/Desktop/prm/makeimg/tests/test_generation.py`\n- 既存の `TestGeminiImageService` と `TestImagenService` は一切変更しないこと\n- import文のみ先頭を変更し、既存importは維持すること",
      "color": "yellow",
      "planModeRequired": false,
      "joinedAt": 1771238680269,
      "tmuxPaneId": "in-process",
      "cwd": "/Users/masaaki/Desktop/prm/makeimg",
      "subscriptions": [],
      "backendType": "in-process"
    }
  ]
}