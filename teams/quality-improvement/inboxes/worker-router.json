[
  {
    "from": "team-lead",
    "text": "{\"type\":\"task_assignment\",\"taskId\":\"2\",\"subject\":\"Task 2: generation.py - 参照画像description取得 + enhance_prompt APIパラメータ追加\",\"description\":\"## Goal\\n`backend/routers/generation.py` に以下の変更を加える。\\n\\n## 2a. 参照画像クエリ拡張\\n\\n現状 (L52-56):\\n```python\\nrefs = conn.execute(\\n    f\\\"SELECT id, file_path FROM reference_images WHERE id IN ({placeholders})\\\",\\n    req.reference_image_ids\\n).fetchall()\\nref_paths = [r[\\\"file_path\\\"] for r in refs]\\n```\\n\\n修正後:\\n```python\\nrefs = conn.execute(\\n    f\\\"SELECT id, file_path, description, category FROM reference_images WHERE id IN ({placeholders})\\\",\\n    req.reference_image_ids\\n).fetchall()\\nref_paths = [r[\\\"file_path\\\"] for r in refs]\\nref_descriptions = []\\nfor r in refs:\\n    desc_parts = []\\n    if r[\\\"description\\\"]:\\n        desc_parts.append(r[\\\"description\\\"])\\n    if r[\\\"category\\\"]:\\n        desc_parts.append(f\\\"カテゴリ: {r['category']}\\\")\\n    ref_descriptions.append(\\\" / \\\".join(desc_parts) if desc_parts else \\\"\\\")\\n```\\n\\n## 2b. GenerateRequestにフィールド追加\\n\\n```python\\nclass GenerateRequest(BaseModel):\\n    prompt: str\\n    model: str = \\\"gemini-3-pro-image-preview\\\"\\n    aspect_ratio: str = \\\"1:1\\\"\\n    image_size: str = \\\"1K\\\"\\n    number_of_images: int = Field(default=1, ge=1, le=4)\\n    reference_image_ids: List[int] = Field(default_factory=list)\\n    prompt_template_id: Optional[int] = None\\n    enhance_prompt: bool = False  # ← 新規追加\\n```\\n\\n## 2c. gemini_image.generate_image() 呼び出し更新\\n\\n現状 (L92-98):\\n```python\\nresults = await gemini_image.generate_image(\\n    prompt=req.prompt,\\n    model=req.model,\\n    aspect_ratio=req.aspect_ratio,\\n    image_size=req.image_size,\\n    reference_image_paths=ref_paths if ref_paths else None,\\n    number_of_images=req.number_of_images,\\n)\\n```\\n\\n修正後:\\n```python\\nresults = await gemini_image.generate_image(\\n    prompt=req.prompt,\\n    model=req.model,\\n    aspect_ratio=req.aspect_ratio,\\n    image_size=req.image_size,\\n    reference_image_paths=ref_paths if ref_paths else None,\\n    reference_descriptions=ref_descriptions if ref_paths else None,\\n    enhance_prompt=req.enhance_prompt,\\n    number_of_images=req.number_of_images,\\n)\\n```\\n\\n## 2d. parameters_json に記録\\n\\nセッション作成時の parameters_json を拡張:\\n```python\\njson.dumps({\\n    \\\"reference_image_ids\\\": req.reference_image_ids,\\n    \\\"image_size\\\": req.image_size,\\n    \\\"enhance_prompt\\\": req.enhance_prompt,\\n    \\\"reference_count\\\": len(ref_paths),\\n})\\n```\\n\\n注意: `ref_paths` は parameters_json 構築時点では既に定義済みである必要がある。\\n現在のコードフローではセッション作成がL59-71で、参照画像取得がL49-56で先に行われるので問題ない。\\n\\n## Context\\n- 対象ファイル: `/Users/masaaki/Desktop/prm/makeimg/backend/routers/generation.py`\\n- 現在のコード: 220行\\n- `GenerateRequest` は L25-32\\n- 参照画像取得は L49-56\\n- セッション作成は L59-71\\n- gemini呼び出しは L92-98\\n\\n## Constraints\\n- 既存の後方互換性を維持\\n- `ref_descriptions` 変数はref_pathsと同じスコープで定義\\n- `enhance_prompt: bool = False` なのでデフォルトで既存動作維持\\n- `ref_descriptions` はref_pathsが空の場合Noneを渡す\\n\\n## Verification\\n変更後のファイルがPythonの構文エラーを含まないこと: `python -c \\\"import ast; ast.parse(open('backend/routers/generation.py').read())\\\"`\",\"assignedBy\":\"team-lead\",\"timestamp\":\"2026-02-16T10:42:39.568Z\"}",
    "timestamp": "2026-02-16T10:42:39.568Z",
    "read": false
  }
]