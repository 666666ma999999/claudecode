{
  "name": "favorites-feature",
  "description": "お気に入り機能 & 比較ビュー実装チーム",
  "createdAt": 1771469864727,
  "leadAgentId": "team-lead@favorites-feature",
  "leadSessionId": "be412ef6-8096-40e8-b2d4-9d4d09cbb190",
  "members": [
    {
      "agentId": "team-lead@favorites-feature",
      "name": "team-lead",
      "agentType": "orchestrator",
      "model": "claude-opus-4-6",
      "joinedAt": 1771469864727,
      "tmuxPaneId": "",
      "cwd": "/Users/masaaki_nagasawa/Desktop/prm/aiimg",
      "subscriptions": []
    },
    {
      "agentId": "backend-dev@favorites-feature",
      "name": "backend-dev",
      "agentType": "general-purpose",
      "model": "claude-opus-4-6",
      "prompt": "あなたは「backend-dev」です。favorites-featureチームのバックエンド担当です。\n\n## タスク: T1-T4 バックエンド お気に入り機能実装\n\n以下の4つの変更を実装してください。\n\n### T1: /Users/masaaki_nagasawa/Desktop/prm/aiimg/backend/database.py\n\n1. `generated_images`テーブル定義で`image_index INTEGER DEFAULT 0,`の次の行に `is_favorite INTEGER DEFAULT 0,` を追加\n2. `init_database()`関数内のconn.commitの前に、ALTER TABLE マイグレーションを追加:\n```python\n# マイグレーション: is_favoriteカラム追加\ntry:\n    conn.execute(\"ALTER TABLE generated_images ADD COLUMN is_favorite INTEGER DEFAULT 0\")\nexcept Exception:\n    pass  # カラム既存\n```\n3. インデックス定義の`idx_generated_images_session`の後に追加:\n```sql\nCREATE INDEX IF NOT EXISTS idx_generated_images_favorite ON generated_images(is_favorite);\n```\n\n### T2: /Users/masaaki_nagasawa/Desktop/prm/aiimg/backend/routers/favorites.py（新規作成）\n\n```python\n\"\"\"お気に入りトグルAPI\"\"\"\nfrom __future__ import annotations\n\nfrom fastapi import APIRouter, HTTPException\n\nfrom backend.database import get_connection\n\nrouter = APIRouter(prefix=\"/api/favorites\", tags=[\"favorites\"])\n\n\n@router.post(\"/{image_id}\")\ndef toggle_favorite(image_id: int):\n    \"\"\"お気に入り状態をトグル（0↔1）\"\"\"\n    conn = get_connection()\n    try:\n        row = conn.execute(\n            \"SELECT id, is_favorite FROM generated_images WHERE id = ?\",\n            (image_id,)\n        ).fetchone()\n        if not row:\n            raise HTTPException(status_code=404, detail=\"画像が見つかりません\")\n\n        new_val = 0 if row[\"is_favorite\"] else 1\n        conn.execute(\n            \"UPDATE generated_images SET is_favorite = ? WHERE id = ?\",\n            (new_val, image_id)\n        )\n        conn.commit()\n        return {\"id\": image_id, \"is_favorite\": new_val}\n    finally:\n        conn.close()\n```\n\n### T3: /Users/masaaki_nagasawa/Desktop/prm/aiimg/backend/routers/images.py\n\n`list_images()`に`favorite_only: Optional[bool] = None`パラメータを追加し、以下の条件分岐を追加:\n\n1. 関数シグネチャに追加: `favorite_only: Optional[bool] = None,`\n2. メインクエリのconditionsに追加（`if model:`ブロックの後）:\n```python\nif favorite_only:\n    conditions.append(\"gi.is_favorite = 1\")\n```\n3. count_queryのcount_conditionsにも同様に追加:\n```python\nif favorite_only:\n    count_conditions.append(\"gi.is_favorite = 1\")\n```\n\n### T4: /Users/masaaki_nagasawa/Desktop/prm/aiimg/backend/main.py\n\n1. importの行を修正:\n変更前: `from backend.routers import images, generation, feedback, prompts, references, styles, style_evaluation, style_optimizer`\n変更後: `from backend.routers import images, generation, feedback, prompts, references, styles, style_evaluation, style_optimizer, favorites`\n\n2. `app.include_router(style_optimizer.router)`の後に追加:\n```python\napp.include_router(favorites.router)\n```\n\n## 重要\n- 必ず上記の絶対パスを使ってファイルを編集してください\n- まずReadツールで各ファイルを読んでから編集してください\n- 新規ファイル（favorites.py）はWriteツールで作成してください",
      "color": "blue",
      "planModeRequired": false,
      "joinedAt": 1771469946832,
      "tmuxPaneId": "in-process",
      "cwd": "/Users/masaaki_nagasawa/Desktop/prm/aiimg",
      "subscriptions": [],
      "backendType": "in-process"
    },
    {
      "agentId": "frontend-dev@favorites-feature",
      "name": "frontend-dev",
      "agentType": "general-purpose",
      "model": "claude-opus-4-6",
      "prompt": "あなたは「frontend-dev」です。favorites-featureチームのフロントエンド担当です。\n\n## タスク: T5-T9 + T10-T12 フロントエンド お気に入り & 比較ビュー実装\n\n以下の変更を全て実装してください。\n\n---\n\n### T5: /Users/masaaki_nagasawa/Desktop/prm/aiimg/frontend/styles.css\n\n`/* Responsive */`の前（`@media`の直前）に以下のCSSを追加:\n\n```css\n/* Favorite button */\n.fav-btn {\n    background: none;\n    border: none;\n    cursor: pointer;\n    font-size: 20px;\n    color: var(--text-secondary);\n    transition: color 0.15s, transform 0.15s;\n    padding: 4px;\n    line-height: 1;\n}\n.fav-btn:hover { transform: scale(1.2); }\n.fav-btn.fav-active { color: #f59e0b; }\n\n.image-card > .fav-btn {\n    position: absolute;\n    top: 8px;\n    right: 8px;\n    z-index: 10;\n    font-size: 22px;\n    text-shadow: 0 1px 3px rgba(0,0,0,0.5);\n    color: rgba(255,255,255,0.8);\n}\n.image-card > .fav-btn.fav-active { color: #f59e0b; }\n\n.btn-fav-filter.active { background: #f59e0b; color: white; border-color: #f59e0b; }\n\n/* Compare mode */\n.compare-checkbox {\n    position: absolute;\n    top: 8px;\n    left: 8px;\n    z-index: 10;\n    width: 22px;\n    height: 22px;\n    accent-color: var(--primary);\n    cursor: pointer;\n}\n.image-card.compare-selected { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(37,99,235,0.3); }\n\n/* Compare view */\n.compare-grid {\n    display: grid;\n    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));\n    gap: 20px;\n}\n.compare-card {\n    background: var(--surface);\n    border: 1px solid var(--border);\n    border-radius: var(--radius);\n    overflow: hidden;\n    box-shadow: var(--shadow);\n}\n.compare-card img {\n    width: 100%;\n    aspect-ratio: 1;\n    object-fit: contain;\n    background: #f1f5f9;\n}\n.compare-card-info { padding: 12px; }\n```\n\n---\n\n### T6: /Users/masaaki_nagasawa/Desktop/prm/aiimg/frontend/config.js\n\nENDPOINTSオブジェクトに追加（`STYLE_OPTIMIZER_HISTORY`の後、閉じ括弧の前）:\n\n```js\n        // お気に入り\n        FAVORITE_TOGGLE: (id) => `/api/favorites/${id}`,\n```\n\n---\n\n### T7: /Users/masaaki_nagasawa/Desktop/prm/aiimg/frontend/components/image-gallery.js\n\n全面的に書き換え。以下の機能を追加:\n1. フィルターバーに「★ お気に入り」ボタンと「選択して比較」ボタン追加\n2. カードに星ボタン（`.fav-btn`）追加（onclick でevent.stopPropagation()）\n3. 比較モード（チェックボックス表示/非表示、選択上限6枚）\n4. `toggleFavorite(id, btn)` - POST API呼び出し\n5. `toggleFavFilter()` - favorite_only管理\n6. `toggleCompareMode()` - 比較モードON/OFF\n7. `goCompare()` - 比較ビューへ遷移\n\n以下の内容で書き換えてください:\n\n```javascript\n/**\n * 画像ギャラリーコンポーネント\n */\nlet galleryFavOnly = false;\nlet compareMode = false;\nlet compareSelection = new Set();\n\nasync function renderGallery(container) {\n    compareMode = false;\n    compareSelection.clear();\n\n    container.innerHTML = `\n        <h2 class=\"section-title\">Gallery</h2>\n        <div class=\"filter-bar\">\n            <select id=\"filter-model\" class=\"form-select\" style=\"width:auto\">\n                <option value=\"\">全モデル</option>\n            </select>\n            <select id=\"filter-score\" class=\"form-select\" style=\"width:auto\">\n                <option value=\"\">全スコア</option>\n                <option value=\"8\">8+</option>\n                <option value=\"6\">6+</option>\n                <option value=\"4\">4+</option>\n            </select>\n            <button id=\"btn-fav-filter\" class=\"btn btn-secondary btn-fav-filter ${galleryFavOnly ? 'active' : ''}\" onclick=\"toggleFavFilter()\">★ お気に入り</button>\n            <button id=\"btn-compare-mode\" class=\"btn btn-secondary\" onclick=\"toggleCompareMode()\">選択して比較</button>\n            <button id=\"btn-go-compare\" class=\"btn btn-primary\" style=\"display:none\" onclick=\"goCompare()\">比較する (<span id=\"compare-count\">0</span>)</button>\n            <button id=\"btn-refresh\" class=\"btn btn-secondary\">更新</button>\n        </div>\n        <div id=\"gallery-grid\" class=\"image-grid\">\n            <div class=\"loading-state\">読み込み中...</div>\n        </div>\n    `;\n\n    try {\n        const modelsData = await apiRequest(CONFIG.ENDPOINTS.MODELS);\n        const modelSelect = document.getElementById('filter-model');\n        modelsData.models.forEach(m => {\n            const opt = document.createElement('option');\n            opt.value = m.id;\n            opt.textContent = m.name;\n            modelSelect.appendChild(opt);\n        });\n    } catch (e) {\n        console.warn('モデル一覧取得失敗:', e);\n    }\n\n    await loadGalleryImages();\n\n    document.getElementById('btn-refresh').addEventListener('click', loadGalleryImages);\n    document.getElementById('filter-model').addEventListener('change', loadGalleryImages);\n    document.getElementById('filter-score').addEventListener('change', loadGalleryImages);\n}\n\nasync function loadGalleryImages() {\n    const grid = document.getElementById('gallery-grid');\n    if (!grid) return;\n\n    const model = document.getElementById('filter-model')?.value || '';\n    const minScore = document.getElementById('filter-score')?.value || '';\n\n    const params = new URLSearchParams({ limit: '50', offset: '0' });\n    if (model) params.set('model', model);\n    if (minScore) params.set('min_score', minScore);\n    if (galleryFavOnly) params.set('favorite_only', 'true');\n\n    try {\n        const data = await apiRequest(`${CONFIG.ENDPOINTS.IMAGES}?${params}`);\n\n        if (!data.items || data.items.length === 0) {\n            grid.innerHTML = `\n                <div class=\"empty-state\" style=\"grid-column: 1/-1\">\n                    <h3>画像がありません</h3>\n                    <p>${galleryFavOnly ? 'お気に入り画像がありません' : '「Generate」タブから画像を生成してください'}</p>\n                </div>\n            `;\n            return;\n        }\n\n        grid.innerHTML = data.items.map(img => `\n            <div class=\"image-card ${compareMode && compareSelection.has(img.id) ? 'compare-selected' : ''}\" onclick=\"${compareMode ? `toggleCompareSelect(${img.id}, this)` : `navigate('#detail/${img.id}')`}\">\n                ${compareMode ? `<input type=\"checkbox\" class=\"compare-checkbox\" ${compareSelection.has(img.id) ? 'checked' : ''} onclick=\"event.stopPropagation(); toggleCompareSelect(${img.id}, this.parentElement)\">` : ''}\n                <button class=\"fav-btn ${img.is_favorite ? 'fav-active' : ''}\" onclick=\"event.stopPropagation(); toggleFavorite(${img.id}, this)\" title=\"お気に入り\">${img.is_favorite ? '★' : '☆'}</button>\n                <img src=\"${CONFIG.ENDPOINTS.IMAGE_THUMBNAIL(img.id)}\"\n                     alt=\"Generated image\"\n                     loading=\"lazy\"\n                     onerror=\"this.src='${CONFIG.ENDPOINTS.IMAGE_FILE(img.id)}'\">\n                <div class=\"image-card-info\">\n                    <div class=\"image-card-model\">${img.model || 'unknown'}</div>\n                    <div class=\"image-card-prompt\">${escapeHtml(img.prompt_text || '')}</div>\n                    ${img.avg_score > 0 ? `\n                        <div class=\"image-card-score\">\n                            <span class=\"score-badge ${getScoreClass(img.avg_score)}\">${Math.round(img.avg_score * 10) / 10}</span>\n                            <span>(${img.feedback_count}件)</span>\n                        </div>\n                    ` : ''}\n                </div>\n            </div>\n        `).join('');\n    } catch (err) {\n        grid.innerHTML = `<div class=\"error-state\" style=\"grid-column:1/-1\">読み込みエラー: ${escapeHtml(err.message)}</div>`;\n    }\n}\n\nasync function toggleFavorite(imageId, btn) {\n    try {\n        const result = await apiRequest(CONFIG.ENDPOINTS.FAVORITE_TOGGLE(imageId), { method: 'POST' });\n        if (result.is_favorite) {\n            btn.classList.add('fav-active');\n            btn.textContent = '★';\n        } else {\n            btn.classList.remove('fav-active');\n            btn.textContent = '☆';\n        }\n        if (galleryFavOnly && !result.is_favorite) {\n            await loadGalleryImages();\n        }\n    } catch (err) {\n        showMessage(`お気に入り切替エラー: ${err.message}`, 'error');\n    }\n}\n\nfunction toggleFavFilter() {\n    galleryFavOnly = !galleryFavOnly;\n    const btn = document.getElementById('btn-fav-filter');\n    if (btn) btn.classList.toggle('active', galleryFavOnly);\n    loadGalleryImages();\n}\n\nfunction toggleCompareMode() {\n    compareMode = !compareMode;\n    if (!compareMode) compareSelection.clear();\n    const modeBtn = document.getElementById('btn-compare-mode');\n    const goBtn = document.getElementById('btn-go-compare');\n    if (modeBtn) modeBtn.textContent = compareMode ? '選択モード解除' : '選択して比較';\n    if (goBtn) goBtn.style.display = compareMode ? 'inline-flex' : 'none';\n    updateCompareCount();\n    loadGalleryImages();\n}\n\nfunction toggleCompareSelect(imageId, card) {\n    if (compareSelection.has(imageId)) {\n        compareSelection.delete(imageId);\n        card.classList.remove('compare-selected');\n        const cb = card.querySelector('.compare-checkbox');\n        if (cb) cb.checked = false;\n    } else {\n        if (compareSelection.size >= 6) {\n            showMessage('比較は最大6枚までです', 'error');\n            return;\n        }\n        compareSelection.add(imageId);\n        card.classList.add('compare-selected');\n        const cb = card.querySelector('.compare-checkbox');\n        if (cb) cb.checked = true;\n    }\n    updateCompareCount();\n}\n\nfunction updateCompareCount() {\n    const el = document.getElementById('compare-count');\n    if (el) el.textContent = compareSelection.size;\n}\n\nfunction goCompare() {\n    if (compareSelection.size < 2) {\n        showMessage('比較するには2枚以上選択してください', 'error');\n        return;\n    }\n    navigate(`#compare/${Array.from(compareSelection).join(',')}`);\n}\n\nfunction getScoreClass(score) {\n    if (score >= 7) return 'score-high';\n    if (score >= 4) return 'score-mid';\n    return 'score-low';\n}\n```\n\n---\n\n### T8: /Users/masaaki_nagasawa/Desktop/prm/aiimg/frontend/components/image-detail.js\n\nrenderDetail関数内で、「← ギャラリーに戻る」ボタンの横にお気に入りボタンを追加。\n\n変更箇所: `<button class=\"btn btn-secondary\" onclick=\"navigate('#gallery')\">← ギャラリーに戻る</button>` の行を以下に変更:\n\n```html\n<button class=\"btn btn-secondary\" onclick=\"navigate('#gallery')\">← ギャラリーに戻る</button>\n<button class=\"fav-btn ${img.is_favorite ? 'fav-active' : ''}\" onclick=\"toggleDetailFavorite(${imageId})\" style=\"font-size:28px\" title=\"お気に入り\">${img.is_favorite ? '★' : '☆'}</button>\n```\n\nファイル末尾（formatFileSize関数の後）に以下を追加:\n\n```javascript\nasync function toggleDetailFavorite(imageId) {\n    try {\n        const result = await apiRequest(CONFIG.ENDPOINTS.FAVORITE_TOGGLE(imageId), { method: 'POST' });\n        const btn = document.querySelector('.fav-btn');\n        if (btn) {\n            if (result.is_favorite) {\n                btn.classList.add('fav-active');\n                btn.textContent = '★';\n            } else {\n                btn.classList.remove('fav-active');\n                btn.textContent = '☆';\n            }\n        }\n    } catch (err) {\n        showMessage(`お気に入り切替エラー: ${err.message}`, 'error');\n    }\n}\n```\n\n---\n\n### T9: /Users/masaaki_nagasawa/Desktop/prm/aiimg/frontend/components/prompt-manager.js\n\ngenerateImages()内の結果表示部分で、各画像カードに星ボタンを追加。\n\n変更箇所: generateImages()内の `<div class=\"image-card\" onclick=\"navigate('#detail/${img.id}')\">` のすぐ後に星ボタンを追加:\n\n```javascript\n<button class=\"fav-btn\" onclick=\"event.stopPropagation(); toggleFavorite(${img.id}, this)\" title=\"お気に入り\">☆</button>\n```\n\n---\n\n### T11: /Users/masaaki_nagasawa/Desktop/prm/aiimg/frontend/components/comparison-view.js（新規作成）\n\n```javascript\n/**\n * 比較ビューコンポーネント\n */\nasync function renderCompare(container) {\n    const { params } = getRoute();\n    const idsStr = params[0] || '';\n    const ids = idsStr.split(',').map(Number).filter(n => n > 0);\n\n    if (ids.length < 2) {\n        container.innerHTML = `\n            <div class=\"error-state\">\n                <h3>比較する画像を2枚以上選択してください</h3>\n                <p style=\"margin-top:12px\">\n                    <button class=\"btn btn-primary\" onclick=\"navigate('#gallery')\">ギャラリーに戻る</button>\n                </p>\n            </div>\n        `;\n        return;\n    }\n\n    container.innerHTML = '<div class=\"loading-state\">読み込み中...</div>';\n\n    try {\n        const images = await Promise.all(\n            ids.map(id => apiRequest(`${CONFIG.ENDPOINTS.IMAGES}/${id}`))\n        );\n\n        container.innerHTML = `\n            <div style=\"margin-bottom:16px;display:flex;align-items:center;gap:12px\">\n                <button class=\"btn btn-secondary\" onclick=\"navigate('#gallery')\">← ギャラリーに戻る</button>\n                <h2 class=\"section-title\" style=\"margin:0\">画像比較 (${images.length}枚)</h2>\n            </div>\n            <div class=\"compare-grid\">\n                ${images.map(img => `\n                    <div class=\"compare-card\">\n                        <img src=\"${CONFIG.ENDPOINTS.IMAGE_FILE(img.id)}\"\n                             alt=\"Compare image\" loading=\"lazy\">\n                        <div class=\"compare-card-info\">\n                            <div class=\"image-card-model\">${img.model || 'unknown'}</div>\n                            <div style=\"font-size:12px;margin-top:4px\">${escapeHtml((img.prompt_text || '').slice(0, 100))}</div>\n                            ${img.avg_score > 0 ? `\n                                <div class=\"image-card-score\">\n                                    <span class=\"score-badge ${getScoreClass(img.avg_score)}\">\n                                        ${Math.round(img.avg_score * 10) / 10}\n                                    </span>\n                                    <span>(${img.feedback_count}件)</span>\n                                </div>\n                            ` : ''}\n                            <div style=\"font-size:11px;color:var(--text-secondary);margin-top:4px\">\n                                ${img.width}x${img.height} | ${img.aspect_ratio || '-'}\n                            </div>\n                            <div style=\"margin-top:8px\">\n                                <button class=\"btn btn-secondary btn-sm\" onclick=\"navigate('#detail/${img.id}')\">詳細</button>\n                            </div>\n                        </div>\n                    </div>\n                `).join('')}\n            </div>\n        `;\n    } catch (err) {\n        container.innerHTML = `<div class=\"error-state\">画像の読み込みに失敗しました: ${escapeHtml(err.message)}</div>`;\n    }\n}\n```\n\n---\n\n### T12: /Users/masaaki_nagasawa/Desktop/prm/aiimg/frontend/app.js\n\nhandleRoute()のswitch文で `case 'styles':` の前に追加:\n```javascript\n            case 'compare':\n                await renderCompare(content);\n                break;\n```\n\n### T12: /Users/masaaki_nagasawa/Desktop/prm/aiimg/frontend/index.html\n\n`<script src=\"/static/components/style-selector.js` の前に追加:\n```html\n    <script src=\"/static/components/comparison-view.js?v=20260219\"></script>\n```\n\n---\n\n## 重要\n- 必ず上記の絶対パスを使ってファイルを編集してください\n- まずReadツールで各ファイルを読んでから編集してください\n- 新規ファイル（comparison-view.js）はWriteツールで作成してください\n- image-gallery.jsは全体をWriteツールで書き換えてください",
      "color": "green",
      "planModeRequired": false,
      "joinedAt": 1771470010141,
      "tmuxPaneId": "in-process",
      "cwd": "/Users/masaaki_nagasawa/Desktop/prm/aiimg",
      "subscriptions": [],
      "backendType": "in-process"
    },
    {
      "agentId": "test-dev@favorites-feature",
      "name": "test-dev",
      "agentType": "general-purpose",
      "model": "claude-opus-4-6",
      "prompt": "あなたは「test-dev」です。favorites-featureチームのテスト担当です。\n\n## タスク: T13 テストファイル作成\n\n/Users/masaaki_nagasawa/Desktop/prm/aiimg/tests/test_favorites.py を新規作成してください。\n\n### 前提\n- バックエンドのお気に入り機能は既に実装済みです\n- database.py に is_favorite カラムが追加済み\n- routers/favorites.py に POST /api/favorites/{image_id} トグルAPIが追加済み\n- routers/images.py に favorite_only クエリパラメータが追加済み\n\n### テスト内容\n\nまず以下のファイルを読んでテストパターンを理解してください:\n- /Users/masaaki_nagasawa/Desktop/prm/aiimg/backend/database.py\n- /Users/masaaki_nagasawa/Desktop/prm/aiimg/backend/routers/favorites.py\n- /Users/masaaki_nagasawa/Desktop/prm/aiimg/backend/routers/images.py\n- /Users/masaaki_nagasawa/Desktop/prm/aiimg/tests/test_generation.py\n\n以下のテストを書いてください:\n\n```python\n\"\"\"お気に入り機能テスト\"\"\"\nimport sqlite3\nimport tempfile\nfrom unittest.mock import patch\n\nimport pytest\n\nfrom backend.database import init_database, get_connection\n\n\n@pytest.fixture\ndef test_db(tmp_path):\n    \"\"\"テスト用DB\"\"\"\n    db_path = tmp_path / \"test.db\"\n    with patch(\"backend.database.DB_PATH\", db_path):\n        with patch(\"backend.config.DB_PATH\", db_path):\n            init_database()\n            conn = get_connection()\n            # テスト用セッション\n            conn.execute(\n                \"INSERT INTO generation_sessions (id, model, prompt_text) VALUES (1, 'test-model', 'test prompt')\"\n            )\n            # テスト用画像\n            conn.execute(\n                \"INSERT INTO generated_images (id, session_id, file_path) VALUES (1, 1, 'test/img1.png')\"\n            )\n            conn.execute(\n                \"INSERT INTO generated_images (id, session_id, file_path) VALUES (2, 1, 'test/img2.png')\"\n            )\n            conn.commit()\n            conn.close()\n            yield db_path\n\n\nclass TestFavoriteToggle:\n    \"\"\"お気に入りトグルテスト\"\"\"\n\n    def test_toggle_on(self, test_db):\n        \"\"\"トグルONでis_favorite=1\"\"\"\n        with patch(\"backend.database.DB_PATH\", test_db), \\\n             patch(\"backend.config.DB_PATH\", test_db):\n            from backend.routers.favorites import toggle_favorite\n            result = toggle_favorite(1)\n            assert result[\"id\"] == 1\n            assert result[\"is_favorite\"] == 1\n\n    def test_toggle_off(self, test_db):\n        \"\"\"再トグルでis_favorite=0\"\"\"\n        with patch(\"backend.database.DB_PATH\", test_db), \\\n             patch(\"backend.config.DB_PATH\", test_db):\n            from backend.routers.favorites import toggle_favorite\n            toggle_favorite(1)  # ON\n            result = toggle_favorite(1)  # OFF\n            assert result[\"is_favorite\"] == 0\n\n    def test_toggle_not_found(self, test_db):\n        \"\"\"存在しない画像で404\"\"\"\n        with patch(\"backend.database.DB_PATH\", test_db), \\\n             patch(\"backend.config.DB_PATH\", test_db):\n            from backend.routers.favorites import toggle_favorite\n            from fastapi import HTTPException\n            with pytest.raises(HTTPException) as exc_info:\n                toggle_favorite(999)\n            assert exc_info.value.status_code == 404\n\n\nclass TestFavoriteFilter:\n    \"\"\"お気に入りフィルターテスト\"\"\"\n\n    def test_favorite_only_filter(self, test_db):\n        \"\"\"favorite_only=Trueでお気に入りのみ返す\"\"\"\n        with patch(\"backend.database.DB_PATH\", test_db), \\\n             patch(\"backend.config.DB_PATH\", test_db):\n            from backend.routers.favorites import toggle_favorite\n            from backend.routers.images import list_images\n            \n            # 画像1をお気に入りに\n            toggle_favorite(1)\n            \n            # フィルターなし: 全件\n            result_all = list_images(limit=50, offset=0)\n            assert result_all[\"total\"] == 2\n            \n            # お気に入りのみ\n            result_fav = list_images(limit=50, offset=0, favorite_only=True)\n            assert result_fav[\"total\"] == 1\n            assert result_fav[\"items\"][0][\"id\"] == 1\n\n    def test_no_favorites(self, test_db):\n        \"\"\"お気に入りなしでempty\"\"\"\n        with patch(\"backend.database.DB_PATH\", test_db), \\\n             patch(\"backend.config.DB_PATH\", test_db):\n            from backend.routers.images import list_images\n            result = list_images(limit=50, offset=0, favorite_only=True)\n            assert result[\"total\"] == 0\n\n\nclass TestMigration:\n    \"\"\"マイグレーションテスト\"\"\"\n\n    def test_double_init(self, test_db):\n        \"\"\"init_database()二重実行でエラーにならない\"\"\"\n        with patch(\"backend.database.DB_PATH\", test_db), \\\n             patch(\"backend.config.DB_PATH\", test_db):\n            # 二重実行\n            init_database()\n            # カラム存在確認\n            conn = get_connection()\n            row = conn.execute(\"SELECT is_favorite FROM generated_images WHERE id = 1\").fetchone()\n            assert row[\"is_favorite\"] == 0\n            conn.close()\n```\n\n上記を参考にしつつ、実際のファイルを読んでからimport等を調整してください。\n\n### ファイルパス\n/Users/masaaki_nagasawa/Desktop/prm/aiimg/tests/test_favorites.py（新規作成）",
      "color": "yellow",
      "planModeRequired": false,
      "joinedAt": 1771470065061,
      "tmuxPaneId": "in-process",
      "cwd": "/Users/masaaki_nagasawa/Desktop/prm/aiimg",
      "subscriptions": [],
      "backendType": "in-process"
    }
  ]
}