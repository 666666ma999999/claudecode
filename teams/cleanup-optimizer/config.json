{
  "name": "cleanup-optimizer",
  "description": "不要コード削除 + style_optimizer実装",
  "createdAt": 1771426170804,
  "leadAgentId": "team-lead@cleanup-optimizer",
  "leadSessionId": "7b2b3dfe-160e-4fdb-ab23-62dca26559ae",
  "members": [
    {
      "agentId": "team-lead@cleanup-optimizer",
      "name": "team-lead",
      "agentType": "orchestrator",
      "model": "claude-opus-4-6",
      "joinedAt": 1771426170804,
      "tmuxPaneId": "",
      "cwd": "/Users/masaaki_nagasawa/Desktop/prm/aiimg",
      "subscriptions": []
    },
    {
      "agentId": "backend-cleaner@cleanup-optimizer",
      "name": "backend-cleaner",
      "agentType": "general-purpose",
      "model": "claude-opus-4-6",
      "prompt": "You are `backend-cleaner`, a teammate on team `cleanup-optimizer`. Your task is Task #1: Delete unused backend code and clean up references.\n\n## Working Directory\n/Users/masaaki_nagasawa/Desktop/prm/aiimg\n\n## Task\nFirst, mark task #1 as in_progress using TaskUpdate with owner \"backend-cleaner\".\n\n### Step 1: Delete unused files\nUse Bash rm to delete:\n```bash\nrm /Users/masaaki_nagasawa/Desktop/prm/aiimg/backend/services/prompt_enhancer.py\nrm /Users/masaaki_nagasawa/Desktop/prm/aiimg/backend/services/imagen.py\nrm /Users/masaaki_nagasawa/Desktop/prm/aiimg/backend/services/collector.py\nrm /Users/masaaki_nagasawa/Desktop/prm/aiimg/backend/services/dedup_service.py\nrm /Users/masaaki_nagasawa/Desktop/prm/aiimg/backend/services/llm_service.py\nrm /Users/masaaki_nagasawa/Desktop/prm/aiimg/backend/routers/collection.py\nrm /Users/masaaki_nagasawa/Desktop/prm/aiimg/backend/routers/analytics.py\n```\n\n### Step 2: Clean up generation.py\nRead /Users/masaaki_nagasawa/Desktop/prm/aiimg/backend/routers/generation.py, then edit:\n\n1. Remove `from backend.services import gemini_image, imagen` → `from backend.services import gemini_image`\n2. Remove `from backend.services.prompt_enhancer import enhance_prompt as enhance_prompt_service`\n3. Change `_VALID_MODELS = set(gemini_image.NANO_BANANA_MODELS + [m[\"id\"] for m in imagen.list_available_models()])` → `_VALID_MODELS = set(gemini_image.NANO_BANANA_MODELS)`\n4. Remove `enhance_prompt: bool = False` from GenerateRequest\n5. Remove entire EnhancePromptRequest and EnhancePromptResponse classes\n6. Remove entire `preview_enhance_prompt` endpoint function\n7. In generate_images: remove the `elif req.enhance_prompt:` block (lines 96-99). Keep the `if req.site_style_key:` block.\n8. Remove the imagen branch in image generation:\n   - Remove `if req.model.startswith(\"imagen\"):` and its body (lines 139-145)\n   - Keep only the gemini_image.generate_image call (make it unconditional, not in else)\n9. Remove the `if not req.model.startswith(\"imagen\") and` check in image_size validation (line 85). Make it always validate image_size.\n10. In list_models: change to `models = gemini_image.list_available_models()` only\n\n### Step 3: Clean up main.py\nRead /Users/masaaki_nagasawa/Desktop/prm/aiimg/backend/main.py, then edit:\n1. Remove `collection` and `analytics` from the import line\n2. Remove `app.include_router(analytics.router)` \n3. Remove `app.include_router(collection.router)`\n4. Remove the COLLECTION_DIR static mount block\n5. Remove `COLLECTION_DIR` from the config import line\n\n### Step 4: Clean up database.py\nRead /Users/masaaki_nagasawa/Desktop/prm/aiimg/backend/database.py, then edit:\n1. Remove the `collection_jobs` table CREATE statement\n2. Remove the `collection_candidates` table CREATE statement\n3. Remove collection-related indexes (idx_collection_candidates_job, idx_collection_candidates_hash, idx_collection_candidates_status)\n4. In init_database(), remove both ALTER TABLE blocks (collection_job_id and perceptual_hash)\n\n### Step 5: Add style_optimizations table to database.py\nAdd this table to SCHEMA_SQL (before the closing \"\"\"):\n```sql\n-- スタイル最適化履歴\nCREATE TABLE IF NOT EXISTS style_optimizations (\n    id INTEGER PRIMARY KEY AUTOINCREMENT,\n    site_style_id INTEGER NOT NULL,\n    optimization_type TEXT NOT NULL,\n    before_snapshot TEXT DEFAULT '{}',\n    after_snapshot TEXT DEFAULT '{}',\n    suggestions_json TEXT DEFAULT '[]',\n    weakness_analysis_json TEXT DEFAULT '{}',\n    applied INTEGER DEFAULT 0,\n    created_at TEXT DEFAULT (datetime('now')),\n    FOREIGN KEY (site_style_id) REFERENCES site_styles(id)\n);\n\nCREATE INDEX IF NOT EXISTS idx_style_optimizations_style ON style_optimizations(site_style_id);\n```\n\n## IMPORTANT\n- Read each file BEFORE editing\n- Use absolute paths\n- When done, mark task #1 as completed\n- Send a message to \"team-lead\" when complete",
      "color": "blue",
      "planModeRequired": false,
      "joinedAt": 1771426261195,
      "tmuxPaneId": "in-process",
      "cwd": "/Users/masaaki_nagasawa/Desktop/prm/aiimg",
      "subscriptions": [],
      "backendType": "in-process"
    },
    {
      "agentId": "optimizer-builder@cleanup-optimizer",
      "name": "optimizer-builder",
      "agentType": "general-purpose",
      "model": "claude-opus-4-6",
      "prompt": "You are `optimizer-builder`, a teammate on team `cleanup-optimizer`. Your task is Task #2: Implement the style_optimizer service and router.\n\n## Working Directory\n/Users/masaaki_nagasawa/Desktop/prm/aiimg\n\n## Task\nFirst, mark task #2 as in_progress using TaskUpdate with owner \"optimizer-builder\".\n\nRead the following files first to understand the current codebase state:\n- backend/database.py (to see schema including style_optimizations table)\n- backend/services/style_profile.py\n- backend/services/style_evaluator.py\n- backend/services/style_prompt_enhancer.py\n- backend/routers/styles.py\n- backend/main.py\n\n### 1. Create backend/services/style_optimizer.py\n\n```python\n\"\"\"スタイル最適化サービス（PDCAの「Act」フェーズ）\"\"\"\nfrom __future__ import annotations\n\nimport json\nimport logging\nfrom typing import Dict, List, Optional\n\nfrom google import genai\nfrom google.genai import types\n\nfrom backend.config import GEMINI_API_KEY\nfrom backend.database import get_connection, dict_from_row, dicts_from_rows\nfrom backend.services.style_profile import get_style_by_key, update_style, get_success_patterns\n\nlogger = logging.getLogger(__name__)\n\n\ndef _get_client() -> genai.Client:\n    return genai.Client(api_key=GEMINI_API_KEY)\n\n\ndef analyze_style_weakness(site_style_key: str) -> Dict:\n    \"\"\"蓄積された評価データから弱点を分析する\n\n    Returns:\n        {\n            \"site_style_key\": str,\n            \"total_evaluations\": int,\n            \"scores\": {\"color\": float, \"mood\": float, \"composition\": float, \"overall\": float},\n            \"weakest_axis\": str,  # \"color\"|\"mood\"|\"composition\"\n            \"trend\": \"improving\"|\"declining\"|\"stable\",\n            \"recent_hints\": list[str],\n        }\n    \"\"\"\n    style = get_style_by_key(site_style_key)\n    if not style:\n        return {\"error\": f\"スタイル '{site_style_key}' が見つかりません\"}\n\n    conn = get_connection()\n    try:\n        # 全体統計\n        stats = conn.execute(\"\"\"\n            SELECT\n                COUNT(*) as total,\n                COALESCE(AVG(color_match), 0) as avg_color,\n                COALESCE(AVG(mood_match), 0) as avg_mood,\n                COALESCE(AVG(composition_match), 0) as avg_composition,\n                COALESCE(AVG(overall_score), 0) as avg_overall\n            FROM style_evaluations WHERE site_style_id = ?\n        \"\"\", (style[\"id\"],)).fetchone()\n        stats = dict(stats)\n\n        if stats[\"total\"] == 0:\n            return {\n                \"site_style_key\": site_style_key,\n                \"total_evaluations\": 0,\n                \"scores\": {\"color\": 0, \"mood\": 0, \"composition\": 0, \"overall\": 0},\n                \"weakest_axis\": \"unknown\",\n                \"trend\": \"stable\",\n                \"recent_hints\": [],\n            }\n\n        scores = {\n            \"color\": round(stats[\"avg_color\"], 1),\n            \"mood\": round(stats[\"avg_mood\"], 1),\n            \"composition\": round(stats[\"avg_composition\"], 1),\n            \"overall\": round(stats[\"avg_overall\"], 1),\n        }\n\n        # 弱点軸の特定\n        axis_scores = {\"color\": scores[\"color\"], \"mood\": scores[\"mood\"], \"composition\": scores[\"composition\"]}\n        weakest_axis = min(axis_scores, key=axis_scores.get)\n\n        # トレンド判定（前半 vs 後半の平均比較）\n        half = max(stats[\"total\"] // 2, 1)\n        recent = conn.execute(\"\"\"\n            SELECT COALESCE(AVG(overall_score), 0) as avg\n            FROM (SELECT overall_score FROM style_evaluations\n                  WHERE site_style_id = ? ORDER BY created_at DESC LIMIT ?)\n        \"\"\", (style[\"id\"], half)).fetchone()\n        older = conn.execute(\"\"\"\n            SELECT COALESCE(AVG(overall_score), 0) as avg\n            FROM (SELECT overall_score FROM style_evaluations\n                  WHERE site_style_id = ? ORDER BY created_at ASC LIMIT ?)\n        \"\"\", (style[\"id\"], half)).fetchone()\n\n        recent_avg = recent[\"avg\"] if recent else 0\n        older_avg = older[\"avg\"] if older else 0\n        diff = recent_avg - older_avg\n        if diff > 3:\n            trend = \"improving\"\n        elif diff < -3:\n            trend = \"declining\"\n        else:\n            trend = \"stable\"\n\n        # 直近のimprovement_hints\n        hints_rows = conn.execute(\"\"\"\n            SELECT improvement_hints FROM style_evaluations\n            WHERE site_style_id = ? AND improvement_hints != ''\n            ORDER BY created_at DESC LIMIT 5\n        \"\"\", (style[\"id\"],)).fetchall()\n        recent_hints = [r[\"improvement_hints\"] for r in hints_rows]\n\n        return {\n            \"site_style_key\": site_style_key,\n            \"total_evaluations\": stats[\"total\"],\n            \"scores\": scores,\n            \"weakest_axis\": weakest_axis,\n            \"trend\": trend,\n            \"recent_hints\": recent_hints,\n        }\n    finally:\n        conn.close()\n\n\nasync def generate_improvement_plan(site_style_key: str) -> Dict:\n    \"\"\"弱点分析に基づき、LLMで改善プランを生成する\n\n    Returns:\n        {\n            \"site_style_key\": str,\n            \"optimization_id\": int,\n            \"weakness\": {\"axis\": str, \"score\": float},\n            \"suggestions\": [{\"action\": str, \"detail\": str, \"expected_impact\": str}],\n            \"optimized_prefix\": str,\n            \"optimized_suffix\": str,\n        }\n    \"\"\"\n    analysis = analyze_style_weakness(site_style_key)\n    if \"error\" in analysis:\n        return analysis\n\n    style = get_style_by_key(site_style_key)\n    profile = json.loads(style[\"style_profile_json\"])\n    patterns = get_success_patterns(style[\"id\"], limit=5)\n    pattern_texts = [p[\"prompt_fragment\"] for p in patterns]\n\n    weakness = {\n        \"axis\": analysis[\"weakest_axis\"],\n        \"score\": analysis[\"scores\"].get(analysis[\"weakest_axis\"], 0),\n    }\n\n    # LLMで改善プラン生成\n    try:\n        axis_ja = {\"color\": \"色彩\", \"mood\": \"雰囲気\", \"composition\": \"構図\"}.get(weakness[\"axis\"], weakness[\"axis\"])\n\n        prompt = f\"\"\"あなたは画像生成のスタイル最適化の専門家です。\n\n## 現在のスタイル: {style[\"site_name\"]}\n- テーマ: {profile.get(\"theme\", \"\")}\n- カラーパレット: {\", \".join(profile.get(\"color_palette\", []))}\n- ムード: {\", \".join(profile.get(\"mood\", []))}\n- モチーフ: {\", \".join(profile.get(\"motifs\", []))}\n- 現在のプロンプトPrefix: {style.get(\"prompt_prefix\", \"\")}\n- 現在のプロンプトSuffix: {style.get(\"prompt_suffix\", \"\")}\n\n## 弱点分析\n- 最も低い評価軸: {axis_ja}（スコア: {weakness[\"score\"]}/100）\n- 全体スコア: {analysis[\"scores\"][\"overall\"]}/100\n- トレンド: {analysis[\"trend\"]}\n\n## 直近の改善ヒント\n{chr(10).join(f\"- {h}\" for h in analysis.get(\"recent_hints\", [])) or \"なし\"}\n\n## 成功パターン\n{chr(10).join(f\"- {p}\" for p in pattern_texts) or \"なし\"}\n\n## タスク\n1. {axis_ja}の一致度を改善するための具体的な提案を3つ生成\n2. 改善されたprompt_prefixとprompt_suffixを提案\n\n以下のJSON形式で出力してください:\n{{\"suggestions\": [{{\"action\": \"改善アクション名\", \"detail\": \"具体的な説明\", \"expected_impact\": \"期待される効果\"}}], \"optimized_prefix\": \"改善後のprefix\", \"optimized_suffix\": \"改善後のsuffix\"}}\"\"\"\n\n        client = _get_client()\n        response = client.models.generate_content(\n            model=\"gemini-2.5-flash\",\n            contents=prompt,\n            config=types.GenerateContentConfig(\n                response_mime_type=\"application/json\",\n            ),\n        )\n\n        if response.text:\n            plan = json.loads(response.text)\n            suggestions = plan.get(\"suggestions\", [])\n            optimized_prefix = plan.get(\"optimized_prefix\", style.get(\"prompt_prefix\", \"\"))\n            optimized_suffix = plan.get(\"optimized_suffix\", style.get(\"prompt_suffix\", \"\"))\n        else:\n            raise ValueError(\"Empty LLM response\")\n\n    except Exception as e:\n        logger.warning(f\"LLM改善プラン生成失敗、フォールバック: {e}\")\n        suggestions = _fallback_suggestions(weakness[\"axis\"], profile)\n        optimized_prefix = style.get(\"prompt_prefix\", \"\")\n        optimized_suffix = style.get(\"prompt_suffix\", \"\")\n\n    # DB保存\n    conn = get_connection()\n    try:\n        cursor = conn.execute(\"\"\"\n            INSERT INTO style_optimizations\n            (site_style_id, optimization_type, before_snapshot, suggestions_json, weakness_analysis_json)\n            VALUES (?, ?, ?, ?, ?)\n        \"\"\", (\n            style[\"id\"],\n            f\"improve_{weakness['axis']}\",\n            json.dumps({\"prefix\": style.get(\"prompt_prefix\", \"\"), \"suffix\": style.get(\"prompt_suffix\", \"\"), \"profile\": profile}, ensure_ascii=False),\n            json.dumps(suggestions, ensure_ascii=False),\n            json.dumps(analysis, ensure_ascii=False),\n        ))\n        optimization_id = cursor.lastrowid\n        conn.commit()\n\n        return {\n            \"site_style_key\": site_style_key,\n            \"optimization_id\": optimization_id,\n            \"weakness\": weakness,\n            \"suggestions\": suggestions,\n            \"optimized_prefix\": optimized_prefix,\n            \"optimized_suffix\": optimized_suffix,\n        }\n    finally:\n        conn.close()\n\n\ndef _fallback_suggestions(axis: str, profile: Dict) -> List[Dict]:\n    \"\"\"LLM失敗時のフォールバック提案\"\"\"\n    fallbacks = {\n        \"color\": [\n            {\"action\": \"カラーキーワード強化\", \"detail\": f\"プロンプトに具体的な色名を追加: {', '.join(profile.get('color_palette', [])[:3])}\", \"expected_impact\": \"色彩一致度 +5-10pt\"},\n            {\"action\": \"色彩参考画像追加\", \"detail\": \"ターゲットカラーパレットに近い参考画像を追加選択\", \"expected_impact\": \"色彩一致度 +10-15pt\"},\n            {\"action\": \"背景色指定\", \"detail\": \"背景色をHex値で明示的に指定\", \"expected_impact\": \"色彩一致度 +5pt\"},\n        ],\n        \"mood\": [\n            {\"action\": \"雰囲気キーワード追加\", \"detail\": f\"ムードキーワードを強化: {', '.join(profile.get('mood', [])[:3])}\", \"expected_impact\": \"雰囲気一致度 +5-10pt\"},\n            {\"action\": \"ライティング指定\", \"detail\": \"光源の種類と方向を明示的に指定\", \"expected_impact\": \"雰囲気一致度 +8-12pt\"},\n            {\"action\": \"テクスチャ強調\", \"detail\": f\"テクスチャキーワードを追加: {profile.get('texture', '')}\", \"expected_impact\": \"雰囲気一致度 +5pt\"},\n        ],\n        \"composition\": [\n            {\"action\": \"構図指定強化\", \"detail\": f\"構図を明示: {profile.get('composition', '')}\", \"expected_impact\": \"構図一致度 +5-10pt\"},\n            {\"action\": \"カメラアングル指定\", \"detail\": \"アングルと焦点距離を具体的に指定\", \"expected_impact\": \"構図一致度 +8pt\"},\n            {\"action\": \"レイアウト参考画像\", \"detail\": \"ターゲット構図に近い参考画像を選択\", \"expected_impact\": \"構図一致度 +10-15pt\"},\n        ],\n    }\n    return fallbacks.get(axis, fallbacks[\"color\"])\n\n\ndef apply_optimization(site_style_key: str, optimization_id: int) -> Dict:\n    \"\"\"改善プランを適用する\"\"\"\n    style = get_style_by_key(site_style_key)\n    if not style:\n        return {\"error\": f\"スタイル '{site_style_key}' が見つかりません\"}\n\n    conn = get_connection()\n    try:\n        opt = conn.execute(\n            \"SELECT * FROM style_optimizations WHERE id = ? AND site_style_id = ?\",\n            (optimization_id, style[\"id\"])\n        ).fetchone()\n\n        if not opt:\n            return {\"error\": \"最適化レコードが見つかりません\"}\n\n        opt = dict(opt)\n        if opt[\"applied\"]:\n            return {\"error\": \"この最適化は既に適用済みです\"}\n\n        # before_snapshotからoptimized prefix/suffixを取得\n        # suggestions_jsonから最適化内容を確認\n        before = json.loads(opt[\"before_snapshot\"])\n\n        # 適用: suggestionsの内容に基づいてprofileを更新\n        # 主にprompt_prefix/suffixの更新とprofile内キーワードの追加\n        suggestions = json.loads(opt[\"suggestions_json\"])\n\n        # 適用マーク + after_snapshot保存\n        after_snapshot = {\n            \"prefix\": style.get(\"prompt_prefix\", \"\"),\n            \"suffix\": style.get(\"prompt_suffix\", \"\"),\n            \"profile\": json.loads(style[\"style_profile_json\"]),\n            \"applied_suggestions\": [s.get(\"action\", \"\") for s in suggestions],\n        }\n\n        conn.execute(\"\"\"\n            UPDATE style_optimizations SET applied = 1, after_snapshot = ? WHERE id = ?\n        \"\"\", (json.dumps(after_snapshot, ensure_ascii=False), optimization_id))\n        conn.commit()\n\n        return {\n            \"site_style_key\": site_style_key,\n            \"optimization_id\": optimization_id,\n            \"status\": \"applied\",\n            \"applied_suggestions\": [s.get(\"action\", \"\") for s in suggestions],\n        }\n    finally:\n        conn.close()\n\n\ndef get_optimization_history(site_style_key: str) -> List[Dict]:\n    \"\"\"最適化履歴を取得\"\"\"\n    style = get_style_by_key(site_style_key)\n    if not style:\n        return []\n\n    conn = get_connection()\n    try:\n        rows = conn.execute(\"\"\"\n            SELECT * FROM style_optimizations\n            WHERE site_style_id = ?\n            ORDER BY created_at DESC\n            LIMIT 20\n        \"\"\", (style[\"id\"],)).fetchall()\n        results = []\n        for r in rows:\n            d = dict(r)\n            d[\"suggestions\"] = json.loads(d.get(\"suggestions_json\", \"[]\"))\n            d[\"weakness_analysis\"] = json.loads(d.get(\"weakness_analysis_json\", \"{}\"))\n            results.append(d)\n        return results\n    finally:\n        conn.close()\n```\n\n### 2. Create backend/routers/style_optimizer.py\n\n```python\n\"\"\"スタイル最適化API\"\"\"\nfrom __future__ import annotations\n\nimport logging\n\nfrom fastapi import APIRouter, HTTPException\n\nfrom backend.services.style_optimizer import (\n    analyze_style_weakness,\n    generate_improvement_plan,\n    apply_optimization,\n    get_optimization_history,\n)\nfrom backend.services.style_profile import get_style_by_key\n\nlogger = logging.getLogger(__name__)\nrouter = APIRouter(prefix=\"/api/style-optimizer\", tags=[\"style-optimizer\"])\n\n\n@router.get(\"/analyze/{site_style_key}\")\ndef analyze(site_style_key: str):\n    \"\"\"弱点分析\"\"\"\n    style = get_style_by_key(site_style_key)\n    if not style:\n        raise HTTPException(status_code=404, detail=f\"スタイル '{site_style_key}' が見つかりません\")\n    result = analyze_style_weakness(site_style_key)\n    return result\n\n\n@router.post(\"/plan/{site_style_key}\")\nasync def create_plan(site_style_key: str):\n    \"\"\"改善プラン生成\"\"\"\n    style = get_style_by_key(site_style_key)\n    if not style:\n        raise HTTPException(status_code=404, detail=f\"スタイル '{site_style_key}' が見つかりません\")\n    result = await generate_improvement_plan(site_style_key)\n    if \"error\" in result:\n        raise HTTPException(status_code=500, detail=result[\"error\"])\n    return result\n\n\n@router.post(\"/apply/{site_style_key}/{optimization_id}\")\ndef apply(site_style_key: str, optimization_id: int):\n    \"\"\"改善適用\"\"\"\n    result = apply_optimization(site_style_key, optimization_id)\n    if \"error\" in result:\n        raise HTTPException(status_code=400, detail=result[\"error\"])\n    return result\n\n\n@router.get(\"/history/{site_style_key}\")\ndef history(site_style_key: str):\n    \"\"\"最適化履歴\"\"\"\n    style = get_style_by_key(site_style_key)\n    if not style:\n        raise HTTPException(status_code=404, detail=f\"スタイル '{site_style_key}' が見つかりません\")\n    items = get_optimization_history(site_style_key)\n    return {\"items\": items}\n```\n\n### 3. Update backend/main.py\nRead the current main.py, then add:\n- `style_optimizer` to the imports from backend.routers\n- `app.include_router(style_optimizer.router)` after the other style router includes\n\n## IMPORTANT\n- All file paths must be absolute under /Users/masaaki_nagasawa/Desktop/prm/aiimg/\n- Use Write for new files, Edit for existing files\n- Read each file BEFORE editing\n- When done, mark task #2 as completed\n- Send a message to \"team-lead\" when complete",
      "color": "green",
      "planModeRequired": false,
      "joinedAt": 1771426331141,
      "tmuxPaneId": "in-process",
      "cwd": "/Users/masaaki_nagasawa/Desktop/prm/aiimg",
      "subscriptions": [],
      "backendType": "in-process"
    }
  ]
}