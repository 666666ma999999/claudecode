{
  "name": "data-cleanup",
  "description": "20MBエラー解決の4つの対策を並列実装",
  "createdAt": 1770646520977,
  "leadAgentId": "team-lead@data-cleanup",
  "leadSessionId": "8c47d328-0ca6-4560-99a7-cfa0f2147652",
  "members": [
    {
      "agentId": "team-lead@data-cleanup",
      "name": "team-lead",
      "agentType": "team-lead",
      "model": "claude-opus-4-6",
      "joinedAt": 1770646520977,
      "tmuxPaneId": "",
      "cwd": "/Users/masaaki/Desktop/prm/rohan",
      "subscriptions": []
    },
    {
      "agentId": "claudeignore-worker@data-cleanup",
      "name": "claudeignore-worker",
      "agentType": "general-purpose",
      "model": "haiku",
      "prompt": "あなたのタスク: プロジェクトルート `/Users/masaaki/Desktop/prm/rohan/` に `.claudeignore` ファイルを作成してください。\n\n**重要**: プラン外の変更は一切禁止。指定されたファイルのみ作成・変更すること。\n\nファイル内容:\n```\ndata/playwright_recordings/\ndata/check_screenshots/\ndata/manuscript_logs/\ndata/sessions/\ndata/prompt_history.json\ndata/csv_downloads/\ndata/auth_states/\ndata/payment_logs/\ndata/process_states/\ndata/check_sessions/\ndata/screenshots/\ndata/manuscript/\n.playwright-mcp/\nserver.log*\n```\n\n作成後、ファイルの内容を確認してください。\n\n完了したらタスクID #1 を completed にマークしてください。",
      "color": "blue",
      "planModeRequired": false,
      "joinedAt": 1770646531289,
      "tmuxPaneId": "in-process",
      "cwd": "/Users/masaaki/Desktop/prm/rohan",
      "subscriptions": [],
      "backendType": "in-process"
    },
    {
      "agentId": "cleanup-script-worker@data-cleanup",
      "name": "cleanup-script-worker",
      "agentType": "general-purpose",
      "model": "haiku",
      "prompt": "あなたのタスク: プロジェクトルート `/Users/masaaki/Desktop/prm/rohan/` に `cleanup_old_data.sh` シェルスクリプトを作成してください。\n\n**重要**: プラン外の変更は一切禁止。指定されたファイルのみ作成・変更すること。\n\n要件:\n1. macOS互換（BSD find を使用。`-mtime +N` 形式）\n2. dry-run モード: `--dry-run` フラグで削除せずにリストのみ表示\n3. データディレクトリ: スクリプトからの相対パスまたは `ROHAN_DATA_DIR` 環境変数で決定\n4. 削除ポリシー:\n   - `playwright_recordings/`: 3日以上前\n   - `check_screenshots/`: 3日以上前\n   - `screenshots/`: 3日以上前\n   - `manuscript_logs/`: 7日以上前\n   - `sessions/`: 30日以上前\n   - `csv_downloads/`: 7日以上前\n   - `auth_states/`: 7日以上前\n   - `payment_logs/`: 30日以上前\n   - `process_states/`: 7日以上前\n5. 各ディレクトリの削除後、空ディレクトリを除去（`find ... -type d -empty -delete`）\n6. 削除したファイル数と解放容量のサマリーを表示\n7. `chmod +x` で実行権限付与\n\nスクリプトのテンプレート構造:\n```bash\n#!/bin/bash\n# cleanup_old_data.sh - Rohanプロジェクトの古いデータファイルを削除\nset -euo pipefail\n\nDRY_RUN=false\nif [[ \"${1:-}\" == \"--dry-run\" ]]; then\n    DRY_RUN=true\n    echo \"[DRY RUN] 削除は実行されません\"\nfi\n\n# データディレクトリの決定\nSCRIPT_DIR=\"$(cd \"$(dirname \"$0\")\" && pwd)\"\nDATA_DIR=\"${ROHAN_DATA_DIR:-${SCRIPT_DIR}/data}\"\n\nif [[ ! -d \"$DATA_DIR\" ]]; then\n    echo \"エラー: データディレクトリが見つかりません: $DATA_DIR\"\n    exit 1\nfi\n\necho \"データディレクトリ: $DATA_DIR\"\n\nTOTAL_FILES=0\nTOTAL_SIZE=0\n\ncleanup_dir() {\n    local dir=\"$1\"\n    local days=\"$2\"\n    local full_path=\"$DATA_DIR/$dir\"\n    \n    if [[ ! -d \"$full_path\" ]]; then\n        return\n    fi\n    \n    # macOS: stat -f%z でファイルサイズ取得\n    local files\n    files=$(find \"$full_path\" -type f -mtime +\"$days\" 2>/dev/null || true)\n    \n    if [[ -z \"$files\" ]]; then\n        echo \"  $dir: 削除対象なし\"\n        return\n    fi\n    \n    local count=0\n    local size=0\n    while IFS= read -r file; do\n        count=$((count + 1))\n        local fsize\n        fsize=$(stat -f%z \"$file\" 2>/dev/null || echo 0)\n        size=$((size + fsize))\n        if $DRY_RUN; then\n            echo \"  [DRY] $file ($fsize bytes)\"\n        else\n            rm -f \"$file\"\n        fi\n    done <<< \"$files\"\n    \n    TOTAL_FILES=$((TOTAL_FILES + count))\n    TOTAL_SIZE=$((TOTAL_SIZE + size))\n    \n    echo \"  $dir: ${count}ファイル ($(human_size $size))\"\n    \n    # 空ディレクトリ除去\n    if ! $DRY_RUN; then\n        find \"$full_path\" -type d -empty -delete 2>/dev/null || true\n    fi\n}\n\nhuman_size() {\n    local bytes=$1\n    if [[ $bytes -ge 1073741824 ]]; then\n        echo \"$(( bytes / 1073741824 ))GB\"\n    elif [[ $bytes -ge 1048576 ]]; then\n        echo \"$(( bytes / 1048576 ))MB\"\n    elif [[ $bytes -ge 1024 ]]; then\n        echo \"$(( bytes / 1024 ))KB\"\n    else\n        echo \"${bytes}B\"\n    fi\n}\n\necho \"\"\necho \"=== データクリーンアップ開始 ===\"\necho \"\"\n\ncleanup_dir \"playwright_recordings\" 3\ncleanup_dir \"check_screenshots\" 3\ncleanup_dir \"screenshots\" 3\ncleanup_dir \"manuscript_logs\" 7\ncleanup_dir \"sessions\" 30\ncleanup_dir \"csv_downloads\" 7\ncleanup_dir \"auth_states\" 7\ncleanup_dir \"payment_logs\" 30\ncleanup_dir \"process_states\" 7\n\necho \"\"\necho \"=== サマリー ===\"\necho \"削除ファイル数: $TOTAL_FILES\"\necho \"解放容量: $(human_size $TOTAL_SIZE)\"\nif $DRY_RUN; then\n    echo \"[DRY RUN] 実際の削除は行われていません\"\nfi\n```\n\n作成後に `chmod +x cleanup_old_data.sh` を実行してください。\n\n完了したらタスクID #2 を completed にマークしてください。",
      "color": "green",
      "planModeRequired": false,
      "joinedAt": 1770646553600,
      "tmuxPaneId": "in-process",
      "cwd": "/Users/masaaki/Desktop/prm/rohan",
      "subscriptions": [],
      "backendType": "in-process"
    },
    {
      "agentId": "jpeg-browser-worker@data-cleanup",
      "name": "jpeg-browser-worker",
      "agentType": "general-purpose",
      "model": "sonnet",
      "prompt": "あなたのタスク: `/Users/masaaki/Desktop/prm/rohan/backend/browser_automation.py` の全スクリーンショット箇所を PNG → JPEG に変更してください。\n\n**重要**: プラン外の変更は一切禁止。スクリーンショット関連の変更のみ行うこと。他のロジック変更は禁止。\n\n変更ルール:\n1. `.png` → `.jpg` にファイル拡張子を変更\n2. `page.screenshot(...)` の呼び出しに `type='jpeg', quality=60` パラメータを追加\n3. **既存のパラメータ（path=, full_page= など）は一切変更しない**\n\n作業手順:\n1. まず `browser_automation.py` を読み込んで全ての `.screenshot(` と `.png` 箇所を特定\n2. 以下のパターンを検索して全箇所を変更:\n   - `page.screenshot(path=...)` → `page.screenshot(path=..., type='jpeg', quality=60)`\n   - ファイル名の `.png` → `.jpg`\n3. 変更後、全箇所が正しく変更されたか grep で確認\n\n注意点:\n- `f\"...{xxx}.png\"` のようなf-string内の `.png` も `.jpg` に変更\n- `screenshot` メソッドの引数で `type=` が既にある箇所は上書き\n- `full_page=True` などの既存引数はそのまま維持\n\n完了したらタスクID #3 を completed にマークしてください。",
      "color": "yellow",
      "planModeRequired": false,
      "joinedAt": 1770646565206,
      "tmuxPaneId": "in-process",
      "cwd": "/Users/masaaki/Desktop/prm/rohan",
      "subscriptions": [],
      "backendType": "in-process"
    },
    {
      "agentId": "jpeg-check-worker@data-cleanup",
      "name": "jpeg-check-worker",
      "agentType": "general-purpose",
      "model": "sonnet",
      "prompt": "あなたのタスク: `/Users/masaaki/Desktop/prm/rohan/backend/check_playwright.py` の全スクリーンショット箇所を PNG → JPEG に変更してください。\n\n**重要**: プラン外の変更は一切禁止。スクリーンショット関連の変更のみ行うこと。他のロジック変更は禁止。\n\n変更ルール:\n1. `.png` → `.jpg` にファイル拡張子を変更\n2. `page.screenshot(...)` の呼び出しに `type='jpeg', quality=60` パラメータを追加\n3. **既存のパラメータ（path=, full_page= など）は一切変更しない**\n\n作業手順:\n1. まず `check_playwright.py` を読み込んで全ての `.screenshot(` と `.png` 箇所を特定\n2. 変更後、全箇所が正しく変更されたか grep で確認\n\n完了したらタスクID #4 を completed にマークしてください。",
      "color": "purple",
      "planModeRequired": false,
      "joinedAt": 1770646570885,
      "tmuxPaneId": "in-process",
      "cwd": "/Users/masaaki/Desktop/prm/rohan",
      "subscriptions": [],
      "backendType": "in-process"
    },
    {
      "agentId": "data-dir-worker@data-cleanup",
      "name": "data-dir-worker",
      "agentType": "general-purpose",
      "model": "sonnet",
      "prompt": "あなたのタスク: `ROHAN_DATA_DIR` 環境変数によるデータディレクトリのオーバーライドを実装してください。\n\n**重要**: プラン外の変更は一切禁止。指定されたファイルの指定箇所のみ変更すること。\n\n## タスク1: path_constants.py の修正\n\nファイル: `/Users/masaaki/Desktop/prm/rohan/backend/path_constants.py`\n\n`get_data_dir` 関数を探して、環境変数 `ROHAN_DATA_DIR` のオーバーライドを追加してください。\n\n修正内容:\n- 関数の冒頭に `os.environ.get(\"ROHAN_DATA_DIR\")` のチェックを追加\n- 環境変数が設定されている場合、そのパスを使用（`mkdir(parents=True, exist_ok=True)` 付き）\n- Docker パスのフォールバックは既存のまま維持\n- `import os` が既にあるか確認し、なければ追加\n\n## タスク2: browser_automation.py の RECORDING_DIR 修正\n\nファイル: `/Users/masaaki/Desktop/prm/rohan/backend/browser_automation.py`\n\n`RECORDING_DIR` がモジュールレベルでハードコードされている場合、遅延初期化に変更してください。\n\n方法:\n1. 現在の `RECORDING_DIR = Path(...)` 定義を探す\n2. 関数 `_get_recording_dir()` を作成して、`ROHAN_DATA_DIR` 環境変数対応 + フォールバックを実装\n3. `RECORDING_DIR` の使用箇所を `_get_recording_dir()` 呼び出しに変更、**または** モジュールレベルの定義を環境変数対応に変更\n\n## タスク3: migrate_data_dir.sh 作成\n\nファイル: `/Users/masaaki/Desktop/prm/rohan/migrate_data_dir.sh`\n\n以下のスクリプトを作成:\n```bash\n#!/bin/bash\n# migrate_data_dir.sh - data/ 内のランタイムファイルを ../rohan-data/ に移動\nset -euo pipefail\n\nSCRIPT_DIR=\"$(cd \"$(dirname \"$0\")\" && pwd)\"\nSRC_DIR=\"$SCRIPT_DIR/data\"\nDEST_DIR=\"${1:-$SCRIPT_DIR/../rohan-data}\"\n\necho \"移動元: $SRC_DIR\"\necho \"移動先: $DEST_DIR\"\n\n# 移動対象ディレクトリ（ランタイムデータのみ）\nRUNTIME_DIRS=(\n    \"playwright_recordings\"\n    \"check_screenshots\"\n    \"screenshots\"\n    \"manuscript_logs\"\n    \"sessions\"\n    \"csv_downloads\"\n    \"auth_states\"\n    \"payment_logs\"\n    \"process_states\"\n    \"check_sessions\"\n    \"manuscript\"\n)\n\n# git-tracked files は data/ に残す\n# data/*.md, data/*.xlsx は移動しない\n\nmkdir -p \"$DEST_DIR\"\n\nfor dir in \"${RUNTIME_DIRS[@]}\"; do\n    if [[ -d \"$SRC_DIR/$dir\" ]]; then\n        echo \"移動中: $dir/\"\n        mkdir -p \"$DEST_DIR/$dir\"\n        if [[ -n \"$(ls -A \"$SRC_DIR/$dir\" 2>/dev/null)\" ]]; then\n            cp -r \"$SRC_DIR/$dir/\"* \"$DEST_DIR/$dir/\" 2>/dev/null || true\n            rm -rf \"$SRC_DIR/$dir\"\n        fi\n        echo \"  完了\"\n    fi\ndone\n\n# prompt_history.json も移動\nif [[ -f \"$SRC_DIR/prompt_history.json\" ]]; then\n    echo \"移動中: prompt_history.json\"\n    mv \"$SRC_DIR/prompt_history.json\" \"$DEST_DIR/\"\nfi\n\necho \"\"\necho \"=== 移動完了 ===\"\necho \"以下を .env に追加してください:\"\necho \"  ROHAN_DATA_DIR=$DEST_DIR\"\necho \"\"\necho \"または環境変数として設定:\"\necho \"  export ROHAN_DATA_DIR=$DEST_DIR\"\n```\n\n`chmod +x` で実行権限を付与してください。\n\n## タスク4: .env ファイルの確認・更新\n\nファイル: `/Users/masaaki/Desktop/prm/rohan/.env`\n\n`.env` ファイルが存在するか確認し、`ROHAN_DATA_DIR` の行がなければ追加:\n```\nROHAN_DATA_DIR=/Users/masaaki/Desktop/prm/rohan-data\n```\n\n既に `.env` ファイルが存在する場合は末尾に追記。存在しない場合は新規作成。\n\n完了したらタスクID #5 を completed にマークしてください。",
      "color": "orange",
      "planModeRequired": false,
      "joinedAt": 1770646592734,
      "tmuxPaneId": "in-process",
      "cwd": "/Users/masaaki/Desktop/prm/rohan",
      "subscriptions": [],
      "backendType": "in-process"
    }
  ]
}