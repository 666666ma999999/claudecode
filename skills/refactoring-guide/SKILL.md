---
name: refactoring-guide
description: |
  リファクタリングの戦略ガイド。参考コード方式、神クラス隔離、コンテキスト分割の手法を提供。
  大規模リファクタリング時に使用。
  キーワード: リファクタリング, 神クラス, コード分割, 参考コード方式, 横展開
---

# Refactoring Guide - リファクタリング戦略

## 基本原則

- 動作するコードを壊さない
- 各段階でテストが通ることを確認
- 一度に大きな変更をしない

## 参考コード方式

**1箇所で理想的な実装を完成させ、それを基準に横展開する。**

### 手順

1. **参考実装の選定**: 最も代表的・シンプルなケースを1つ選ぶ
2. **理想形の実装**: その1箇所で完璧な実装を完成させる
3. **テスト確認**: 参考実装のテストが全て通ることを確認
4. **パターン抽出**: 参考実装から横展開可能なパターンを抽出
5. **横展開**: 他の箇所に同じパターンを適用
6. **各段階で検証**: 横展開の各段階でテストが通ることを確認

### メリット

- 試行錯誤を1箇所に集約できる
- 横展開時は機械的な作業になる
- レビューが容易（参考実装を基準に差分確認）

### 適用場面

- 同じパターンが複数箇所に存在する場合
- APIエンドポイントの統一リファクタリング
- コンポーネントの標準化

## 神クラス隔離

**最初に分解しない。まず隔離してから段階的に分解する。**

### 手順

1. **分解しない**: 神クラスをいきなり分解しようとしない
2. **隔離**: 神クラスへの新規依存を禁止し、ラッパー/ファサードで隔離
3. **UI層優先**: まずUI層（View/Controller）から神クラスへの直接参照を排除
4. **インターフェース抽出**: 神クラスの責務ごとにインターフェースを定義
5. **段階的分解**: インターフェースの実装を個別クラスに移行

### 判断基準

| 状況 | アプローチ |
|------|-----------|
| クラスが500行未満 | 直接リファクタリングで可 |
| クラスが500-1000行 | 隔離 → UI層から分離 → 分解 |
| クラスが1000行超 | 隔離 → ファサード → 段階的分解（複数PR） |
| 外部依存が多い | まず依存注入を導入 → 隔離 → 分解 |

### アンチパターン

- 神クラスを一気に10個のクラスに分解しようとする
- テストなしでリファクタリングを開始する
- 機能追加とリファクタリングを同時に行う

## コンテキスト分割

**機能単位で段階的に分割。中間TODO許容。各段階でテスト通過を確認。**

### 手順

1. **機能の境界特定**: モジュール/クラスの責務を分析し、機能の境界を特定
2. **依存関係マップ**: 機能間の依存関係を可視化
3. **分割順序決定**: 依存が少ない（葉に近い）機能から分割
4. **中間TODO許容**: 完全な分割が一度にできない場合、TODOコメントで明示
5. **段階的移行**: 1機能ずつ分割し、各段階でテスト通過を確認

### 中間TODOの書き方

```python
# TODO(refactoring): この関数はUserServiceに移動予定
# 移動先: src/services/user_service.py
# 依存解決後に移動: OrderService.get_user_orders() の分離が先
def get_user_data(user_id):
    ...
```

### 分割の優先順位

1. **ユーティリティ関数**: 副作用なし、テスト容易
2. **データアクセス層**: DB操作の集約
3. **ビジネスロジック**: コアロジックの分離
4. **UI/プレゼンテーション層**: 表示ロジックの分離
5. **オーケストレーション層**: ワークフローの調整

## リファクタリングチェックリスト

着手前:
- [ ] 既存テストが全て通ることを確認
- [ ] リファクタリングの目的を明確化（パフォーマンス？可読性？保守性？）
- [ ] 影響範囲を特定
- [ ] ロールバック計画を用意

実施中:
- [ ] 機能追加とリファクタリングを混ぜていない
- [ ] 各ステップでテストが通る
- [ ] コミットが論理的な単位で分かれている

完了後:
- [ ] 全テストが通る
- [ ] パフォーマンスが劣化していない
- [ ] 可読性が向上している
- [ ] 中間TODOが残っている場合、Issue/タスクとして管理されている
