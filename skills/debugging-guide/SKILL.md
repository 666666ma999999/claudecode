---
name: debugging-guide
description: |
  デバッグの体系的アプローチガイド。根本原因分析の4段階手法、3-Fix Limitルール、赤フラグ条件を提供。
  テスト失敗やバグ修正時に使用。
  キーワード: デバッグ, 根本原因分析, バグ修正, 3-Fix Limit, 赤フラグ, トラブルシューティング
---

# Debugging Guide - デバッグの体系的アプローチ

## 基本原則

**根本原因を特定するまで修正に着手しない。症状への対症療法は失敗である。**

## 3-Fix Limitルール

同一問題に対して3回修正を試みて解決しない場合:

1. **即座に修正作業を停止**
2. エラー報告フォーマット（`~/.claude/rules/core-workflow.md` セクション2参照）でユーザーに報告
3. 以下を含める:
   - 試した3つの修正とその結果
   - 現在の仮説とその限界
   - アーキテクチャ見直しの要否
4. ユーザーの判断を待つ（自動リトライ禁止）

## 赤フラグ条件（Phase 1に戻ること）

以下の兆候が見られたら、修正を中断してPhase 1（根本原因の調査）からやり直す:

- 「とりあえず今はこれで」という判断をしようとしている
- 「Xを変えてみよう」（データフロー追跡なし）
- データフローを追跡する前に解決策を提案している
- 2回の修正失敗後にさらに修正を試みている

## 4段階根本原因分析

### Phase 1: 根本原因の調査

1. **エラーメッセージ完全読解**: エラーメッセージを一字一句読む。省略しない
2. **再現手順確立**: 100%再現できる最小手順を特定
3. **git log/diff確認**: 最近の変更が原因でないか確認
4. **コールスタック逆追跡**: エラー発生箇所から呼び出し元を遡る

```
確認順序:
エラーメッセージ → スタックトレース → 該当コード → 呼び出し元 → データの流れ → 変更履歴
```

### Phase 2: パターン分析

- **正常な類似コードとの差分**: 同じパターンで動作している箇所を特定
- **差分リスト化**: 正常コードと問題コードの違いを全て列挙
- **環境差分**: ローカル/ステージング/本番での挙動差異を確認

```
比較ポイント:
1. 入力データの型・値の範囲
2. 設定値・環境変数
3. 依存ライブラリのバージョン
4. 実行順序・タイミング
5. 権限・認証状態
```

### Phase 3: 仮説と検証

- **一度に一つの変数のみ変更**: 複数の変更を同時に行わない
- **仮説を明文化**: 「Xが原因で、Yが起きている」を明確に記述
- **検証方法を事前に決定**: 仮説が正しい場合と間違っている場合の期待結果を定義

```
テンプレート:
仮説: [原因] が [条件] のとき [症状] を引き起こす
検証: [操作] を行い [期待結果] を確認する
正の場合: [次のアクション]
負の場合: [別の仮説へ]
```

### Phase 4: 実装

1. **失敗するテスト作成**: バグを再現するテストを先に書く
2. **単一の修正**: 一つの変更のみでテストを通す
3. **リグレッション確認**: 既存テストが全て通ることを確認
4. **レビュー**: 修正が根本原因に対処しているか再確認

## デバッグチェックリスト

修正に入る前に以下を全て確認:

- [ ] エラーメッセージを完全に読んだ
- [ ] 再現手順を確立した
- [ ] コールスタックを追跡した
- [ ] データフローを特定した（入力 → 変換 → 出力）
- [ ] 正常な類似コードと比較した
- [ ] 根本原因の仮説を明文化した
- [ ] 仮説の検証方法を決定した

## よくある落とし穴

| パターン | 問題 | 正しいアプローチ |
|---------|------|-----------------|
| エラーメッセージの一部だけ読む | 重要な情報を見逃す | 全文を読み、各部分の意味を理解 |
| 「前回うまくいった修正」を適用 | 異なる根本原因の可能性 | 毎回Phase 1から実施 |
| 複数の修正を同時に適用 | どの修正が効いたか不明 | 一度に一つだけ変更 |
| ログ出力を追加して様子を見る | データフロー追跡の代替にならない | コードを読んでフローを追跡 |
| Stackoverflowの解答をそのまま適用 | コンテキストが異なる | 自分のコードでの原因を理解してから適用 |
