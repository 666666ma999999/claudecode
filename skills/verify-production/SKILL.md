# verify-production

name: 本番チェックフロー確認
description: STEP 1-8で登録した情報が本番サイトに正しく反映されているか確認する。Playwright MCPまたはブラウザ自動化で19項目を自動チェック。

## 発動条件

以下のキーワードで発動：
- 「本番チェック」「本番確認」「反映確認」
- 「チェックフロー」「verify」
- 「STEP完了後の確認」
- 「PPV登録確認」

## 概要

MB従量登録（STEP 1-8）完了後に、本番サイトで以下を確認：
- 従量メニューが正しく表示されるか
- 小見出し・価格・ガイド文が正しいか
- エラーがないか
- 新着枠に表示されるか

## 使用ツール

### Web UI
```
http://localhost:5558/check.html?ppv_id={PPV_ID}
```

### 変数トレーサビリティ（Detection System）
```
http://localhost:5558/detect.html?ppv_id={PPV_ID}
```
STEP 1-8の変数がどのチェック項目に流れるかを可視化する補完ツール。
check.htmlが「本番の正しさ」を確認するのに対し、detect.htmlは「変数の流れ」を追跡する。

### Playwright MCP（手動実行時）
```
browser_navigate → browser_snapshot → 内容確認
```

## チェック項目（全19項目）

### ■ログイン（2項目）
| # | 項目 | URL | 自動 |
|---|------|-----|------|
| 1 | サイトアクセス | https://izumo.uranow.jp/sp/ | ○ |
| 2 | キャリアログイン | career_login.html | △ |

### ■従量結果（6項目）
| # | 項目 | 確認内容 | 自動 |
|---|------|---------|------|
| 3 | URLアクセス | ppv.do?id=ppvXXX&mode=confirm | ○ |
| 4 | 一人用/二人用 | personType表示 | ○ |
| 5 | アイコン | 画像表示 | ○ |
| 6 | 価格 | 登録価格と一致 | ○ |
| 7 | ガイド文 | テキスト存在 | ○ |
| 8 | 小見出し | 登録小見出しと一致 | ○ |

### ■一部無料結果（3項目）
| # | 項目 | 確認内容 | 自動 |
|---|------|---------|------|
| 9 | 小見出し表示 | 全件表示 | ○ |
| 10 | 原稿なし非表示 | 「原稿がありません」がない | ○ |
| 11 | エラー非表示 | エラー文言がない | ○ |

### ■鑑定結果（5項目）
| # | 項目 | 確認内容 | 自動 |
|---|------|---------|------|
| 12 | 課金額 | WebMoney画面 | △（手動推奨） |
| 13 | 小見出し表示 | 全件表示 | ○ |
| 14 | 原稿なし非表示 | 「原稿がありません」がない | ○ |
| 15 | エラー非表示 | エラー文言がない | ○ |
| 16 | 誘導従量 | 誘導PPV表示 | ○ |

### ■新着枠（1項目）
| # | 項目 | 確認内容 | 自動 |
|---|------|---------|------|
| 17 | 新着メニュー | ?ymd=YYYYMMDDで表示 | ○ |

### ■アクセス解析（2項目）
| # | 項目 | 確認内容 | 自動 |
|---|------|---------|------|
| 18 | 購入カウント | MKB解析画面 | △（VPN必要） |
| 19 | メニュー情報 | 名前・価格表示 | △（VPN必要） |

## 信頼度判定

| レベル | 意味 | 自動判定条件 |
|--------|------|-------------|
| 5 | 完全確認 | 全要素が期待値と一致 |
| 4 | ほぼ確認 | 主要要素一致、軽微差異 |
| 3 | 要目視 | 一部不一致 |
| 2 | 問題可能性 | 複数不一致 |
| 1 | 要調査 | 要素未検出/エラー |

## 実行手順

### 方法1: Web UI（推奨）

1. check.html を開く
   ```
   http://localhost:5558/check.html?ppv_id={PPV_ID}
   ```

2. PPV ID入力 → 「登録データ読込」

3. 「全項目一括チェック」または個別「自動確認」

4. 結果確認 → 「チェック結果を保存」

5. 必要に応じて「Excelエクスポート」

### 方法2: Playwright MCP（手動）

1. ブラウザを起動
   ```
   browser_navigate url="https://izumo.uranow.jp/sp/"
   ```

2. 各URLにアクセスしてスナップショット
   ```
   browser_navigate url="https://izumo.uranow.jp/sp/ppv.do/?id=ppv{PPV_ID}&mode=confirm"
   browser_snapshot
   ```

3. 内容を目視確認

## 関連ファイル

| ファイル | 場所 |
|---------|------|
| check.html | rohan/frontend/check.html |
| check.py | rohan/backend/routers/check.py |
| check_playwright.py | rohan/backend/routers/check_playwright.py |
| ステートマシン図 | chk/check_state_machine_viewer.html |

## 注意事項

- **VPN必須**: アクセス解析（#18, #19）はVPN接続が必要
- **課金確認**: WebMoney課金（#12）は手動確認推奨
- **ログイン**: キャリア認証が必要な項目は手動確認
- **二人用**: 相手情報登録済みでないと鑑定不可

## komi_type 命名変換マッピング

rohan登録時のkomi_typeとizumo本番サイトのCSSクラス名には表記の揺れがある。

| rohan登録値 | izumo web CSS class | h3 class | 変換ルール |
|------------|-------------------|----------|-----------|
| komi_normal | komi_normal | tit_komi_normal | 完全一致 |
| komi_jyuyou1 | komi_juyo | tit_komi_juyo | 末尾`1`削除 + `jyuyou`→`juyo` |
| komi_ura1 | komi_ura | *(特殊レイアウト)* | 末尾`1`削除 |

### komi_ura 特殊レイアウト
- h3は装飾ヘッダー「出雲の母には隠せない！あの人の裏本音」+画像
- 実際の小見出しテキストはh4で表示（h3ではない）
- ●●●プレースホルダーがリスト項目として表示

### Phase 3 拡張チェック手順（一部無料ページ）
1. PPVページ → 「一部無料で読む」クリック → 中間ページでタイトル・アイコン一致確認
2. 「一部無料鑑定を開始」クリック → 無料結果ページでタイトル・アイコン一致確認
3. 各小見出しセクションのCSSクラスがrohan登録komi_typeと一致するか確認（上記変換ルール適用）
4. 小見出しテキストが登録データと一致するか確認

## トラブルシューティング

| 問題 | 対処 |
|------|------|
| ページ読込タイムアウト | 再実行、ネットワーク確認 |
| 要素が見つからない | セレクタ確認、ページ構造変更チェック |
| 信頼度が低い | スクリーンショットで目視確認 |
| VPNエラー | VPN接続確認後に再実行 |
