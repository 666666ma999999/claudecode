# 実行ガード

## 1. ブロッカープロトコル

タスク実行中に以下が発生した場合、**即座に停止してユーザーに確認**:

| ブロッカー | 対応 |
|-----------|------|
| プランの指示が不明確 | 停止 → 具体的な質問を提示 → 回答を待つ |
| テスト/検証が失敗 | 停止 → 4段階根本原因分析に従い調査 → 報告 |
| プラン外の変更が必要と判明 | 停止 → 追加変更の範囲を提示 → 承認を待つ |
| 想定外の依存関係を発見 | 停止 → 影響範囲を報告 → 判断を待つ |

**禁止**: ブロッカーを推測で回避、「おそらくこうだろう」で判断して修正

## 2. バッチ実行方式

タスクを3つずつバッチ化し、バッチごとに検証ポイントを設ける:
- バッチ実行 → 検証 → ユーザーへ中間報告 → 承認後に次バッチ
- 単純な変更: 最大5タスク/バッチまで拡大可
- リスクの高い変更: 1タスク/バッチに縮小

## 3. SubAgent委託テンプレート

SubAgentにタスク委託時、以下を全て提供すること:
```
1. Goal: このタスクで達成すべきこと
2. Context: 関連ファイルパス・関数名・データフロー
3. Spec: 入出力の仕様（型・値の範囲・エッジケース）
4. Constraints: 既存コードとの整合性要件
5. Verification: テストコマンドと期待結果
```
**必要な情報が全て委託内容に含まれている**状態が理想。

## 4. デバッグ鉄則

**根本原因を特定するまで修正に着手しない。症状への対症療法は失敗である。**

### 3-Fix Limitルール

同一問題に対して3回修正を試みて解決しない場合:
1. **即座に修正作業を停止**
2. エラー報告フォーマット（core-workflow.md参照）でユーザーに報告
3. 以下を含める: 試した3つの修正とその結果、現在の仮説とその限界、アーキテクチャ見直しの要否
4. ユーザーの判断を待つ（自動リトライ禁止）

### 赤フラッグ条件（Phase 1に戻ること）

- 「とりあえず今はこれで」
- 「Xを変えてみよう」（データフロー追跡なし）
- データフローを追跡する前に解決策を提案している
- 2回の修正失敗後にさらに修正を試みている

### 4段階根本原因分析（詳細はdebugging-guideスキル参照）

Phase 1: 根本原因の調査（エラーメッセージ完全読解→再現手順確立→git log/diff→コールスタック逆追跡）
Phase 2: パターン分析（正常な類似コードとの差分リスト化）
Phase 3: 仮説と検証（一度に一つの変数のみ変更）
Phase 4: 実装（失敗するテスト作成→単一の修正）

## 5. リファクタリング戦略（概要）

- **参考コード方式**: 1箇所で理想的な実装を完成させ、それを基準に横展開。詳細はrefactoring-guideスキル参照
- **神クラス隔離**: 最初に分解しない → 隔離 → UI層優先 → 分解
- **コンテキスト分割**: 機能単位で段階的に、中間TODO許容、各段階でテスト通過を確認

## 6. プラン作成基準

Plan SubAgentが作成するプランには以下を含める:
- Goal（1-2文）、Architecture（モジュール構成図）、Tech Stack、Tasks、Verification
- タスク粒度: 2-5分、原則1ファイル、1つの論理的変更
- 各タスクに推奨: 対象ファイルのフルパス、変更する関数名、実行可能なコード、検証コマンドと期待出力
