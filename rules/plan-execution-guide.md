# プラン作成・実行ガイド（推奨プラクティス）

> 棲み分け: `task-planner`スキルはtask.mdへの出力ツール、本ドキュメントはプランの品質基準と実行ルールを定義する。
> `task-management.md`はセッション間の引継ぎシステム、本ドキュメントはプラン内部の構造基準を定義する。

## Part 1: プラン作成基準

### プラン必須セクション

Plan SubAgent（CLAUDE.md Step 3）が作成するプランには、以下のセクションを含めること:

```
## Goal
[1-2文で達成目標を明記]

## Architecture
[変更対象のモジュール構成図・データフロー]

## Tech Stack
[使用する言語・フレームワーク・ライブラリ]

## Tasks
[タスク一覧（下記の粒度ルールに従う）]

## Verification
[全体の検証方法]
```

### タスク粒度ルール

各タスクは以下の基準で分解する:

| 基準 | 値 |
|------|-----|
| 目安作業時間 | 2-5分 |
| ファイル数 | 原則1ファイル |
| 変更箇所 | 1つの論理的変更 |

### タスク記述の完全性要件（推奨）

各タスクには以下を含めることを推奨:
- **対象ファイルのフルパス**
- **変更する関数名・セクション名**
- **実行可能なコード**（擬似コードではなく実際のコード）
- **検証コマンド**と**期待される出力**

```markdown
# 例: 良いタスク記述
- T3: `backend/routers/users.py` の `get_user()` にキャッシュ追加
  - 変更: functools.lru_cacheデコレータを追加
  - コード: `@lru_cache(maxsize=128)`
  - 検証: `pytest tests/test_users.py::test_get_user_cached -v`
  - 期待: PASSED（2回目の呼び出しがDB不要）

# 例: 避けるべきタスク記述
- T3: ユーザー取得にキャッシュを追加する
```

## Part 2: プラン実行ルール

### バッチ実行方式（推奨）

タスクを3つずつバッチ化し、バッチごとに検証ポイントを設ける:

```
[バッチ1: T1-T3]
  → 実行
  → 検証（テスト実行・動作確認）
  → ユーザーへ中間報告
  → 承認後、次バッチへ

[バッチ2: T4-T6]
  → 実行
  → 検証
  → ユーザーへ中間報告
  → 承認後、次バッチへ

...繰り返し...
```

**バッチサイズの調整**:
- 単純な変更が続く場合: 最大5タスク/バッチまで拡大可
- リスクの高い変更: 1タスク/バッチに縮小

### ブロッカープロトコル

タスク実行中に以下の状況が発生した場合、**即座に停止してユーザーに確認する**:

| ブロッカー | 対応 |
|-----------|------|
| プランの指示が不明確 | 停止 → 具体的な質問を提示 → 回答を待つ |
| テスト/検証が失敗 | 停止 → debugging-strategy.mdに従い調査 → 報告 |
| プラン外の変更が必要と判明 | 停止 → 追加変更の範囲を提示 → 承認を待つ |
| 想定外の依存関係を発見 | 停止 → 影響範囲を報告 → 判断を待つ |

**禁止事項**:
- ブロッカーを推測で回避して進行すること
- 「おそらくこうだろう」で判断して修正すること

### SubAgent実行時の完全仕様提供（推奨）

SubAgentにタスクを委託する際、以下の情報を全て提供すること:

```
委託テンプレート:
1. Goal: このタスクで達成すべきこと
2. Context: 関連するファイルパス・関数名・データフロー
3. Spec: 入出力の仕様（型・値の範囲・エッジケース）
4. Constraints: 既存コードとの整合性要件
5. Verification: テストコマンドと期待結果
```

SubAgentが「ファイルを読んで理解して」ではなく、**必要な情報が全て委託内容に含まれている**状態が理想。

## 既存ルールとの連携

| プロセス | 参照先 |
|---------|-------|
| プラン作成ツール | `task-planner`スキル |
| ワークフロー全体 | CLAUDE.md 標準ワークフロー |
| セッション引継ぎ | task-management.md |
| 完了チェック | completion-check.md |
| チーム編成判断 | agent-teams.md |
