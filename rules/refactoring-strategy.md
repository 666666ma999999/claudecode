# リファクタリング戦略ガイド

## 1. 参考コード方式（Reference Code Pattern）

大規模リファクタリングでは、まず1箇所で理想的な実装を完成させ、それを基準に横展開する。

### 手順
1. **Explore SubAgent**で既存コードから最も良い実装パターンを特定
2. その1箇所を理想形にリファクタリング（テスト含む）
3. 完成した実装を「参考コード」として、他の箇所を横展開

### 横展開の指示テンプレート
```
「{参考ファイル}の実装パターンを参考に、{対象ファイル}をリファクタリングして」
```

## 2. 事前分析フェーズ（必須）

リファクタリング開始前に以下の分析を実施し、マークダウンで出力すること。

| 分析項目 | 内容 |
|---------|------|
| 行数・複雑度 | 対象ファイル群の行数、関数数、ネスト深度 |
| 依存関係 | 機能間・ファイル間の依存グラフ |
| 影響範囲 | 変更が波及するファイル・機能の一覧 |
| 優先順位 | 複雑度 × 影響範囲 で決定 |

優先順位が高いもの = 複雑度が高く、多くの箇所に影響するコード。ただし神クラスは例外（後述）。

## 3. 神クラス隔離戦略

巨大なクラス（God Class）は**最初に分解しない**。

### 手順
1. **隔離**: 適切な層（Repository、Service等）にロジックを移動
2. **UI層優先**: 画面・コントローラ層のリファクタリングを先に完了
3. **分解**: UI層が安定してから神クラスを段階的に分解

### 理由
- 神クラスを先に分解すると、依存する全箇所が壊れる
- UI層を先に整理することで、神クラスの責務が明確になる

## 4. コンテキスト分割ルール

大型ファイルのリファクタリングは一度に行わない。

### ルール
- **機能単位**で段階的にリファクタリング
- 中間状態での**TODOコメント残留を許容**（`// TODO: Phase2でリファクタリング`）
- 各段階でテストが通ることを確認してからコミット
- コンテキストウィンドウを超える変更は必ず分割

## 5. レガシーパターン検出

Codexレビュー（completion-check.md STEP 2）で以下を追加チェック:

### チェック項目
- 非推奨API・ライブラリの使用
- 古いデザインパターン（Singleton乱用、God Object等）
- コールバック地獄（async/awaitへの移行漏れ）
- 手動リソース管理（コンテキストマネージャ未使用）
- ハードコードされた設定値（定数化・外部設定化漏れ）

### 検出時の対応
- 今回の変更範囲内 → 即修正
- 変更範囲外 → TODOコメント + Issue化を提案
