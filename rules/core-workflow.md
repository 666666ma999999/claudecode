# コアワークフロー

## 1. 事実確認ルール（最優先）

現状の事実に関する質問には**必ずツールで実態を確認してから回答**すること。

**禁止**: 推測・一般論での回答、「通常は〜」という前提、ツール実行なしでの断定
**必須手順**: 1.関連ファイル・設定・状態をツールで確認 → 2.確認結果に基づき回答 → 3.確認不可なら「未確認」と明示

| 質問の種類 | 確認方法 |
|-----------|---------|
| git設定 | `git remote -v`, `git log`, `git status` |
| ファイル存在 | `ls`, `Glob` |
| 設定内容 | `Read`でファイル読み込み |
| プロセス状態 | `ps`, `curl` |
| hook/自動化 | 設定ファイルとスクリプトを`Read` |

## 2. エラー報告フォーマット

エラー発生時は以下の構造で報告：

```
0. Sentry Issue URL（任意・該当時のみ）
1. 症状: エラーメッセージの正確な引用 + スクリーンショット
2. 原因: コードの流れ追跡→根本原因特定（ファイル名:行番号）、データ変遷（入力→変換→出力）
3. 経緯: 過去の変更履歴との関係、スキルドキュメントとの不整合
4. 選択肢: 複数の修正方針（最低2つ）、各トレードオフ、影響範囲
```

## 3. 実装完了チェック（必須・順番に実行）

**コード修正・機能追加が完了したら、完了報告の前に以下を全て実行：**

### STEP 1: サーバー再起動（該当する場合）

backend/main.py・フロントエンド・設定ファイルを編集した場合のみ実行。**確認なしで自動実行**。

```
1. ./stop_servers.sh && ./start_unified_server.sh
2. curl -s -o /dev/null -w "%{http_code}" http://localhost:5558/ で200確認
3. 動作確認
```

**強制ルール**:
- 修正直後の再起動は省略不可。「後でまとめて」は禁止
- ヘルスチェックで200確認前に完了報告禁止
- テスト実行中にエラー → 即停止しブラウザ維持してユーザーに報告（自動修正・自動リトライ禁止）

### STEP 2: Codexレビュー（必須・2段階）

**Stage 1: 仕様準拠レビュー**
- `mcp__codex__codex`で変更が要件・仕様を満たしているかレビュー
- task.mdの成功基準との整合性確認
- 指示に含める: 「変更内容がタスクの要件・成功基準を満たしているか検証せよ。入出力の仕様、エッジケースの処理、期待される動作との乖離を検出せよ。」
- **指摘事項は全て修正してからStage 2へ**

**Stage 2: コード品質レビュー**
- `mcp__codex__codex`でコード品質をレビュー
- **指摘は全て修正**（既存バグも対象外にしない）
- 修正後はSTEP 1に戻る

**パラメータチェーン検証**（パラメータ追加・変更時は必須）:
1. 追加パラメータの定義箇所（関数シグネチャ）を特定
2. 呼び出す全箇所をGrepで検索
3. 各呼び出し箇所でパラメータが実際に渡されているか確認
4. 値の出所（`self.xxx`、引数、定数）が正しいか確認
- Codex指示に含める: 「追加・変更されたパラメータについて、定義→dispatcher→実メソッドの全チェーンで値が正しく伝搬しているか検証せよ。Optionalパラメータでデフォルト値に隠れて未接続になっているケースを重点検出せよ。」

### STEP 2.3: Sentryリグレッションチェック（任意）

Sentry MCP有効時のみ: `list_issues`で新規エラー確認 → 検出時は即修正

### STEP 2.5: テストコード同期確認（該当する場合）

- `check_playwright.py`のセレクタ・待機条件が修正内容と整合しているか確認
- 不整合発見時は即修正

### STEP 3: スキル化判断（必須・毎回実行）

`skill-lifecycle.md`の「スキル化判断フロー」に従って判断・実行。

### STEP 3.5: セッション記録（30分以上の作業完了時）

MEMORY.mdまたは関連ファイルを更新: 変更内容、発見バグと根本原因、未解決課題、次のアクション

### STEP 4: 完了報告

上記を全て実施後にユーザーへ報告。

## 4. タスク管理（task.mdベース）

| コマンド | 用途 | タイミング |
|---------|------|-----------|
| `/launch-task` | 新規タスク開始・task.md生成 | Issue発行後 |
| `/onboard` | 中断した作業の復帰 | セッション開始時 |
| `/update-task` | task.mdの状態更新 | 作業の節目・中断前 |
| `/update-task --checkpoint` | 中断準備（状態保存） | 作業中断時 |
| `/update-task --complete` | タスク完了処理 | 全作業完了時 |
| `/review` | Codexコードレビュー | 実装完了後・commit前 |
| `/verify-step` | STEP完了確認 | 各STEP実行後 |

**ディレクトリ構成**: `project-root/.claude/workspace/task.md`（現在のタスク状態）、`~/.claude/commands/`（コマンド定義）、`~/.claude/templates/task.md`（テンプレート）

**ワークフロー**: 新規→`/launch-task`→Plan→実装 | 中断→`/update-task --checkpoint` | 再開→`/onboard` | 完了→`/update-task --complete`→スキル横展開→Issue Close

**task.md必須セクション**:

| セクション | 用途 |
|-----------|------|
| メタ情報 | Issue、ステータス、日時 |
| 成功基準 | 完了条件のチェックリスト |
| 実装計画 | Phase分割された作業項目 |
| 中断時の状態 | 次のアクション、未解決問題 |
| 学んだこと | 完了時の知見記録 |

## 5. Docker-Only開発ポリシー

**原則**: 依存管理・ビルド・実行はDocker経由。ホスト環境の汚染を防止。

**禁止コマンド（ホスト上）**:

| カテゴリ | 禁止コマンド |
|---------|-------------|
| Python | `pip install`, `pip3 install`, `python -m pip`, `python -m venv`, `virtualenv`, `uv pip/venv`, `poetry install/add`, `conda install/create` |
| Node.js | `npm install`, `npm i`, `npx`, `yarn`, `pnpm`, `bun install/add` |
| 環境有効化 | `source venv/bin/activate`, `. .venv/bin/activate` |

**適用除外**: `.mcp.json`のMCPサーバー設定、Claude Code自体のツール拡張・プラグイン設定

**正しい実行方法**: `docker compose exec dev <コマンド>`
**強制メカニズム**: `permissions.deny`でブロック + `block-host-installs.py`ですり抜け防止

## 6. メモリシステム棲み分け

| システム | 目的 | 記録対象 |
|---|---|---|
| Claude-Mem | 「何をしたか」の活動記録 | ツール使用・セッション活動（自動） |
| Memory MCP | 「何を知っているか」の知識蓄積 | 設計判断・方針・技術知見（意図的に保存） |

**Memory MCP保存トリガー**: ユーザーが「覚えておいて」と明示、新方針決定時、再利用可能な知見発見時
**記録しない**: 一時的作業状態、SKILL.md/rulesに既記載の情報、機密情報
