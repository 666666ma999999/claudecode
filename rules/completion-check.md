# 実装完了時の必須チェック（最優先）

**コード修正・機能追加が完了したら、完了報告の前に以下を順番に実行：**

## STEP 1: サーバー再起動（該当する場合）

backend/main.py・フロントエンドファイル・設定ファイルを編集した場合のみ、`server-restart.md` の手順に従いサーバー再起動・ヘルスチェックを実行すること。

## STEP 2: Codexレビュー（必須・2段階）

### Stage 1: 仕様準拠レビュー

- `mcp__codex__codex`を使用して、変更が要件・仕様を満たしているかレビューする
- task.mdの成功基準との整合性を確認する
- Codexへの指示に以下を含める:
  > 「変更内容がタスクの要件・成功基準を満たしているか検証せよ。入出力の仕様、エッジケースの処理、期待される動作との乖離を検出せよ。」
- **指摘事項は全て修正してからStage 2へ進む**

### Stage 2: コード品質レビュー

- `mcp__codex__codex`を使用してコード品質をレビューする
- `/review`コマンドと同等の処理を自動実行する
- **指摘事項は全て修正してから次へ進む（今回の変更に起因するかどうかを問わない）**
- 「既存バグだから対象外」という判断は禁止。Codexが検出した不具合は全て即時修正する
- 修正後は再度STEP 1（サーバー再起動・ヘルスチェック）に戻る

### パラメータチェーン検証（パラメータ追加・変更時は必須）

関数にパラメータを追加した場合、**呼び出しチェーン全体の接続を検証**すること。

**検証手順:**
1. 追加したパラメータの**定義箇所**（関数シグネチャ）を特定
2. その関数を**呼び出す全箇所**（dispatcher/caller）を`Grep`で検索
3. 各呼び出し箇所で、パラメータが**実際に渡されているか**確認
4. パラメータの**値の出所**（`self.xxx`、引数、定数）が正しいか確認

**典型的な未接続パターン:**
```
A(param=x) → B(param) → C()  ← Cにparamが渡されていない
```

**Codexへの指示に以下を含める:**
> 「追加・変更されたパラメータについて、定義→dispatcher→実メソッドの全チェーンで値が正しく伝搬しているか検証せよ。Optionalパラメータでデフォルト値に隠れて未接続になっているケースを重点検出せよ。」

## STEP 2.3: Sentryリグレッションチェック（任意）

Sentry MCPが有効な場合のみ実行：
- Sentry MCPの `list_issues` で、今回の変更後に新規発生したエラーがないか確認
- 新規エラーが検出された場合 → 即修正してからSTEP 2.5へ進む
- Sentry MCPが無効な場合 → このSTEPをスキップしてSTEP 2.5へ進む

## STEP 2.5: テストコード同期確認（該当する場合）

手動修正・機能変更を行った場合、以下を確認：
- [ ] `check_playwright.py` のセレクタ・待機条件が修正内容と整合しているか
- [ ] 自動テストコードが手動修正を反映しているか
- 不整合を発見した場合は即修正してからSTEP 3に進む

## STEP 3: スキル化判断（必須・毎回実行）

`skills.md` の「スキル化判断フロー」に従って判断・実行すること。

## STEP 3.5: セッション記録（長時間タスク完了時）

30分以上の作業セッション完了時、以下の構造でMEMORY.mdまたは関連ファイルを更新：
- 変更内容（ファイル名・関数名）
- 発見したバグとその根本原因
- 未解決の課題
- 次のアクション

## STEP 4: 完了報告

上記を全て実施後にユーザーへ報告
