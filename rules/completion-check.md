# 実装完了時の必須チェック（最優先）

**コード修正・機能追加が完了したら、完了報告の前に以下を順番に実行：**

## STEP 1: サーバー再起動（該当する場合）

対象ファイルを編集した場合のみ：
- backend/main.py、フロントエンドファイル、設定ファイル

```
1. ./stop_servers.sh → ./start_unified_server.sh
2. curl -s -o /dev/null -w "%{http_code}" http://localhost:5558/ で 200 確認
3. 動作確認
```

## STEP 2: Codexレビュー（必須）

- `mcp__codex__codex`を使用してコード変更をレビューする
- `/review`コマンドと同等の処理を自動実行する
- **指摘事項は全て修正してから次へ進む（今回の変更に起因するかどうかを問わない）**
- 「既存バグだから対象外」という判断は禁止。Codexが検出した不具合は全て即時修正する
- 修正後は再度STEP 1（サーバー再起動・ヘルスチェック）に戻る

### パラメータチェーン検証（パラメータ追加・変更時は必須）

関数にパラメータを追加した場合、**呼び出しチェーン全体の接続を検証**すること。

**検証手順:**
1. 追加したパラメータの**定義箇所**（関数シグネチャ）を特定
2. その関数を**呼び出す全箇所**（dispatcher/caller）を`Grep`で検索
3. 各呼び出し箇所で、パラメータが**実際に渡されているか**確認
4. パラメータの**値の出所**（`self.xxx`、引数、定数）が正しいか確認

**典型的な未接続パターン:**
```
A(param=x) → B(param) → C()  ← Cにparamが渡されていない
```

**Codexへの指示に以下を含める:**
> 「追加・変更されたパラメータについて、定義→dispatcher→実メソッドの全チェーンで値が正しく伝搬しているか検証せよ。Optionalパラメータでデフォルト値に隠れて未接続になっているケースを重点検出せよ。」

## STEP 2.5: テストコード同期確認（該当する場合）

手動修正・機能変更を行った場合、以下を確認：
- [ ] `check_playwright.py` のセレクタ・待機条件が修正内容と整合しているか
- [ ] 自動テストコードが手動修正を反映しているか
- 不整合を発見した場合は即修正してからSTEP 3に進む

## STEP 3: スキル化判断（必須・毎回実行）

`skills.md` の「スキル化判断フロー」に従って判断・実行すること。

## STEP 3.5: セッション記録（長時間タスク完了時）

30分以上の作業セッション完了時、以下の構造でMEMORY.mdまたは関連ファイルを更新：
- 変更内容（ファイル名・関数名）
- 発見したバグとその根本原因
- 未解決の課題
- 次のアクション

## STEP 4: 完了報告

上記を全て実施後にユーザーへ報告

---

## サーバー再起動ルール（詳細）

- **backend/main.py** を編集した場合
- **フロントエンドファイル** を編集した場合
- **設定ファイル** を編集した場合

**必須手順:**
1. 修正完了
2. **即座にサーバー再起動** (`./stop_servers.sh` → `./start_unified_server.sh`)
3. **ヘルスチェック必須**: `curl -s -o /dev/null -w "%{http_code}" http://localhost:5558/` で `200` を確認
4. 動作確認・テスト
5. **スキル化判断**（上記STEP 3を実行）
6. 完了報告

## 例外なく実行すること
- 修正直後の再起動は**省略不可**
- 「後でまとめて再起動」は**禁止**
- **ヘルスチェックで200確認前に完了報告禁止**
- **スキル化判断をスキップしない**
- 修正→再起動→ヘルスチェック→テスト→スキル化判断を**1セット**として扱う
- **サーバー再起動・ヘルスチェックはユーザーへの確認なしで自動実行**すること（再起動の許可を求めない）
- **テスト実行中にエラーが発生した場合は即停止し、ブラウザを維持してユーザーに報告すること**（自動修正・自動リトライ禁止）
