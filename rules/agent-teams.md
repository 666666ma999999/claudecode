# Agent Teams 運用ガイドライン

## SubAgent vs Agent Teams 使い分け基準

| 条件 | SubAgent | Agent Teams |
|------|----------|-------------|
| 結果だけ欲しい（調査→サマリー返却） | **使う** | 不要 |
| ワーカー同士が議論・反証する必要がある | 不可 | **使う** |
| 同じファイルを編集する可能性がある | **使う**（直列で安全） | 危険（競合する） |
| 3つ以上の独立した視点が必要 | 可能だが通信不可 | **使う** |
| トークンコストを抑えたい | **使う** | 高コスト |
| コンテキストウィンドウが逼迫している | SubAgentで分離 | Agent Teamsで完全分離 |

## Agent Teamsを使うべき場面

### 1. 多視点レビュー
```
チームを作成してPR #XXをレビューしてください。
- セキュリティ担当
- パフォーマンス担当
- FE/BE整合性担当
各自レビュー後、発見を統合してください。
```

### 2. 競合仮説デバッグ
```
[症状の説明]
5つのエージェントをスポーンして異なる仮説を調査してください。
互いの理論に反証し合い、合意を形成してください。
```

### 3. クロスレイヤー実装（FE/BE/テスト並列）
```
チームを作成して以下を並列実装してください。
- FE担当: src/frontend/の変更
- BE担当: src/backend/の変更
- テスト担当: tests/の作成
各自が異なるファイルセットを担当。プラン承認を必須にしてください。
```

### 4. 並列調査（Exploreフェーズの強化）
```
チームを作成して以下を並列調査してください。
- コードベース調査: 既存実装パターンの特定
- 業界標準調査: WebSearchで標準的アプローチを調査
- 依存関係分析: 影響範囲と破壊的変更リスクの評価
```

## 使ってはいけない場面

- **順序依存タスク**: STEP 1→8のような直列パイプライン → register-allスキルを使う
- **同一ファイル編集**: 上書き競合が発生する → SubAgentで直列実行
- **単純な1ファイル修正**: オーバーヘッドが利益を超える → 直接実装
- **ルーチン作業**: 定型処理はSubAgentで十分

## 運用ルール

### チーム構成の原則
- **リーダーはデリゲートモードで運用**（Shift+Tabで切り替え）
- リーダーは調整のみ、実装はTeammateに委任
- 各Teammateに**明確なファイル所有権**を割り当て（競合回避）
- Teammateあたり5-6タスクを用意（遊休防止）

### プラン承認フロー
複雑・リスクの高いタスクでは、Teammateにプラン承認を要求する：
```
プラン承認を必須にしてください。
テストカバレッジを含むプランのみ承認してください。
```

### モデル選択
- **調査・レビュー**: Sonnetで十分（コスト効率重視）
- **実装**: タスク複雑度に応じてSonnet/Opusを選択
```
各Teammateにはsonnetを使用してください。
```

### 完了時の手順
1. 全Teammateの完了を確認
2. リーダーが結果を統合
3. 各Teammateをシャットダウン
4. `Clean up the team`でリソース解放
5. completion-check.mdのSTEP 2（Codexレビュー）を実行

### 2段階レビュー構造（推奨）

`completion-check.md` STEP 2の2段階レビュー（Stage 1: 仕様準拠 → Stage 2: コード品質）に従うこと。

Agent Teams使用時のレビュー構成例:
```
チームを作成してPR #XXを実装してください。
- 実装担当: src/の変更
- 仕様レビュー担当: 要件との整合性確認
- 品質レビュー担当: コード品質・テスト確認
レビュー未解決の状態で次タスクに進行しないこと。
```

**レビュー進行ルール**:
- Stage 1を通過してからStage 2に進む
- **レビュー指摘が未解決の状態で次タスクに進行しない**

### SubAgent委託の品質基準（推奨）

SubAgentにタスクを委託する際、以下を遵守することを推奨する:

1. **完全仕様の提供**: SubAgentが追加のファイル読み込みなしでタスクを理解できるよう、必要な情報を全て含める（詳細は`plan-execution-guide.md`参照）
2. **質問への即応**: SubAgentからの質問には作業開始前に回答する
3. **手動修正の禁止**: SubAgentの成果物に問題がある場合、手動で修正せず専用のSubAgentを起動して修正させる（品質追跡のため）

### 注意事項（実験的機能の制限）
- `/resume`でTeammateは復元されない → 再スポーンが必要
- セッションあたり1チームのみ
- ネストされたチーム不可（Teammateが子チームを作れない）
- 分割ペインモードにはtmux or iTerm2が必要（現在はin-processモード）
